<div class="migration-wizard" [class.light-theme]="false">
  <!-- Header -->
  <div class="wizard-header">
    <h1 class="mat-headline-4">Database Migration Wizard</h1>
    <p class="mat-body-1">Migrate your library to support multiple computers via shared NAS storage</p>
  </div>

  <!-- Stepper -->
  <mat-horizontal-stepper [linear]="false" [selectedIndex]="currentStep" #stepper>

    <!-- Step 1: Welcome -->
    <mat-step [completed]="steps[0].completed">
      <ng-template matStepLabel>Welcome</ng-template>

      <div class="step-content">
        <h2>Welcome to the Database Migration Wizard</h2>

        <div class="info-box">
          <mat-icon>info</mat-icon>
          <div>
            <p><strong>What this does:</strong></p>
            <ul>
              <li>Converts your database to support multiple computers</li>
              <li>Stores database on your NAS for shared access</li>
              <li>Automatically syncs changes across all computers</li>
              <li>Handles different mount points on each computer</li>
            </ul>
          </div>
        </div>

        <div class="warning-box" *ngIf="instructions">
          <mat-icon>warning</mat-icon>
          <div>
            <p><strong>Before you start:</strong></p>
            <ul>
              <li *ngFor="let warning of instructions.warnings">{{ warning }}</li>
            </ul>
          </div>
        </div>

        <div class="status-info" *ngIf="status">
          <h3>Current Status:</h3>
          <p><strong>Configured:</strong> {{ status.isConfigured ? 'Yes' : 'No' }}</p>
          <p><strong>Shared Mode:</strong> {{ status.isSharedMode ? 'Active' : 'Inactive' }}</p>

          <div *ngIf="status.isConfigured && status.config" class="current-config">
            <h4>Current Configuration:</h4>
            <p><strong>Computer:</strong> {{ status.config.computerName }}</p>
            <p><strong>NAS Root:</strong> {{ status.config.nasRoot }}</p>
            <p><strong>Clips Folder:</strong> {{ status.config.pathMappings.clips }}</p>
          </div>
        </div>

        <div class="step-actions">
          <button mat-raised-button color="primary" (click)="nextStep()">
            Get Started
            <mat-icon>arrow_forward</mat-icon>
          </button>
        </div>
      </div>
    </mat-step>

    <!-- Step 2: Configure Paths -->
    <mat-step [completed]="steps[1].completed">
      <ng-template matStepLabel>Configure Paths</ng-template>

      <div class="step-content">
        <h2>Configure Path Mappings</h2>
        <p>Tell us where your NAS is mounted on this computer</p>

        <form class="config-form">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Computer Name</mat-label>
            <input matInput [(ngModel)]="migrationConfig.computerName"
                   name="computerName" placeholder="e.g., Mac Studio" required>
            <mat-hint>A friendly name to identify this computer</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>NAS Root Path</mat-label>
            <input matInput [(ngModel)]="migrationConfig.nasRoot"
                   name="nasRoot" placeholder="e.g., /Volumes/Callisto" required>
            <mat-hint>Where your NAS is mounted on this computer</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Clips Folder</mat-label>
            <input matInput [(ngModel)]="migrationConfig.clipsFolder"
                   name="clipsFolder" placeholder="e.g., /Volumes/Callisto/clips" required>
            <mat-hint>Where your video clips are stored</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Libraries Folder</mat-label>
            <input matInput [(ngModel)]="migrationConfig.librariesFolder"
                   name="librariesFolder" placeholder="e.g., /Volumes/Callisto/libraries" required>
            <mat-hint>Where the shared database will be stored</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Downloads Folder (Optional)</mat-label>
            <input matInput [(ngModel)]="migrationConfig.downloadsFolder"
                   name="downloadsFolder" placeholder="e.g., /Volumes/Callisto/downloads">
          </mat-form-field>

          <mat-expansion-panel>
            <mat-expansion-panel-header>
              <mat-panel-title>Advanced Options</mat-panel-title>
            </mat-expansion-panel-header>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Move Clips To (Optional)</mat-label>
              <input matInput [(ngModel)]="migrationConfig.moveClipsTo"
                     name="moveClipsTo" placeholder="e.g., /Volumes/Callisto/new-clips">
              <mat-hint>Leave empty to keep clips in current location</mat-hint>
            </mat-form-field>
          </mat-expansion-panel>
        </form>

        <div class="step-actions">
          <button mat-button (click)="previousStep()">
            <mat-icon>arrow_back</mat-icon>
            Back
          </button>
          <button mat-raised-button color="primary"
                  [disabled]="!isConfigValid()"
                  (click)="nextStep()">
            Next
            <mat-icon>arrow_forward</mat-icon>
          </button>
        </div>
      </div>
    </mat-step>

    <!-- Step 3: Preview -->
    <mat-step [completed]="steps[2].completed">
      <ng-template matStepLabel>Preview Changes</ng-template>

      <div class="step-content">
        <h2>Preview Migration</h2>
        <p>Run a dry-run to see what will be changed (no actual changes will be made)</p>

        <div class="preview-actions">
          <button mat-raised-button color="accent"
                  (click)="runPreview()"
                  [disabled]="isLoading">
            <mat-icon>preview</mat-icon>
            Run Preview
          </button>
        </div>

        <mat-progress-bar mode="indeterminate" *ngIf="isLoading"></mat-progress-bar>

        <div class="preview-results" *ngIf="previewResult">
          <h3>Preview Results</h3>

          <div class="result-card success" *ngIf="previewResult.success">
            <mat-icon>check_circle</mat-icon>
            <div>
              <h4>Preview Successful</h4>
              <p>{{ previewResult.message }}</p>
            </div>
          </div>

          <div class="stats-grid" *ngIf="previewResult.result">
            <div class="stat-card">
              <div class="stat-value">{{ formatCount(previewResult.result.stats.totalVideos) }}</div>
              <div class="stat-label">Total Videos</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">{{ formatCount(previewResult.result.stats.pathsConverted) }}</div>
              <div class="stat-label">Paths to Convert</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">{{ formatCount(previewResult.result.stats.pathsSkipped) }}</div>
              <div class="stat-label">Paths Skipped</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">{{ formatCount(previewResult.result.stats.errors.length) }}</div>
              <div class="stat-label">Errors</div>
            </div>
          </div>

          <div class="backup-info" *ngIf="previewResult.result?.backupPath">
            <mat-icon>backup</mat-icon>
            <div>
              <p><strong>Backup will be created at:</strong></p>
              <code>{{ previewResult.result.backupPath }}</code>
            </div>
          </div>

          <div class="errors-list" *ngIf="previewResult.result?.stats.errors.length > 0">
            <h4>Errors ({{ previewResult.result.stats.errors.length }}):</h4>
            <ul>
              <li *ngFor="let error of previewResult.result.stats.errors">{{ error }}</li>
            </ul>
          </div>
        </div>

        <div class="step-actions">
          <button mat-button (click)="previousStep()">
            <mat-icon>arrow_back</mat-icon>
            Back
          </button>
          <button mat-raised-button color="primary"
                  [disabled]="!previewResult?.success"
                  (click)="nextStep()">
            Continue to Migration
            <mat-icon>arrow_forward</mat-icon>
          </button>
        </div>
      </div>
    </mat-step>

    <!-- Step 4: Run Migration -->
    <mat-step [completed]="steps[3].completed">
      <ng-template matStepLabel>Run Migration</ng-template>

      <div class="step-content">
        <h2>Run Migration</h2>

        <div class="warning-box">
          <mat-icon>warning</mat-icon>
          <div>
            <p><strong>Important:</strong></p>
            <ul>
              <li>A backup will be created automatically</li>
              <li>This may take several minutes for large libraries</li>
              <li>Do not close the application during migration</li>
              <li>Ensure no other computers are accessing the database</li>
            </ul>
          </div>
        </div>

        <div class="migration-controls">
          <button mat-raised-button color="primary"
                  (click)="runActualMigration()"
                  [disabled]="migrationInProgress"
                  class="migrate-button">
            <mat-icon>sync</mat-icon>
            Start Migration
          </button>
        </div>

        <div class="migration-progress" *ngIf="migrationInProgress">
          <h3>Migration in Progress...</h3>
          <mat-progress-bar mode="indeterminate"></mat-progress-bar>
          <p class="progress-message" *ngIf="migrationProgress">
            {{ migrationProgress.message }}
          </p>
        </div>

        <div class="migration-results" *ngIf="migrationResult">
          <div class="result-card" [ngClass]="migrationResult.success ? 'success' : 'error'">
            <mat-icon>{{ migrationResult.success ? 'check_circle' : 'error' }}</mat-icon>
            <div>
              <h4>{{ migrationResult.success ? 'Migration Successful!' : 'Migration Failed' }}</h4>
              <p>{{ migrationResult.message }}</p>
            </div>
          </div>

          <div class="stats-grid" *ngIf="migrationResult.result">
            <div class="stat-card">
              <div class="stat-value">{{ formatCount(migrationResult.result.stats.totalVideos) }}</div>
              <div class="stat-label">Total Videos</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">{{ formatCount(migrationResult.result.stats.pathsConverted) }}</div>
              <div class="stat-label">Paths Converted</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">{{ formatCount(migrationResult.result.stats.pathsSkipped) }}</div>
              <div class="stat-label">Paths Skipped</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">{{ formatCount(migrationResult.result.stats.errors.length) }}</div>
              <div class="stat-label">Errors</div>
            </div>
          </div>
        </div>

        <div class="step-actions">
          <button mat-button (click)="previousStep()" [disabled]="migrationInProgress">
            <mat-icon>arrow_back</mat-icon>
            Back
          </button>
          <button mat-raised-button color="primary"
                  [disabled]="!migrationResult?.success"
                  (click)="nextStep()">
            Finish
            <mat-icon>done</mat-icon>
          </button>
        </div>
      </div>
    </mat-step>

    <!-- Step 5: Complete -->
    <mat-step [completed]="steps[4].completed">
      <ng-template matStepLabel>Complete</ng-template>

      <div class="step-content">
        <div class="completion-banner">
          <mat-icon class="large-icon">check_circle</mat-icon>
          <h2>Migration Complete!</h2>
          <p>Your database is now configured for multi-computer access</p>
        </div>

        <div class="info-box">
          <mat-icon>info</mat-icon>
          <div>
            <h4>Next Steps:</h4>
            <ol>
              <li>Your database is now stored on the NAS at: <code>{{ migrationConfig.librariesFolder }}/master.db</code></li>
              <li>To connect other computers, run this wizard on each one and use "Configure Paths Only"</li>
              <li>All computers will now share the same library automatically</li>
              <li>Changes made on any computer will be visible on all computers</li>
            </ol>
          </div>
        </div>

        <div class="additional-computers">
          <h3>Setting Up Additional Computers</h3>
          <p>To connect your other computers (MacBook Air, Windows PC, Linux), follow these steps:</p>
          <ol>
            <li>Open Clippy on the other computer</li>
            <li>Open this Migration Wizard</li>
            <li>Enter the path mapping for that computer (different mount points)</li>
            <li>Click "Configure Paths Only" (no need to migrate again)</li>
          </ol>
        </div>

        <div class="step-actions">
          <button mat-raised-button color="primary" (click)="currentStep = 0">
            <mat-icon>home</mat-icon>
            Return to Start
          </button>
        </div>
      </div>
    </mat-step>

  </mat-horizontal-stepper>

  <!-- Configure Paths Only Button (for additional computers) -->
  <div class="additional-actions" *ngIf="status && !status.isSharedMode && currentStep === 1">
    <button mat-stroked-button color="accent" (click)="configurePathsOnly()" [disabled]="isLoading">
      <mat-icon>settings</mat-icon>
      Configure Paths Only (Additional Computer)
    </button>
    <p class="hint-text">
      Use this if the database has already been migrated on another computer,
      and you just need to connect this computer to the shared database.
    </p>
  </div>
</div>
