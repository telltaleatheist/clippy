<div class="bulk-analysis-container">
  <div class="page-header">
    <h1>Analyze All Videos</h1>
    <p class="subtitle">Batch process unanalyzed videos</p>
  </div>

  <!-- Configuration Section -->
  <mat-card class="config-card">
    <mat-card-header>
      <mat-card-title>Configuration</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="config-grid">
        <!-- Operation Type -->
        <mat-form-field appearance="outline">
          <mat-label>Operation Type</mat-label>
          <mat-select [(ngModel)]="operationType" [disabled]="isProcessing">
            <mat-option value="transcribe">Transcribe Only</mat-option>
            <mat-option value="analyze">Transcribe + Analyze</mat-option>
          </mat-select>
          <mat-hint>Choose whether to transcribe only or transcribe and analyze</mat-hint>
        </mat-form-field>

        <!-- Whisper Model -->
        <mat-form-field appearance="outline">
          <mat-label>Whisper Model</mat-label>
          <mat-select [(ngModel)]="whisperModel" [disabled]="isProcessing">
            <mat-option *ngFor="let model of availableWhisperModels" [value]="model">
              {{ model }}
            </mat-option>
          </mat-select>
          <mat-hint>Select the Whisper model for transcription</mat-hint>
        </mat-form-field>

        <!-- AI Model (only show for analyze mode) -->
        <mat-form-field appearance="outline" *ngIf="operationType === 'analyze'">
          <mat-label>AI Model</mat-label>
          <mat-select [(ngModel)]="aiModel" [disabled]="isProcessing">
            <mat-option *ngFor="let model of availableModels" [value]="model">
              {{ model }}
            </mat-option>
          </mat-select>
          <mat-hint>Select the AI model for analysis</mat-hint>
        </mat-form-field>

        <!-- Sort Order -->
        <mat-form-field appearance="outline">
          <mat-label>Sort Order</mat-label>
          <mat-select [(ngModel)]="sortOrder" (selectionChange)="rescanVideos()" [disabled]="isProcessing">
            <mat-option value="oldest">Oldest First</mat-option>
            <mat-option value="newest">Newest First</mat-option>
            <mat-option value="shortest">Shortest First</mat-option>
            <mat-option value="longest">Longest First</mat-option>
          </mat-select>
          <mat-hint>How to sort the processing queue</mat-hint>
        </mat-form-field>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Progress Section -->
  <mat-card class="progress-card" *ngIf="progress && progress.total > 0">
    <mat-card-header>
      <mat-card-title>Progress</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="progress-stats">
        <div class="stat-item">
          <div class="stat-label">Total</div>
          <div class="stat-value">{{ progress.total }}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Processed</div>
          <div class="stat-value success">{{ progress.processed }}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Remaining</div>
          <div class="stat-value">{{ progress.remaining }}</div>
        </div>
        <div class="stat-item" *ngIf="progress.failed > 0">
          <div class="stat-label">Failed</div>
          <div class="stat-value error">{{ progress.failed }}</div>
        </div>
      </div>

      <mat-progress-bar
        mode="determinate"
        [value]="getProgressPercentage()"
        class="progress-bar">
      </mat-progress-bar>

      <div class="progress-text">
        {{ getProgressPercentage() }}% Complete
        <span *ngIf="progress.currentVideo" class="current-video">
          (Processing: {{ progress.currentVideo }})
        </span>
        <span *ngIf="progress.estimatedTimeRemaining" class="time-estimate">
          Estimated time remaining: {{ formatDuration(progress.estimatedTimeRemaining) }}
        </span>
      </div>

      <div class="action-buttons">
        <button
          mat-raised-button
          color="primary"
          *ngIf="!isProcessing && queuedVideos.length > 0"
          (click)="startProcessing()"
          [disabled]="isLoading || selectedVideoIds.size === 0"
          [matTooltip]="selectedVideoIds.size === 0 ? 'Please select videos to process' : ''">
          <mat-icon>play_arrow</mat-icon>
          Start Processing{{ selectedVideoIds.size > 0 ? ' (' + selectedVideoIds.size + ')' : '' }}
        </button>

        <button
          mat-raised-button
          color="warn"
          *ngIf="isProcessing"
          (click)="pauseProcessing()">
          <mat-icon>pause</mat-icon>
          Pause
        </button>

        <button
          mat-raised-button
          color="primary"
          *ngIf="!isProcessing && progress.processed > 0 && queuedVideos.length > 0"
          (click)="resumeProcessing()">
          <mat-icon>play_arrow</mat-icon>
          Resume
        </button>

        <button
          mat-stroked-button
          *ngIf="isProcessing"
          (click)="stopProcessing()">
          <mat-icon>stop</mat-icon>
          Stop
        </button>

        <button
          mat-stroked-button
          (click)="rescanVideos()"
          [disabled]="isProcessing || isLoading">
          <mat-icon>refresh</mat-icon>
          Rescan
        </button>

        <button
          mat-stroked-button
          color="warn"
          (click)="clearQueue()"
          [disabled]="isProcessing">
          <mat-icon>delete_sweep</mat-icon>
          Clear Queue
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Error List -->
  <mat-card class="errors-card" *ngIf="progress && progress.errors.length > 0">
    <mat-card-header>
      <mat-card-title>Failed Videos</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <mat-list>
        <mat-list-item *ngFor="let error of progress.errors">
          <mat-icon matListItemIcon color="warn">error</mat-icon>
          <div matListItemTitle>{{ error.filename }}</div>
          <div matListItemLine>{{ error.error }}</div>
        </mat-list-item>
      </mat-list>
    </mat-card-content>
  </mat-card>

  <!-- Video Queue List -->
  <mat-card class="queue-card">
    <mat-card-header>
      <mat-card-title>
        Queue ({{ queuedVideos.length }} videos)
        <span class="total-duration" *ngIf="queuedVideos.length > 0">
          Total Duration: {{ formatDuration(getTotalDuration()) }}
        </span>
      </mat-card-title>
      <div class="queue-subtitle"
           *ngIf="queuedVideos.length > 0 && !isProcessing"
           [style.visibility]="selectedVideoIds.size === 0 ? 'visible' : 'hidden'">
        <mat-icon>info</mat-icon>
        <span>Select videos below to process. Click "Select All" to process all videos, or click individual videos to select specific ones.</span>
      </div>
      <div class="queue-actions" *ngIf="queuedVideos.length > 0 && !isProcessing">
        <button mat-stroked-button (click)="selectAllVideos()">
          <mat-icon>select_all</mat-icon>
          Select All
        </button>
        <button mat-stroked-button (click)="deselectAllVideos()">
          <mat-icon>deselect</mat-icon>
          Deselect All
        </button>
        <button
          mat-stroked-button
          color="warn"
          (click)="removeSelectedVideos()"
          [disabled]="selectedVideoIds.size === 0">
          <mat-icon>remove_circle</mat-icon>
          Remove Selected ({{ selectedVideoIds.size }})
        </button>
      </div>
    </mat-card-header>
    <mat-card-content>
      <div class="loading-state" *ngIf="isLoading">
        <mat-progress-bar mode="indeterminate"></mat-progress-bar>
        <p>Loading videos...</p>
      </div>

      <div class="empty-state" *ngIf="!isLoading && queuedVideos.length === 0">
        <mat-icon>check_circle</mat-icon>
        <h2>No videos to process</h2>
        <p>All videos have been transcribed and analyzed!</p>
        <button mat-raised-button color="primary" (click)="rescanVideos()">
          <mat-icon>refresh</mat-icon>
          Rescan for Videos
        </button>
      </div>

      <div *ngIf="!isLoading && queuedVideos.length > 0" class="cascade-container">
        <cascade-list
          [items]="videoListItems"
          [displayConfig]="displayConfig"
          [selectionMode]="SelectionMode.Multiple"
          [selectedItemIds]="selectedVideoIds"
          [contextMenuActions]="contextMenuActions"
          (itemsSelected)="onVideosSelected($event)"
          (itemsDeselected)="onVideosDeselected($event)"
          (contextMenuAction)="onContextMenuAction($event)"
          (deleteAction)="onDeleteAction($event)"
          (spaceAction)="onSpaceAction($event)"
          (itemHighlighted)="onItemHighlighted($event)"
          emptyMessage="No videos in queue"
          emptyIcon="movie">

          <!-- Custom X button for each item -->
          <ng-template #itemActions let-item>
            <button
              mat-icon-button
              color="warn"
              (click)="removeVideo(item.id); $event.stopPropagation()"
              [disabled]="isProcessing"
              matTooltip="Remove from queue"
              class="remove-button">
              <mat-icon>close</mat-icon>
            </button>
          </ng-template>
        </cascade-list>
      </div>
    </mat-card-content>
  </mat-card>
</div>
