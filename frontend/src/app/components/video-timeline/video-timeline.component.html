<div class="timeline-container" tabindex="0" (keydown)="handleKeyDown($event)">
  <!-- Timeline controls -->
  <div class="timeline-controls">
    <div class="timeline-tools">
      <button
        mat-icon-button
        (click)="selectTool('cursor')"
        matTooltip="Cursor Tool (A) - Click to seek, drag to scrub"
        class="tool-button"
        [class.active]="selectedTool === 'cursor'">
        <mat-icon>near_me</mat-icon>
      </button>

      <button
        mat-icon-button
        (click)="selectTool('highlight')"
        matTooltip="Range Tool (R) - Select and edit timeline ranges"
        class="tool-button"
        [class.active]="selectedTool === 'highlight'">
        <mat-icon>highlight_alt</mat-icon>
      </button>

      <div class="tool-divider"></div>

      <button
        mat-icon-button
        (click)="togglePlayPause()"
        matTooltip="Play/Pause (K)"
        class="timeline-button playback-button">
        <mat-icon>{{ isPlaying ? 'pause' : 'play_arrow' }}</mat-icon>
      </button>
    </div>

    <div class="time-display">
      <div class="selection-info">
        <span class="selection-label">Selection:</span>
        <span class="selection-time">{{ getSelectionDuration() }}</span>
      </div>
      <div class="playhead-info">
        <span class="playhead-label">Current Position:</span>
        <span class="playhead-time">{{ formatTime(currentTime) }}</span>
      </div>
    </div>

    <div class="timeline-buttons">
      <button
        mat-icon-button
        (click)="setSelectionFromPlayhead()"
        matTooltip="Set start to playhead (I)"
        class="timeline-button">
        <mat-icon>keyboard_tab</mat-icon>
      </button>

      <button
        mat-icon-button
        (click)="setSelectionToPlayhead()"
        matTooltip="Set end to playhead (O)"
        class="timeline-button">
        <mat-icon>last_page</mat-icon>
      </button>

      <button
        mat-icon-button
        (click)="resetSelection()"
        matTooltip="Reset selection"
        class="timeline-button">
        <mat-icon>reset_tv</mat-icon>
      </button>

      <button
        mat-icon-button
        (click)="resetZoom()"
        [matTooltip]="zoomLevel > 1 ? 'Reset zoom (' + zoomLevel.toFixed(1) + 'x)' : 'Scroll to zoom, Shift+Scroll to pan'"
        class="timeline-button"
        [class.active]="zoomLevel > 1">
        <mat-icon>{{ zoomLevel > 1 ? 'zoom_in' : 'zoom_out_map' }}</mat-icon>
      </button>

      <button
        mat-icon-button
        (click)="toggleAutoFollow()"
        [matTooltip]="autoFollowPlayhead ? 'Auto-follow playhead: ON' : 'Auto-follow playhead: OFF'"
        class="timeline-button"
        [class.active]="autoFollowPlayhead">
        <mat-icon>{{ autoFollowPlayhead ? 'center_focus_strong' : 'center_focus_weak' }}</mat-icon>
      </button>
    </div>
  </div>

  <!-- Timeline track -->
  <div class="timeline-wrapper">
    <!-- Time markers with detailed ticks -->
    <div class="time-markers" (mousedown)="onTimeMarkerMouseDown($event)">
      <ng-container *ngFor="let marker of getTimeMarkers()">
        <div
          class="time-marker"
          [class.major]="marker.isMajor"
          [class.minor]="!marker.isMajor"
          [style.left.%]="marker.position">
          <span *ngIf="marker.showLabel" class="time-label">{{ marker.label }}</span>
          <div class="time-tick"></div>
        </div>
      </ng-container>
    </div>

    <div
      #timeline
      class="timeline"
      [class.zoomed]="zoomLevel > 1"
      (click)="onTimelineClick($event)"
      (mousedown)="onTimelineMouseDown($event)">

      <!-- Section markers (background) -->
      <div class="sections-layer">
        <div
          *ngFor="let section of filteredSections"
          class="section-marker"
          [style]="getSectionStyle(section)"
          [matTooltip]="section.description">
        </div>
      </div>

      <!-- Selection window -->
      <div
        #selectionWindow
        class="selection-window"
        [style]="getSelectionStyle()"
        (mousedown)="onWindowMouseDown($event)">

        <!-- Left handle -->
        <div
          class="selection-handle selection-handle-left"
          (mousedown)="onLeftHandleMouseDown($event)">
          <div class="handle-line"></div>
        </div>

        <!-- Right handle -->
        <div
          class="selection-handle selection-handle-right"
          (mousedown)="onRightHandleMouseDown($event)">
          <div class="handle-line"></div>
        </div>
      </div>

      <!-- Playhead -->
      <div
        class="playhead"
        [style]="getPlayheadStyle()"
        (mousedown)="onPlayheadMouseDown($event)">
        <div class="playhead-line"></div>
        <div class="playhead-handle"></div>
      </div>
    </div>

    <!-- Custom horizontal scrollbar with zoom handles -->
    <div class="timeline-scrollbar">
      <div class="scrollbar-track">
        <!-- Viewport window (the visible range indicator) -->
        <div
          class="scrollbar-viewport"
          [style]="getScrollbarViewportStyle()"
          (mousedown)="onScrollbarMouseDown($event)">

          <!-- Left zoom handle -->
          <div
            class="scrollbar-handle scrollbar-handle-left"
            (mousedown)="onLeftZoomHandleMouseDown($event)">
          </div>

          <!-- Right zoom handle -->
          <div
            class="scrollbar-handle scrollbar-handle-right"
            (mousedown)="onRightZoomHandleMouseDown($event)">
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
