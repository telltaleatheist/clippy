<!-- Batch Download - Creamsicle Theme -->
<div class="batch-container">
  <!-- Hero Header -->
  <div class="page-hero">
    <h1 class="hero-title">üì• Video Downloader</h1>
    <p class="hero-subtitle">Download videos from YouTube and other platforms</p>
  </div>

  <div class="page-content">
    <!-- Batch Download Form -->
    <div class="panel">
      <div class="panel-header">
        <h4 class="panel-title">Add Videos to Queue</h4>
      </div>
      <div class="panel-content">
        <form [formGroup]="batchForm" (ngSubmit)="onSubmit()">
          <!-- Multi URL Textarea -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Paste multiple URLs (one per line)</mat-label>
            <textarea
              matInput
              [(ngModel)]="multiUrlText"
              [ngModelOptions]="{standalone: true}"
              rows="4"
              placeholder="Paste multiple URLs, one per line"></textarea>
            <button
              type="button"
              mat-icon-button
              matSuffix
              (click)="addUrlsFromTextarea()"
              matTooltip="Add URLs to list"
            >
              <mat-icon>add_circle</mat-icon>
            </button>
          </mat-form-field>

          <!-- Batch Options -->
          <mat-expansion-panel class="options-panel">
            <mat-expansion-panel-header>
              <mat-panel-title>‚öôÔ∏è Download Options</mat-panel-title>
            </mat-expansion-panel-header>

            <div class="options-grid">
              <mat-form-field appearance="outline">
                <mat-label>Quality</mat-label>
                <mat-select formControlName="quality">
                  <mat-option *ngFor="let option of qualityOptions" [value]="option.value">
                    {{ option.label }}
                  </mat-option>
                </mat-select>
              </mat-form-field>

              <mat-checkbox formControlName="convertToMp4">Convert to MP4</mat-checkbox>
              <mat-checkbox formControlName="fixAspectRatio">Fix aspect ratio</mat-checkbox>
              <mat-checkbox formControlName="normalizeAudio">Normalize Audio</mat-checkbox>
              <mat-checkbox formControlName="useCookies">Use browser cookies</mat-checkbox>
              <mat-checkbox formControlName="transcribeVideo">Transcribe Video</mat-checkbox>

              <mat-form-field appearance="outline" *ngIf="batchForm.get('useCookies')?.value">
                <mat-label>Browser</mat-label>
                <mat-select formControlName="browser">
                  <mat-option *ngFor="let option of browserOptions" [value]="option.value">
                    {{ option.label }}
                  </mat-option>
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Output Directory</mat-label>
                <input matInput formControlName="outputDir" readonly>
                <mat-hint>Leave empty to use default location</mat-hint>
              </mat-form-field>
            </div>
          </mat-expansion-panel>

          <!-- URL List -->
          <div formArrayName="urls" class="url-list-compact">
            <div *ngFor="let urlControl of urls.controls; let i = index" [formGroupName]="i" class="url-list-item">
              <mat-expansion-panel class="url-accordion">
                <mat-expansion-panel-header>
                  <mat-panel-title class="url-accordion-title">
                    <mat-icon *ngIf="urlControl.get('loading')?.value" class="status-icon loading">hourglass_empty</mat-icon>
                    <mat-icon *ngIf="!urlControl.get('loading')?.value" class="status-icon">videocam</mat-icon>
                    <span class="video-title">{{ urlControl.get('title')?.value || 'Video ' + (i+1) }}</span>
                  </mat-panel-title>
                  <button
                    type="button"
                    mat-icon-button
                    class="btn-delete"
                    (click)="removeUrlField(i); $event.stopPropagation()"
                    [disabled]="urls.length === 1"
                    matTooltip="Remove"
                  >
                    <mat-icon>close</mat-icon>
                  </button>
                </mat-expansion-panel-header>

                <div class="url-accordion-content">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Video URL</mat-label>
                    <input
                      matInput
                      placeholder="https://www.youtube.com/watch?v=..."
                      formControlName="url"
                      autocomplete="off"
                      (input)="updateMultiUrlTextarea(); loadFileNameForUrl(i)"
                    >
                    <mat-error *ngIf="urlControl.get('url')?.hasError('required')">URL is required</mat-error>
                    <mat-error *ngIf="urlControl.get('url')?.hasError('pattern')">Please enter a valid URL</mat-error>
                    <button
                      type="button"
                      mat-icon-button
                      matSuffix
                      (click)="pasteFromClipboard(i)"
                      matTooltip="Paste from clipboard"
                    >
                      <mat-icon>content_paste</mat-icon>
                    </button>
                  </mat-form-field>

                  <div class="url-specific-options">
                    <mat-checkbox formControlName="overrideBatchSettings">
                      Override Batch Settings
                    </mat-checkbox>

                    <ng-container *ngIf="urlControl.get('overrideBatchSettings')?.value">
                      <div class="options-grid">
                        <mat-form-field appearance="outline">
                          <mat-label>Quality</mat-label>
                          <mat-select formControlName="quality">
                            <mat-option *ngFor="let option of qualityOptions" [value]="option.value">
                              {{ option.label }}
                            </mat-option>
                          </mat-select>
                        </mat-form-field>

                        <mat-checkbox formControlName="convertToMp4">Convert to MP4</mat-checkbox>
                        <mat-checkbox formControlName="fixAspectRatio">Fix aspect ratio</mat-checkbox>
                        <mat-checkbox formControlName="useCookies">Use browser cookies</mat-checkbox>

                        <mat-form-field appearance="outline" *ngIf="urlControl.get('useCookies')?.value">
                          <mat-label>Browser</mat-label>
                          <mat-select formControlName="browser">
                            <mat-option *ngFor="let option of browserOptions" [value]="option.value">
                              {{ option.label }}
                            </mat-option>
                          </mat-select>
                        </mat-form-field>

                        <mat-checkbox formControlName="transcribeVideo">Transcribe Video</mat-checkbox>
                      </div>
                    </ng-container>
                  </div>
                </div>
              </mat-expansion-panel>
            </div>
          </div>

          <div class="form-actions">
            <button
              mat-raised-button
              color="accent"
              type="submit"
              [disabled]="batchForm.invalid">
              <mat-icon>add_to_queue</mat-icon>
              Add to Queue
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Batch Queue Status -->
    <div class="panel" *ngIf="batchQueueStatus">
      <div class="panel-header">
        <h4 class="panel-title">üìä Queue Status</h4>
        <span class="badge" [ngClass]="batchQueueStatus.isProcessing ? 'badge-success' : 'badge-info'">
          {{ batchQueueStatus.isProcessing ? 'Processing' : 'Idle' }}
        </span>
      </div>

      <div class="panel-content">
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-value">{{ batchQueueStatus.activeDownloadCount }}</div>
            <div class="stat-label">Active</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">{{ batchQueueStatus.queuedJobs.length }}</div>
            <div class="stat-label">Queued</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">{{ batchQueueStatus.processingJobs.length }}</div>
            <div class="stat-label">Processing</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">{{ batchQueueStatus.downloadedJobs.length }}</div>
            <div class="stat-label">Downloaded</div>
          </div>
        </div>

        <!-- Configuration -->
        <mat-expansion-panel class="config-panel">
          <mat-expansion-panel-header>
            <mat-panel-title>‚öôÔ∏è Batch Configuration</mat-panel-title>
          </mat-expansion-panel-header>

          <form [formGroup]="configForm" (ngSubmit)="saveConfig()">
            <div class="config-options">
              <mat-form-field appearance="outline">
                <mat-label>Max Concurrent Downloads</mat-label>
                <input matInput type="number" formControlName="maxConcurrentDownloads" min="1" max="10">
                <mat-hint>Set between 1-10 downloads</mat-hint>
              </mat-form-field>

              <mat-checkbox formControlName="enabled">Enable batch processing</mat-checkbox>

              <button mat-raised-button color="primary" type="submit" [disabled]="configForm.invalid">
                Save Configuration
              </button>
            </div>
          </form>
        </mat-expansion-panel>

        <!-- Jobs List -->
        <div class="jobs-section">
          <h3>All Jobs</h3>

          <div class="jobs-list">
            <div *ngFor="let job of getAllJobsForDisplay()"
                 class="job-card"
                 [ngClass]="'job-' + (job.status || 'unknown')">
              <div class="job-header">
                <span class="job-title">{{ getDisplayName(job) }}</span>
                <span class="badge" [ngClass]="'badge-' + getStatusBadgeType(job.status || '')">
                  {{ isProcessingJob(job) ? 'Processing' : job.status }}
                </span>
              </div>

              <div class="job-progress-row">
                <div class="job-progress">
                  <div class="progress-label">
                    {{ job.currentTask || getDefaultTaskForStatus(job.status) }}
                  </div>
                  <div class="progress-bar-container">
                    <div class="progress-bar" [style.width.%]="job.progress || 0"></div>
                  </div>
                  <div class="progress-value">{{ job.progress || 0 }}%</div>
                </div>

                <div class="job-actions">
                  <button *ngIf="job.status === 'failed'"
                          mat-icon-button
                          (click)="showJobError(job)"
                          matTooltip="View Error">
                    <mat-icon>error_outline</mat-icon>
                  </button>
                  <button *ngIf="job.status !== 'completed'"
                          mat-icon-button
                          (click)="cancelJob(job.id)"
                          matTooltip="Cancel">
                    <mat-icon>close</mat-icon>
                  </button>
                  <button *ngIf="job.status === 'failed'"
                          mat-icon-button
                          (click)="retryJob(job.id)"
                          matTooltip="Retry">
                    <mat-icon>refresh</mat-icon>
                  </button>
                </div>
              </div>
            </div>

            <div class="empty-state" *ngIf="getAllJobsForDisplay().length === 0">
              <mat-icon class="empty-icon">inbox</mat-icon>
              <p>No active jobs</p>
              <p class="empty-hint">Add URLs above to start downloading</p>
            </div>
          </div>
        </div>

        <div class="panel-actions">
          <button mat-raised-button color="primary" (click)="refreshBatchStatus()">
            <mat-icon>refresh</mat-icon> Refresh
          </button>

          <button mat-stroked-button color="warn" (click)="clearQueue()"
                [disabled]="!hasActiveJobs()">
            <mat-icon>clear_all</mat-icon> Clear Queue
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
