<div class="analysis-parameters-container">
  <mat-card class="parameters-card">
    <mat-card-header>
      <mat-card-title>Analysis Parameters</mat-card-title>
      <mat-card-subtitle>Configure the categories used for AI video analysis</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <div class="info-section">
        <mat-icon class="info-icon">info</mat-icon>
        <div class="info-text">
          <p><strong>Category Names</strong> must be lowercase, using only letters, numbers, and hyphens (e.g., "hate", "conspiracy", "false-prophecy").</p>
          <p><strong>Descriptions</strong> tell the AI what content to look for in each category. Be specific and include examples.</p>
          <p>Changes will apply to new analyses. Existing analysis results are not affected.</p>
        </div>
      </div>

      <form [formGroup]="categoriesForm">
        <div formArrayName="categories" class="categories-list">
          <div *ngFor="let category of categories.controls; let i = index"
               [formGroupName]="i"
               class="category-item">
            <mat-expansion-panel>
              <mat-expansion-panel-header>
                <mat-panel-title>
                  <span class="category-index">{{ i + 1 }}.</span>
                  <span class="category-name-preview">{{ category.get('name')?.value || 'New Category' }}</span>
                </mat-panel-title>
                <mat-panel-description>
                  {{ category.get('description')?.value?.substring(0, 100) || 'No description' }}
                  {{ category.get('description')?.value?.length > 100 ? '...' : '' }}
                </mat-panel-description>
              </mat-expansion-panel-header>

              <div class="category-form">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Category Name</mat-label>
                  <input matInput
                         formControlName="name"
                         placeholder="e.g., hate, conspiracy, false-prophecy"
                         [class.error]="category.get('name')?.invalid && category.get('name')?.touched">
                  <mat-hint>Lowercase, letters, numbers, and hyphens only</mat-hint>
                  <mat-error *ngIf="category.get('name')?.hasError('required')">
                    Category name is required
                  </mat-error>
                  <mat-error *ngIf="category.get('name')?.hasError('pattern')">
                    Use only lowercase letters, numbers, and hyphens
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Description</mat-label>
                  <textarea matInput
                            formControlName="description"
                            rows="4"
                            placeholder="Describe what content the AI should flag in this category. Include specific examples."
                            [class.error]="category.get('description')?.invalid && category.get('description')?.touched"></textarea>
                  <mat-hint>What should the AI look for? Be specific.</mat-hint>
                  <mat-error *ngIf="category.get('description')?.hasError('required')">
                    Description is required
                  </mat-error>
                </mat-form-field>

                <div class="category-actions">
                  <button mat-icon-button
                          (click)="moveUp(i)"
                          [disabled]="i === 0"
                          matTooltip="Move up"
                          type="button">
                    <mat-icon>arrow_upward</mat-icon>
                  </button>
                  <button mat-icon-button
                          (click)="moveDown(i)"
                          [disabled]="i === categories.length - 1"
                          matTooltip="Move down"
                          type="button">
                    <mat-icon>arrow_downward</mat-icon>
                  </button>
                  <button mat-icon-button
                          (click)="removeCategory(i)"
                          color="warn"
                          matTooltip="Delete category"
                          type="button">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>
            </mat-expansion-panel>
          </div>

          <div *ngIf="categories.length === 0" class="empty-state">
            <mat-icon>category</mat-icon>
            <p>No categories defined. Click "Add Category" to create one.</p>
          </div>
        </div>

        <div class="action-buttons">
          <button mat-raised-button
                  color="primary"
                  (click)="addCategory()"
                  type="button">
            <mat-icon>add</mat-icon>
            Add Category
          </button>

          <button mat-raised-button
                  color="warn"
                  (click)="resetToDefaults()"
                  [disabled]="isLoading || isSaving"
                  type="button">
            <mat-icon>refresh</mat-icon>
            Reset to Defaults
          </button>

          <button mat-raised-button
                  color="accent"
                  (click)="saveCategories()"
                  [disabled]="categoriesForm.invalid || isLoading || isSaving"
                  type="button">
            <mat-icon>save</mat-icon>
            {{ isSaving ? 'Saving...' : 'Save Categories' }}
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
</div>
