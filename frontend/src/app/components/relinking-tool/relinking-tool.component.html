<div class="relinking-tool">
  <!-- Header -->
  <div class="tool-header">
    <h1>Relink Files by Hash</h1>
    <p>Update database paths by matching files using hash comparison</p>
  </div>

  <!-- Current Library Info -->
  <div class="library-info" *ngIf="status?.activeLibrary as library">
    <h2>Active Library</h2>
    <p><strong>Name:</strong> {{ library.name }}</p>
    <p><strong>Current Clips Folder:</strong> <code>{{ library.clipsFolderPath }}</code></p>
  </div>

  <div class="library-info error" *ngIf="status && !status.activeLibrary">
    <mat-icon>warning</mat-icon>
    <div>
      <h3>No Active Library</h3>
      <p>Please create or select a library before using the relinking tool.</p>
    </div>
  </div>

  <!-- Configuration Form -->
  <div class="config-section" *ngIf="status?.activeLibrary">
    <h2>Relinking Configuration</h2>

    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Target Clips Folder</mat-label>
      <input matInput [(ngModel)]="targetPath" placeholder="e.g., /Volumes/Callisto/clips" required>
      <mat-hint>Path to the folder containing your video files</mat-hint>
    </mat-form-field>

    <mat-checkbox [(ngModel)]="updateLibraryPath" class="update-path-checkbox">
      Update library clips folder path to match
    </mat-checkbox>

    <mat-checkbox [(ngModel)]="copyMissingFiles" class="update-path-checkbox">
      Copy missing files to target folder (recommended for library transfer)
    </mat-checkbox>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <button mat-raised-button color="accent"
              (click)="runPreview()"
              [disabled]="isLoading || isRelinking || !targetPath">
        <mat-icon>preview</mat-icon>
        Run Preview (Dry Run)
      </button>

      <button mat-raised-button color="primary"
              (click)="runRelink()"
              [disabled]="isLoading || isRelinking || !targetPath || !previewResult">
        <mat-icon>link</mat-icon>
        Run Relinking
      </button>
    </div>
  </div>

  <!-- Loading Indicator -->
  <mat-progress-bar mode="indeterminate" *ngIf="isLoading || isRelinking"></mat-progress-bar>

  <!-- Preview Results -->
  <div class="results-section" *ngIf="previewResult">
    <h2>Preview Results</h2>

    <div class="result-card success" *ngIf="previewResult.success">
      <mat-icon>check_circle</mat-icon>
      <div>
        <h3>Preview Successful</h3>
        <p>{{ previewResult.message }}</p>
      </div>
    </div>

    <div class="stats-grid" *ngIf="previewResult.result">
      <div class="stat-card">
        <div class="stat-value">{{ formatCount(previewResult.result.stats.totalFiles) }}</div>
        <div class="stat-label">Files Found</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ formatCount(previewResult.result.stats.matched) }}</div>
        <div class="stat-label">Matched by Hash</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ formatCount(previewResult.result.stats.updated) }}</div>
        <div class="stat-label">Will Update</div>
      </div>
      <div class="stat-card" *ngIf="previewResult.result.stats.copied > 0">
        <div class="stat-value">{{ formatCount(previewResult.result.stats.copied) }}</div>
        <div class="stat-label">Will Copy</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ formatCount(previewResult.result.stats.notFound) }}</div>
        <div class="stat-label">Not Found</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ formatCount(previewResult.result.stats.errors.length) }}</div>
        <div class="stat-label">Errors</div>
      </div>
    </div>

    <div class="errors-list" *ngIf="previewResult.result?.stats.errors.length > 0">
      <h3>Errors ({{ previewResult.result.stats.errors.length }})</h3>
      <ul>
        <li *ngFor="let error of previewResult.result.stats.errors">{{ error }}</li>
      </ul>
    </div>
  </div>

  <!-- Relinking Results -->
  <div class="results-section" *ngIf="relinkResult">
    <h2>Relinking Results</h2>

    <div class="result-card" [ngClass]="relinkResult.success ? 'success' : 'error'">
      <mat-icon>{{ relinkResult.success ? 'check_circle' : 'error' }}</mat-icon>
      <div>
        <h3>{{ relinkResult.success ? 'Relinking Successful!' : 'Relinking Failed' }}</h3>
        <p>{{ relinkResult.message }}</p>
      </div>
    </div>

    <div class="stats-grid" *ngIf="relinkResult.result">
      <div class="stat-card">
        <div class="stat-value">{{ formatCount(relinkResult.result.stats.totalFiles) }}</div>
        <div class="stat-label">Files Scanned</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ formatCount(relinkResult.result.stats.matched) }}</div>
        <div class="stat-label">Matched</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ formatCount(relinkResult.result.stats.updated) }}</div>
        <div class="stat-label">Updated</div>
      </div>
      <div class="stat-card" *ngIf="relinkResult.result.stats.copied > 0">
        <div class="stat-value">{{ formatCount(relinkResult.result.stats.copied) }}</div>
        <div class="stat-label">Copied</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ formatCount(relinkResult.result.stats.notFound) }}</div>
        <div class="stat-label">Not Found</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ formatCount(relinkResult.result.stats.errors.length) }}</div>
        <div class="stat-label">Errors</div>
      </div>
    </div>

    <div class="backup-info" *ngIf="relinkResult.result?.backupPath">
      <mat-icon>backup</mat-icon>
      <div>
        <p><strong>Backup created at:</strong></p>
        <code>{{ relinkResult.result.backupPath }}</code>
      </div>
    </div>

    <div class="errors-list" *ngIf="relinkResult.result?.stats.errors.length > 0">
      <h3>Errors ({{ relinkResult.result.stats.errors.length }})</h3>
      <ul>
        <li *ngFor="let error of relinkResult.result.stats.errors">{{ error }}</li>
      </ul>
    </div>
  </div>

  <!-- Help Section -->
  <div class="help-section">
    <h2>How It Works</h2>
    <ol>
      <li>The tool scans the target folder and computes file hashes</li>
      <li>Files are matched to database entries using hash comparison</li>
      <li>Database paths are updated to point to the new file locations</li>
      <li>Files not found in the target folder will be reported as errors</li>
    </ol>

    <div class="warning-box">
      <mat-icon>warning</mat-icon>
      <div>
        <p><strong>Important:</strong></p>
        <ul>
          <li>Files must be identical (same hash) to be matched</li>
          <li>A backup is created automatically before relinking</li>
          <li>This may take several minutes for large libraries</li>
        </ul>
      </div>
    </div>
  </div>
</div>
