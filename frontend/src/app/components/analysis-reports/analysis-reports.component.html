<!-- Analysis Reports Viewer with Library Integration -->
<div class="reports-container">
  <div class="page-content">

    <!-- File Browser (Left Panel) with Tabs -->
    <div class="panel file-browser-panel">
      <div class="panel-header">
        <h4 class="panel-title">ðŸ“Š Analysis Library</h4>
      </div>

      <!-- Tabs for Active/Archived -->
      <mat-tab-group (selectedIndexChange)="onTabChange($event)">
        <!-- Active Tab -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon class="tab-icon">folder_open</mat-icon>
            Active ({{ activeAnalyses.length }})
          </ng-template>

          <div class="tab-content">
            <div *ngIf="isLoading && activeAnalyses.length === 0" class="loading-container">
              <mat-spinner diameter="40"></mat-spinner>
              <p>Loading analyses...</p>
            </div>

            <div *ngIf="!isLoading && activeAnalyses.length === 0" class="empty-state">
              <mat-icon>description</mat-icon>
              <p>No active analyses</p>
              <small>Run video analysis to create new analyses</small>
            </div>

            <div *ngIf="activeAnalyses.length > 0" class="reports-list">
              <div
                *ngFor="let analysis of activeAnalyses"
                (click)="selectAnalysis(analysis)"
                [class.selected]="selectedAnalysis?.id === analysis.id"
                class="report-item">
                <div class="report-content">
                  <div class="report-title">{{ analysis.title }}</div>
                  <div class="report-meta">
                    <span class="report-date">{{ formatDate(analysis.createdAt) }}</span>
                    <span class="report-duration" *ngIf="analysis.video.durationSeconds">
                      {{ formatDuration(analysis.video.durationSeconds) }}
                    </span>
                    <span class="video-status" *ngIf="!analysis.video.isLinked" matTooltip="Video not found">
                      <mat-icon>link_off</mat-icon>
                    </span>
                  </div>
                  <div class="report-categories" *ngIf="analysis.metadata.categories.length > 0">
                    <span
                      *ngFor="let cat of analysis.metadata.categories"
                      class="category-badge"
                      [style.background-color]="getCategoryColor(cat)">
                      {{ cat }}
                    </span>
                  </div>
                </div>
                <div class="report-actions">
                  <button mat-icon-button class="relink-button" (click)="relinkVideo(analysis); $event.stopPropagation()" matTooltip="Relink Video">
                    <mat-icon>link</mat-icon>
                  </button>
                  <button mat-icon-button class="archive-button" (click)="archiveAnalysis(analysis); $event.stopPropagation()" matTooltip="Archive">
                    <mat-icon>archive</mat-icon>
                  </button>
                  <button mat-icon-button class="delete-button" (click)="deleteAnalysis(analysis); $event.stopPropagation()" matTooltip="Delete">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </mat-tab>

        <!-- Archived Tab -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon class="tab-icon">inventory_2</mat-icon>
            Archived ({{ archivedAnalyses.length }})
          </ng-template>

          <div class="tab-content">
            <div *ngIf="isLoading && archivedAnalyses.length === 0" class="loading-container">
              <mat-spinner diameter="40"></mat-spinner>
              <p>Loading archived analyses...</p>
            </div>

            <div *ngIf="!isLoading && archivedAnalyses.length === 0" class="empty-state">
              <mat-icon>inventory_2</mat-icon>
              <p>No archived analyses</p>
              <small>Archive analyses you don't need immediate access to</small>
            </div>

            <div *ngIf="archivedAnalyses.length > 0" class="reports-list">
              <div
                *ngFor="let analysis of archivedAnalyses"
                (click)="selectAnalysis(analysis)"
                [class.selected]="selectedAnalysis?.id === analysis.id"
                class="report-item">
                <div class="report-content">
                  <div class="report-title">{{ analysis.title }}</div>
                  <div class="report-meta">
                    <span class="report-date">{{ formatDate(analysis.createdAt) }}</span>
                    <span class="report-duration" *ngIf="analysis.video.durationSeconds">
                      {{ formatDuration(analysis.video.durationSeconds) }}
                    </span>
                  </div>
                </div>
                <div class="report-actions">
                  <button mat-icon-button class="relink-button" (click)="relinkVideo(analysis); $event.stopPropagation()" matTooltip="Relink Video">
                    <mat-icon>link</mat-icon>
                  </button>
                  <button mat-icon-button class="unarchive-button" (click)="unarchiveAnalysis(analysis); $event.stopPropagation()" matTooltip="Unarchive">
                    <mat-icon>unarchive</mat-icon>
                  </button>
                  <button mat-icon-button class="delete-button" (click)="deleteAnalysis(analysis); $event.stopPropagation()" matTooltip="Delete">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </mat-tab>
      </mat-tab-group>
    </div>

    <!-- Analysis Viewer (Right Panel) -->
    <div class="panel report-viewer-panel">
      <div class="panel-header" *ngIf="selectedAnalysis">
        <div class="header-content">
          <h4 class="panel-title">{{ selectedAnalysis.title }}</h4>
          <p class="panel-subtitle" *ngIf="selectedAnalysis.video.durationSeconds">
            Duration: {{ formatDuration(selectedAnalysis.video.durationSeconds) }}
            <span class="divider">â€¢</span>
            {{ formatDate(selectedAnalysis.createdAt) }}
          </p>
        </div>
        <div class="panel-actions">
          <button
            mat-raised-button
            color="primary"
            class="clip-creator-button"
            (click)="manageClips(selectedAnalysis)">
            <mat-icon>content_cut</mat-icon>
            CLIP CREATOR
          </button>
          <button
            mat-stroked-button
            (click)="showInFolder(selectedAnalysis)"
            [disabled]="!selectedAnalysis.video.isLinked">
            <mat-icon>folder</mat-icon>
            Show in Folder
          </button>
          <button
            *ngIf="!selectedAnalysis.video.isLinked"
            mat-stroked-button
            color="warn"
            (click)="relinkVideo(selectedAnalysis)">
            <mat-icon>link_off</mat-icon>
            Relink Video
          </button>
        </div>
      </div>

      <div class="panel-content viewer-content">
        <div *ngIf="!selectedAnalysis" class="empty-viewer">
          <mat-icon>touch_app</mat-icon>
          <p>Select an analysis to view</p>
          <small>Click on an analysis from the list on the left</small>
        </div>

        <div *ngIf="isLoading && selectedAnalysis" class="loading-container">
          <mat-spinner diameter="40"></mat-spinner>
          <p>Loading analysis...</p>
        </div>

        <div *ngIf="!isLoading && selectedAnalysis && parsedMetadata && parsedMetadata.sections.length > 0" class="report-sections">
          <div *ngFor="let section of parsedMetadata.sections; let i = index" class="section-card">
            <!-- Section Header -->
            <div class="section-header">
              <div class="section-icon" [style.background-color]="getCategoryColor(section.category)">
                <mat-icon>{{ getCategoryIcon(section.category) }}</mat-icon>
              </div>
              <div class="section-info">
                <div class="section-title">
                  <span class="time-range">{{ section.timeRange }}</span>
                  <span class="category-badge" [style.background-color]="getCategoryColor(section.category)">
                    {{ section.category }}
                  </span>
                </div>
                <p class="section-description">{{ section.description }}</p>
              </div>
            </div>

            <!-- Quotes -->
            <div class="quotes-container" *ngIf="section.quotes.length > 0">
              <div *ngFor="let quote of section.quotes" class="quote-block">
                <div class="quote-header">
                  <mat-icon class="quote-icon">format_quote</mat-icon>
                  <span class="timestamp">{{ quote.timestamp }}</span>
                </div>
                <blockquote class="quote-text">"{{ quote.text }}"</blockquote>
                <div class="quote-significance" *ngIf="quote.significance">
                  <mat-icon>lightbulb_outline</mat-icon>
                  <p>{{ quote.significance }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div *ngIf="!isLoading && selectedAnalysis && parsedMetadata && parsedMetadata.sections.length === 0" class="empty-report">
          <mat-icon>info</mat-icon>
          <p>No sections found in this analysis</p>
          <small>The analysis may be empty or malformed</small>
        </div>
      </div>
    </div>

  </div>
</div>
