<div class="video-info-container">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Loading video information...</p>
  </div>

  <!-- Main Content with Split View -->
  <div *ngIf="!isLoading && video" class="split-container">
    <!-- Top Section: Video Info -->
    <div class="content-wrapper">
    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <button mat-icon-button (click)="goBack()" class="back-button">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <div class="title-container">
          <div *ngIf="!isEditingTitle" class="title-display">
            <h1 class="video-title">{{ video.filename }}</h1>
            <button mat-icon-button
                    (click)="startEditingTitle()"
                    class="edit-title-button"
                    matTooltip="Edit title">
              <mat-icon>edit</mat-icon>
            </button>
          </div>
          <div *ngIf="isEditingTitle" class="title-edit-container">
            <mat-form-field appearance="outline" class="title-input">
              <input matInput
                     [(ngModel)]="editedTitle"
                     (keydown)="onTitleKeydown($event)"
                     #titleInput
                     placeholder="Enter video title"
                     autofocus>
            </mat-form-field>
            <button mat-icon-button
                    (click)="saveTitle()"
                    color="primary"
                    matTooltip="Save">
              <mat-icon>check</mat-icon>
            </button>
            <button mat-icon-button
                    (click)="cancelEditingTitle()"
                    matTooltip="Cancel">
              <mat-icon>close</mat-icon>
            </button>
          </div>
        </div>
      </div>
      <div class="header-actions">
        <button mat-raised-button color="primary" (click)="openClipCreator()" class="primary-action">
          <mat-icon>movie_filter</mat-icon>
          Clip Creator
        </button>
        <button mat-raised-button
                color="accent"
                (click)="runAnalysis()">
          <mat-icon>
            {{ analysis || transcript ? 'refresh' : 'psychology' }}
          </mat-icon>
          {{ analysis || transcript ? 'Re-analyze' : 'Analyze' }}
        </button>
      </div>
    </div>

    <!-- Two Column Layout: Video+Description on left, Metadata on right -->
    <div class="video-metadata-grid">
      <!-- Left Column: Video and AI Description -->
      <div class="video-column">
        <div class="video-preview">
          <video #videoPlayer
                 [src]="videoUrl"
                 controls
                 preload="metadata"
                 class="video-player"
                 (error)="onVideoError($event)"
                 (loadedmetadata)="onVideoLoaded()"
                 *ngIf="videoUrl">
            Your browser does not support the video tag.
          </video>
          <div class="no-video" *ngIf="!videoUrl">
            <mat-icon>movie</mat-icon>
            <p>Loading video...</p>
          </div>
          <div class="video-error" *ngIf="videoError">
            <mat-icon>error</mat-icon>
            <p>{{ videoError }}</p>
          </div>
        </div>

        <!-- AI Description (Under Video) -->
        <div class="ai-description-main" *ngIf="video?.ai_description">
          <mat-card class="ai-description-card">
            <h3>
              <mat-icon>description</mat-icon>
              AI Description
            </h3>
            <p>{{ video.ai_description }}</p>
          </mat-card>
        </div>
      </div>

      <!-- Right Column: Metadata -->
      <div class="metadata-column">
        <h2>Metadata</h2>
        <mat-card class="metadata-card">
          <!-- Primary Info Grid (2 columns) -->
          <div class="metadata-grid-primary">
            <div class="metadata-item">
              <mat-icon>schedule</mat-icon>
              <div class="metadata-content">
                <span class="metadata-label">Duration</span>
                <span class="metadata-value">{{ formatDuration(video.duration_seconds) }}</span>
              </div>
            </div>

            <div class="metadata-item">
              <mat-icon>storage</mat-icon>
              <div class="metadata-content">
                <span class="metadata-label">File Size</span>
                <span class="metadata-value">{{ formatFileSize(video.file_size_bytes) }}</span>
              </div>
            </div>

            <div class="metadata-item">
              <mat-icon>calendar_today</mat-icon>
              <div class="metadata-content">
                <span class="metadata-label">Created</span>
                <span class="metadata-value">{{ formatDate(video.created_at) }}</span>
              </div>
            </div>

            <div class="metadata-item">
              <mat-icon>update</mat-icon>
              <div class="metadata-content">
                <span class="metadata-label">Added</span>
                <span class="metadata-value">{{ formatDate(video.added_at) }}</span>
              </div>
            </div>

            <div class="metadata-item metadata-item-full" *ngIf="video.date_folder">
              <mat-icon>event</mat-icon>
              <div class="metadata-content">
                <span class="metadata-label">Date Folder</span>
                <span class="metadata-value">{{ video.date_folder }}</span>
              </div>
            </div>
          </div>

          <!-- Path Section (Full Width) -->
          <mat-divider></mat-divider>

          <div class="metadata-path-section">
            <div class="metadata-item">
              <mat-icon>folder</mat-icon>
              <div class="metadata-content">
                <span class="metadata-label">File Path</span>
                <span class="metadata-value path">{{ video.current_path }}</span>
              </div>
            </div>
          </div>
        </mat-card>

        <!-- Tags Section -->
        <h2 class="tags-header">
          Tags
          <button mat-icon-button
                  (click)="startAddingTag()"
                  class="add-tag-button"
                  matTooltip="Add tag">
            <mat-icon>add</mat-icon>
          </button>
        </h2>
        <mat-card class="tags-card">
          <!-- Tag Input -->
          <div *ngIf="isAddingTag" class="tag-input-container">
            <mat-form-field appearance="outline" class="tag-name-input">
              <mat-label>Tag Name</mat-label>
              <input matInput
                     [(ngModel)]="newTagName"
                     (keydown)="onTagKeydown($event)"
                     placeholder="Enter tag name"
                     autofocus>
            </mat-form-field>
            <mat-form-field appearance="outline" class="tag-type-select">
              <mat-label>Type</mat-label>
              <select matNativeControl [(ngModel)]="newTagType">
                <option value="manual">Manual</option>
                <option value="person">Person</option>
                <option value="topic">Topic</option>
                <option value="other">Other</option>
              </select>
            </mat-form-field>
            <button mat-icon-button
                    (click)="saveTag()"
                    color="primary"
                    matTooltip="Save tag">
              <mat-icon>check</mat-icon>
            </button>
            <button mat-icon-button
                    (click)="cancelAddingTag()"
                    matTooltip="Cancel">
              <mat-icon>close</mat-icon>
            </button>
          </div>

          <!-- Tags Display -->
          <div class="tags-list" *ngIf="tags.length > 0">
            <div class="tag-chip" *ngFor="let tag of tags"
                 [style.border-color]="getTagTypeColor(tag.tag_type)">
              <div class="tag-info">
                <span class="tag-name">{{ tag.tag_name }}</span>
                <span class="tag-type" [style.color]="getTagTypeColor(tag.tag_type)">
                  {{ tag.tag_type || 'manual' }}
                </span>
              </div>
              <button mat-icon-button
                      (click)="deleteTag(tag)"
                      class="delete-tag-button"
                      matTooltip="Remove tag">
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </div>

          <!-- Empty State -->
          <div class="tags-empty" *ngIf="tags.length === 0 && !isAddingTag">
            <mat-icon>label</mat-icon>
            <p>No tags yet. Click the + button to add tags.</p>
          </div>
        </mat-card>
      </div>
    </div>

    <!-- Analysis Section -->
    <div class="analysis-section" *ngIf="analysisSections.length > 0">
      <div class="analysis-header">
        <h2>
          <mat-icon>analytics</mat-icon>
          Analysis Sections ({{ analysisSections.length }})
        </h2>
      </div>
      <mat-chip-set class="analysis-meta" *ngIf="analysis">
          <mat-chip>
            <mat-icon>psychology</mat-icon>
            {{ analysis.ai_model }}
          </mat-chip>
          <mat-chip *ngIf="analysis.ai_provider">
            <mat-icon>cloud</mat-icon>
            {{ analysis.ai_provider }}
          </mat-chip>
          <mat-chip>
            <mat-icon>segment</mat-icon>
            {{ analysisSections.length }} sections
          </mat-chip>
        </mat-chip-set>

      <div class="analysis-sections-grid">
        <mat-card class="section-card" *ngFor="let section of analysisSections">
          <button mat-icon-button
                  class="delete-section-button"
                  (click)="deleteAnalysisSection(section)"
                  matTooltip="Delete this section">
            <mat-icon>close</mat-icon>
          </button>
          <div class="section-card-header">
            <div class="section-timestamp">
              <mat-icon>schedule</mat-icon>
              <span>{{ formatTimestamp(section.start_seconds) }}</span>
              <span *ngIf="section.end_seconds"> - {{ formatTimestamp(section.end_seconds) }}</span>
            </div>
            <span class="section-category"
                  [style.background-color]="getCategoryColor(section.category || 'General')"
                  *ngIf="section.category">
              {{ section.category }}
            </span>
          </div>
          <!-- Only show title if there's no description, or if they're different -->
          <h3 class="section-title" *ngIf="section.title && (!section.description || section.title !== section.description)">
            {{ section.title }}
          </h3>
          <!-- Show description, or title if no description exists -->
          <p class="section-description" *ngIf="section.description || section.title">
            {{ section.description || section.title }}
          </p>
        </mat-card>
      </div>
    </div>

    <!-- Transcript Section -->
    <div class="transcript-section" *ngIf="transcript">
      <div class="transcript-header">
        <h2>
          <mat-icon>subtitles</mat-icon>
          Transcript
        </h2>
        <div class="transcript-actions">
          <button mat-stroked-button (click)="copyTranscript(false)">
            <mat-icon>content_copy</mat-icon>
            Copy (No Timestamps)
          </button>
          <button mat-stroked-button (click)="copyTranscript(true)">
            <mat-icon>content_copy</mat-icon>
            Copy (With Timestamps)
          </button>
        </div>
      </div>
      <mat-chip-set class="transcript-meta">
        <mat-chip *ngIf="transcript.whisper_model">
          <mat-icon>mic</mat-icon>
          {{ transcript.whisper_model }}
        </mat-chip>
        <mat-chip *ngIf="transcript.language">
          <mat-icon>language</mat-icon>
          {{ transcript.language }}
          </mat-chip>
        <mat-chip>
          <mat-icon>schedule</mat-icon>
          {{ formatDate(transcript.transcribed_at) }}
        </mat-chip>
      </mat-chip-set>

      <mat-card class="transcript-card">
        <div class="transcript-content">
          <div class="transcript-entry" *ngFor="let entry of parsedTranscript">
            <span class="timestamp-badge">{{ entry.timestamp }}</span>
            <p class="transcript-text">{{ entry.text }}</p>
          </div>
        </div>
      </mat-card>
    </div>
  </div>
</div>
