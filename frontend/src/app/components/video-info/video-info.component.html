<div class="video-info-container">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Loading video information...</p>
  </div>

  <!-- Main Content with Split View -->
  <div *ngIf="!isLoading && video" class="split-container">
    <!-- Top Section: Video Info -->
    <div class="content-wrapper">
    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <button mat-icon-button (click)="goBack()" class="back-button">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <div class="title-container">
          <div *ngIf="!isEditingTitle" class="title-display">
            <h1 class="video-title">{{ video.filename }}</h1>
            <button mat-icon-button
                    (click)="startEditingTitle()"
                    class="edit-title-button"
                    matTooltip="Edit title">
              <mat-icon>edit</mat-icon>
            </button>
          </div>
          <div *ngIf="isEditingTitle" class="title-edit-container">
            <mat-form-field appearance="outline" class="title-input">
              <input matInput
                     [(ngModel)]="editedTitle"
                     (keydown)="onTitleKeydown($event)"
                     #titleInput
                     placeholder="Enter video title"
                     autofocus>
            </mat-form-field>
            <button mat-icon-button
                    (click)="saveTitle()"
                    color="primary"
                    matTooltip="Save">
              <mat-icon>check</mat-icon>
            </button>
            <button mat-icon-button
                    (click)="cancelEditingTitle()"
                    matTooltip="Cancel">
              <mat-icon>close</mat-icon>
            </button>
          </div>
        </div>
      </div>
      <div class="header-actions">
        <!-- Quick Navigation Buttons -->
        <div class="quick-nav-buttons">
          <button mat-stroked-button
                  (click)="scrollToAnalysis()"
                  *ngIf="analysisSections.length > 0"
                  matTooltip="Scroll to AI Analysis section">
            <mat-icon>analytics</mat-icon>
            Jump to Analysis
          </button>
          <button mat-stroked-button
                  (click)="scrollToTranscript()"
                  *ngIf="transcript"
                  matTooltip="Scroll to Transcript section">
            <mat-icon>subtitles</mat-icon>
            Jump to Transcript
          </button>
        </div>

        <!-- Main Action Buttons -->
        <button mat-raised-button color="primary" (click)="openClipCreator()" class="primary-action" *ngIf="canAnalyzeMedia()">
          <mat-icon>movie_filter</mat-icon>
          Clip Creator
        </button>
        <button mat-raised-button
                color="accent"
                (click)="runAnalysis()"
                *ngIf="canAnalyzeMedia()">
          <mat-icon>
            {{ analysis || transcript ? 'refresh' : 'psychology' }}
          </mat-icon>
          {{ analysis || transcript ? 'Re-analyze' : 'Analyze' }}
        </button>
      </div>
    </div>

    <!-- Two Column Layout: Video+Description on left, Metadata on right -->
    <div class="video-metadata-grid">
      <!-- Left Column: Media and AI Description -->
      <div class="video-column">
        <!-- Video Preview -->
        <div class="video-preview" *ngIf="video.media_type === 'video'">
          <video #videoPlayer
                 [src]="videoUrl"
                 controls
                 preload="metadata"
                 class="video-player"
                 (error)="onVideoError($event)"
                 (loadedmetadata)="onVideoLoaded()"
                 *ngIf="videoUrl">
            Your browser does not support the video tag.
          </video>
          <div class="no-video" *ngIf="!videoUrl">
            <mat-icon>movie</mat-icon>
            <p>Loading video...</p>
          </div>
          <div class="video-error" *ngIf="videoError">
            <mat-icon>error</mat-icon>
            <p>{{ videoError }}</p>
          </div>
        </div>

        <!-- Audio Preview -->
        <div class="audio-preview" *ngIf="video.media_type === 'audio'">
          <div class="audio-container">
            <mat-icon class="audio-icon">audiotrack</mat-icon>
            <audio [src]="videoUrl"
                   controls
                   preload="metadata"
                   class="audio-player"
                   (error)="onVideoError($event)"
                   (loadedmetadata)="onVideoLoaded()"
                   *ngIf="videoUrl">
              Your browser does not support the audio tag.
            </audio>
            <div class="no-video" *ngIf="!videoUrl">
              <mat-icon>audiotrack</mat-icon>
              <p>Loading audio...</p>
            </div>
            <div class="video-error" *ngIf="videoError">
              <mat-icon>error</mat-icon>
              <p>{{ videoError }}</p>
            </div>
          </div>
        </div>

        <!-- Image Preview -->
        <div class="image-preview" *ngIf="video.media_type === 'image'">
          <img [src]="videoUrl"
               [alt]="video.filename"
               class="image-viewer"
               (error)="onVideoError($event)"
               (load)="onVideoLoaded()"
               *ngIf="videoUrl">
          <div class="no-video" *ngIf="!videoUrl">
            <mat-icon>image</mat-icon>
            <p>Loading image...</p>
          </div>
          <div class="video-error" *ngIf="videoError">
            <mat-icon>error</mat-icon>
            <p>{{ videoError }}</p>
          </div>
        </div>

        <!-- Other Media Types (Document, Webpage) -->
        <div class="other-media-preview" *ngIf="video.media_type !== 'video' && video.media_type !== 'audio' && video.media_type !== 'image'">
          <div class="media-type-display">
            <mat-icon>{{ getMediaTypeIcon(video.media_type) }}</mat-icon>
            <h3>{{ getMediaTypeLabel(video.media_type) }}</h3>
            <p class="media-filename">{{ video.filename }}</p>
            <button mat-raised-button color="primary" (click)="openFileLocation()" *ngIf="video.current_path">
              <mat-icon>folder_open</mat-icon>
              Open File Location
            </button>
          </div>
        </div>

        <!-- AI Description (Under Video) -->
        <div class="ai-description-main" *ngIf="video?.ai_description">
          <mat-card class="ai-description-card">
            <h3>
              <mat-icon>description</mat-icon>
              AI Description
            </h3>
            <p>{{ video.ai_description }}</p>
          </mat-card>
        </div>
      </div>

      <!-- Right Column: Metadata -->
      <div class="metadata-column">
        <h2>Metadata</h2>
        <mat-card class="metadata-card">
          <!-- Primary Info Grid (2 columns) -->
          <div class="metadata-grid-primary">
            <div class="metadata-item">
              <mat-icon>schedule</mat-icon>
              <div class="metadata-content">
                <span class="metadata-label">Duration</span>
                <span class="metadata-value">{{ formatDuration(video.duration_seconds) }}</span>
              </div>
            </div>

            <div class="metadata-item">
              <mat-icon>storage</mat-icon>
              <div class="metadata-content">
                <span class="metadata-label">File Size</span>
                <span class="metadata-value">{{ formatFileSize(video.file_size_bytes) }}</span>
              </div>
            </div>

            <div class="metadata-item" *ngIf="video.upload_date">
              <mat-icon>upload</mat-icon>
              <div class="metadata-content">
                <span class="metadata-label">Upload Date</span>
                <span class="metadata-value">{{ formatDate(video.upload_date) }}</span>
              </div>
            </div>

            <div class="metadata-item" *ngIf="video.download_date">
              <mat-icon>download</mat-icon>
              <div class="metadata-content">
                <span class="metadata-label">Downloaded</span>
                <span class="metadata-value">{{ formatDate(video.download_date) }}</span>
              </div>
            </div>

            <div class="metadata-item">
              <mat-icon>update</mat-icon>
              <div class="metadata-content">
                <span class="metadata-label">Added</span>
                <span class="metadata-value">{{ formatDate(video.added_at) }}</span>
              </div>
            </div>
          </div>

          <!-- Path Section (Full Width) -->
          <mat-divider></mat-divider>

          <div class="metadata-path-section">
            <div class="metadata-item">
              <mat-icon>folder</mat-icon>
              <div class="metadata-content">
                <span class="metadata-label">File Path</span>
                <span class="metadata-value path">{{ video.current_path }}</span>
              </div>
            </div>
          </div>
        </mat-card>

        <!-- Tags Section -->
        <h2 class="tags-header">
          Tags
          <button mat-icon-button
                  (click)="startAddingTag()"
                  class="add-tag-button"
                  matTooltip="Add tag">
            <mat-icon>add</mat-icon>
          </button>
        </h2>
        <mat-card class="tags-card">
          <!-- Tag Input -->
          <div *ngIf="isAddingTag" class="tag-input-container">
            <mat-form-field appearance="outline" class="tag-name-input">
              <mat-label>Tag Names (comma-separated)</mat-label>
              <input matInput
                     [(ngModel)]="newTagName"
                     (keydown)="onTagKeydown($event)"
                     placeholder="e.g. politics, debate, election"
                     autofocus>
            </mat-form-field>
            <mat-form-field appearance="outline" class="tag-type-select">
              <mat-label>Type</mat-label>
              <select matNativeControl [(ngModel)]="newTagType">
                <option value="manual">Manual</option>
                <option value="person">Person</option>
                <option value="topic">Topic</option>
                <option value="other">Other</option>
              </select>
            </mat-form-field>
            <button mat-icon-button
                    (click)="saveTags()"
                    color="primary"
                    matTooltip="Save tags">
              <mat-icon>check</mat-icon>
            </button>
            <button mat-icon-button
                    (click)="cancelAddingTag()"
                    matTooltip="Cancel">
              <mat-icon>close</mat-icon>
            </button>
          </div>

          <!-- Tags Display -->
          <div class="tags-list" *ngIf="tags.length > 0">
            <div class="tag-chip" *ngFor="let tag of tags"
                 [style.border-color]="getTagTypeColor(tag.tag_type)">
              <div class="tag-info">
                <span class="tag-name">{{ tag.tag_name }}</span>
                <span class="tag-type" [style.color]="getTagTypeColor(tag.tag_type)">
                  {{ tag.tag_type || 'manual' }}
                </span>
              </div>
              <button mat-icon-button
                      (click)="deleteTag(tag)"
                      class="delete-tag-button"
                      matTooltip="Remove tag">
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </div>

          <!-- Empty State -->
          <div class="tags-empty" *ngIf="tags.length === 0 && !isAddingTag">
            <mat-icon>label</mat-icon>
            <p>No tags yet. Click the + button to add tags.</p>
          </div>
        </mat-card>
      </div>
    </div>

    <!-- Linked Files Section -->
    <div class="linked-files-section" *ngIf="canBeParent()">
      <h2>
        <mat-icon>link</mat-icon>
        Linked Files
        <span class="file-count" *ngIf="childVideos.length > 0">({{ childVideos.length }})</span>
      </h2>

      <!-- Drop Zone -->
      <mat-card class="drop-zone-card"
                [class.dragging]="isDraggingFiles"
                (dragenter)="onDragEnter($event)"
                (dragover)="onDragOver($event)"
                (dragleave)="onDragLeave($event)"
                (drop)="onDrop($event)">

        <div class="drop-zone-content" *ngIf="!isDraggingFiles">
          <mat-icon class="drop-zone-icon">cloud_upload</mat-icon>
          <h3>Link Related Files</h3>
          <p>Drag and drop files here to link them to this item, or</p>
          <div class="drop-zone-buttons">
            <button mat-raised-button color="primary" (click)="openFilePicker()">
              <mat-icon>folder_open</mat-icon>
              Choose Files
            </button>
            <button mat-raised-button color="accent" (click)="openLibraryPicker()">
              <mat-icon>video_library</mat-icon>
              Choose from Library
            </button>
          </div>
          <p class="help-text">
            Link related files like audiobooks with PDFs, or clips with full videos.
            <br>Files will be added to your library if they're not already imported.
          </p>
        </div>

        <div class="drop-zone-active" *ngIf="isDraggingFiles">
          <mat-icon class="drop-icon">file_download</mat-icon>
          <h3>Drop files to link them</h3>
        </div>
      </mat-card>

      <!-- Linked Children List -->
      <div class="linked-children-list" *ngIf="childVideos.length > 0">
        <app-item-list
          [items]="childVideos"
          [displayConfig]="childListDisplayConfig"
          [selectionMode]="SelectionMode.Multiple"
          [contextMenuActions]="childListContextMenuActions"
          (itemClick)="onChildItemClick($event)"
          (itemDoubleClick)="onChildItemDoubleClick($event)"
          (contextMenuAction)="onChildContextMenuAction($event)">

          <!-- Custom action template for unlink button -->
          <ng-template #itemActions let-child>
            <button mat-icon-button
                    (click)="removeChild(child); $event.stopPropagation()"
                    matTooltip="Unlink file"
                    class="unlink-button">
              <mat-icon>close</mat-icon>
            </button>
          </ng-template>
        </app-item-list>
      </div>
    </div>

    <!-- Warning for child items -->
    <div class="child-warning" *ngIf="!canBeParent() && video?.parent_id">
      <mat-card class="warning-card">
        <mat-icon>info</mat-icon>
        <p>This file is linked to another item. Only root-level items can have linked files.</p>
      </mat-card>
    </div>

    <!-- Analysis Section -->
    <div class="analysis-section" *ngIf="analysisSections.length > 0" #analysisSection>
      <div class="analysis-header">
        <h2>
          <mat-icon>analytics</mat-icon>
          Analysis Sections ({{ analysisSections.length }})
        </h2>
      </div>
      <mat-chip-set class="analysis-meta" *ngIf="analysis">
          <mat-chip>
            <mat-icon>psychology</mat-icon>
            {{ analysis.ai_model }}
          </mat-chip>
          <mat-chip *ngIf="analysis.ai_provider">
            <mat-icon>cloud</mat-icon>
            {{ analysis.ai_provider }}
          </mat-chip>
          <mat-chip>
            <mat-icon>segment</mat-icon>
            {{ analysisSections.length }} sections
          </mat-chip>
        </mat-chip-set>

      <div class="analysis-sections-grid">
        <mat-card class="section-card" *ngFor="let section of analysisSections">
          <button mat-icon-button
                  class="delete-section-button"
                  (click)="deleteAnalysisSection(section)"
                  matTooltip="Delete this section">
            <mat-icon>close</mat-icon>
          </button>
          <div class="section-card-header">
            <div class="section-timestamp">
              <mat-icon>schedule</mat-icon>
              <span>{{ formatTimestamp(section.start_seconds) }}</span>
              <span *ngIf="section.end_seconds"> - {{ formatTimestamp(section.end_seconds) }}</span>
            </div>
            <span class="section-category"
                  [style.background-color]="getCategoryColor(section.category || 'General')"
                  *ngIf="section.category">
              {{ section.category }}
            </span>
          </div>
          <!-- Only show title if there's no description, or if they're different -->
          <h3 class="section-title" *ngIf="section.title && (!section.description || section.title !== section.description)">
            {{ section.title }}
          </h3>
          <!-- Show description, or title if no description exists -->
          <p class="section-description" *ngIf="section.description || section.title">
            {{ section.description || section.title }}
          </p>
        </mat-card>
      </div>
    </div>

    <!-- Transcript Section -->
    <div class="transcript-section" *ngIf="transcript" #transcriptSection>
      <div class="transcript-header">
        <h2>
          <mat-icon>subtitles</mat-icon>
          Transcript
        </h2>
        <div class="transcript-actions">
          <button mat-stroked-button (click)="toggleSearchPanel($event)" [class.active]="isSearchPanelOpen">
            <mat-icon>search</mat-icon>
            {{ isSearchPanelOpen ? 'Close Search' : 'Search' }}
          </button>
          <button mat-stroked-button (click)="copyTranscript(false)">
            <mat-icon>content_copy</mat-icon>
            Copy (No Timestamps)
          </button>
          <button mat-stroked-button (click)="copyTranscript(true)">
            <mat-icon>content_copy</mat-icon>
            Copy (With Timestamps)
          </button>
        </div>
      </div>
      <mat-chip-set class="transcript-meta">
        <mat-chip *ngIf="transcript.whisper_model">
          <mat-icon>mic</mat-icon>
          {{ transcript.whisper_model }}
        </mat-chip>
        <mat-chip *ngIf="transcript.language">
          <mat-icon>language</mat-icon>
          {{ transcript.language }}
          </mat-chip>
        <mat-chip>
          <mat-icon>schedule</mat-icon>
          {{ formatDate(transcript.transcribed_at) }}
        </mat-chip>
      </mat-chip-set>

      <!-- Transcript Content with Search Panel -->
      <mat-card class="transcript-card">
        <div class="transcript-content" #transcriptContainer>
          <div class="transcript-entry" *ngFor="let entry of parsedTranscript">
            <span class="timestamp-badge">{{ entry.timestamp }}</span>
            <p class="transcript-text">{{ entry.text }}</p>
          </div>
        </div>
      </mat-card>
    </div>
  </div>

  <!-- Floating Search Panel (outside of main content, position: fixed) -->
  <div
    class="floating-search-panel"
    *ngIf="isSearchPanelOpen"
    [style.left.px]="searchPanelX"
    [style.top.px]="searchPanelY"
    [style.width.px]="searchPanelWidth"
    [class.dragging]="isDraggingSearchPanel"
    [class.resizing]="isResizingSearchPanel"
    (keydown)="onSearchPanelKeyDown($event)">

    <!-- Drag Handle -->
    <div class="search-panel-header" (mousedown)="startDragSearchPanel($event)">
      <mat-icon class="drag-icon">drag_indicator</mat-icon>
      <span class="panel-title">Search Transcript</span>
      <button mat-icon-button class="close-panel-btn" (click)="isSearchPanelOpen = false" (mousedown)="$event.stopPropagation()">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <!-- Resize Handle -->
    <div class="search-panel-resize-handle" (mousedown)="startResizeSearchPanel($event)"></div>

    <!-- Search Content -->
    <div class="search-panel-content">
      <app-transcript-search
        [transcriptText]="transcript ? transcript.srt_format : null"
        [transcriptExists]="!!transcript"
        (seekToTime)="onSeekToTimestamp($event)">
      </app-transcript-search>
    </div>
  </div>

  <!-- Library Picker Modal -->
  <div class="library-picker-modal" *ngIf="isLibraryPickerOpen" (click)="closeLibraryPicker()">
    <div class="library-picker-content" (click)="$event.stopPropagation()">
      <div class="library-picker-header">
        <h2>
          <mat-icon>video_library</mat-icon>
          Choose Videos from Library
        </h2>
        <button mat-icon-button (click)="closeLibraryPicker()">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="library-picker-body">
        <cascade-list
          [items]="availableLibraryVideos"
          [displayConfig]="libraryPickerDisplayConfig"
          [selectionMode]="SelectionMode.Multiple"
          [emptyMessage]="'No videos available to link'"
          [emptyIcon]="'video_library'"
          (itemsSelected)="onLibraryVideosSelected($any($event))"
          (itemsDeselected)="onLibraryVideosDeselected($any($event))"
          (itemDoubleClick)="linkSelectedLibraryVideos([$any($event)])">
        </cascade-list>
      </div>

      <div class="library-picker-footer">
        <button mat-stroked-button (click)="closeLibraryPicker()">Cancel</button>
        <button mat-raised-button color="primary"
                (click)="linkSelectedLibraryVideos()"
                [disabled]="selectedLibraryVideos.size === 0">
          Link {{ selectedLibraryVideos.size > 0 ? selectedLibraryVideos.size : '' }}
          {{ selectedLibraryVideos.size === 1 ? 'Video' : 'Videos' }}
        </button>
      </div>
    </div>
  </div>
</div>
