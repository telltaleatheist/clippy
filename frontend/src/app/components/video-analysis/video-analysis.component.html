<div class="analysis-container">
  <!-- Header -->
  <div class="page-header">
    <h1>
      <mat-icon>psychology</mat-icon>
      AI Video Analysis
    </h1>
    <p class="header-subtitle">Automatically transcribe and analyze your videos with artificial intelligence</p>
  </div>

  <!-- Main Layout - Two Column -->
  <div class="main-layout">
    <!-- Left Column: Configuration -->
    <div class="config-column">
      <form [formGroup]="analysisForm" (ngSubmit)="onSubmit()" class="analysis-form">

        <!-- Step 1: Video Source -->
        <div class="form-step">
          <div class="step-content">
            <h3 class="step-title">Choose Video Source</h3>

            <!-- Source Type Toggle -->
            <div class="source-toggle">
              <button type="button"
                      class="toggle-option"
                      [class.active]="analysisForm.get('inputType')?.value === 'url'"
                      (click)="analysisForm.patchValue({inputType: 'url'})">
                <mat-icon>link</mat-icon>
                <div class="option-text">
                  <span class="option-title">URL</span>
                  <span class="option-subtitle">YouTube, Vimeo, etc.</span>
                </div>
              </button>
              <button type="button"
                      class="toggle-option"
                      [class.active]="analysisForm.get('inputType')?.value === 'file'"
                      (click)="analysisForm.patchValue({inputType: 'file'})">
                <mat-icon>video_file</mat-icon>
                <div class="option-text">
                  <span class="option-title">Local File</span>
                  <span class="option-subtitle">MP4, MOV, AVI, etc.</span>
                </div>
              </button>
            </div>

            <!-- URL Input -->
            <ng-container *ngIf="analysisForm.get('inputType')?.value === 'url'">
              <div class="input-wrapper">
                <mat-icon class="input-icon">link</mat-icon>
                <input type="text"
                       class="modern-input"
                       placeholder="Paste video URL (e.g., https://youtube.com/watch?v=...)"
                       formControlName="input">
                <button type="button"
                        mat-icon-button
                        class="paste-btn"
                        (click)="pasteFromClipboard()"
                        matTooltip="Paste from clipboard">
                  <mat-icon>content_paste</mat-icon>
                </button>
              </div>
            </ng-container>

            <!-- Local File Input with Drop Zone -->
            <ng-container *ngIf="analysisForm.get('inputType')?.value === 'file'">
              <!-- File Selected State -->
              <div class="file-selected" *ngIf="analysisForm.get('input')?.value">
                <div class="file-icon">
                  <mat-icon>movie</mat-icon>
                </div>
                <div class="file-details">
                  <div class="file-name">{{ analysisForm.get('input')?.value | slice:-50 }}</div>
                  <div class="file-path">{{ analysisForm.get('input')?.value }}</div>
                </div>
                <button type="button"
                        mat-icon-button
                        class="remove-btn"
                        (click)="analysisForm.patchValue({input: ''})"
                        matTooltip="Remove file">
                  <mat-icon>close</mat-icon>
                </button>
              </div>

              <!-- Drop Zone (shown when no file selected) -->
              <div class="drop-zone"
                   *ngIf="!analysisForm.get('input')?.value"
                   (dragover)="onFileDragOver($event)"
                   (dragleave)="onFileDragLeave($event)"
                   (drop)="onFileDrop($event)"
                   [class.dragging]="isDraggingFile">
                <div class="drop-icon">
                  <mat-icon>cloud_upload</mat-icon>
                </div>
                <h4>Drag & drop your video here</h4>
                <span class="or-text">or</span>
                <button type="button"
                        mat-raised-button
                        color="primary"
                        (click)="browseFile()">
                  <mat-icon>folder_open</mat-icon>
                  Browse Files
                </button>
                <p class="formats">MP4, MOV, AVI, MKV, WebM supported</p>
              </div>
            </ng-container>
          </div>
        </div>

        <!-- Step 2: Processing Mode Selection -->
        <div class="form-step">
          <div class="step-content">
            <h3 class="step-title">Choose Processing Mode</h3>

            <!-- Mode Toggle -->
            <div class="mode-toggle">
              <button type="button"
                      class="toggle-option"
                      [class.active]="analysisForm.get('mode')?.value === 'full'"
                      (click)="analysisForm.patchValue({mode: 'full'})">
                <mat-icon>psychology</mat-icon>
                <div class="option-text">
                  <span class="option-title">Transcribe + AI Analysis</span>
                  <span class="option-subtitle">Full processing with AI insights</span>
                </div>
              </button>
              <button type="button"
                      class="toggle-option"
                      [class.active]="analysisForm.get('mode')?.value === 'transcribe-only'"
                      (click)="analysisForm.patchValue({mode: 'transcribe-only'})">
                <mat-icon>subtitles</mat-icon>
                <div class="option-text">
                  <span class="option-title">Transcribe Only</span>
                  <span class="option-subtitle">Generate transcript without AI</span>
                </div>
              </button>
            </div>
          </div>
        </div>

        <!-- Step 3: AI Configuration (Only shown if mode is 'full') -->
        <div class="form-step" *ngIf="isAIAnalysisEnabled()">
          <div class="step-content">
            <h3 class="step-title">Configure AI Settings</h3>

            <!-- AI Model Selection -->
            <div class="setting-group">
              <label class="setting-label">
                <mat-icon>psychology</mat-icon>
                AI Model
              </label>
              <select class="modern-select" formControlName="aiModel" (change)="onModelChange()">
                <optgroup label="Claude (API Key Required)">
                  <option value="claude:claude-sonnet-4-20250514">Claude Sonnet 4.5 - Newest & Most Capable</option>
                  <option value="claude:claude-3-5-sonnet-20241022">Claude 3.5 Sonnet - Recommended</option>
                  <option value="claude:claude-3-5-haiku-20241022">Claude 3.5 Haiku - Faster & Cheaper</option>
                </optgroup>
                <optgroup label="ChatGPT / OpenAI (API Key Required)">
                  <option value="openai:gpt-4o">GPT-4o - Best Performance</option>
                  <option value="openai:gpt-4-turbo">GPT-4 Turbo - Balanced</option>
                  <option value="openai:gpt-3.5-turbo">GPT-3.5 Turbo - Budget Friendly</option>
                </optgroup>
                <optgroup label="Ollama (Local - Free)">
                  <option *ngIf="availableOllamaModels.length === 0" value="" disabled>No Ollama models installed</option>
                  <option *ngFor="let model of availableOllamaModels" [value]="'ollama:' + model">{{ model }}</option>
                </optgroup>
              </select>
            </div>

            <!-- API Key (for Claude/OpenAI) -->
            <div class="setting-group" *ngIf="needsApiKey()">
              <label class="setting-label">
                <mat-icon>vpn_key</mat-icon>
                {{ getApiKeyLabel() }}
              </label>
              <div class="input-wrapper">
                <mat-icon class="input-icon">lock</mat-icon>
                <input type="password"
                       class="modern-input"
                       formControlName="apiKey"
                       [placeholder]="'Enter your ' + getApiKeyLabel()">
              </div>
            </div>

            <!-- Ollama Endpoint (for local models) -->
            <div class="setting-group" *ngIf="!needsApiKey()">
              <label class="setting-label">
                <mat-icon>dns</mat-icon>
                Ollama Endpoint
              </label>
              <div class="input-wrapper">
                <mat-icon class="input-icon">computer</mat-icon>
                <input type="text"
                       class="modern-input"
                       formControlName="ollamaEndpoint"
                       placeholder="http://localhost:11434">
              </div>
            </div>
          </div>
        </div>

        <!-- Step 4: Transcription Settings -->
        <div class="form-step">
          <div class="step-content">
            <h3 class="step-title">Transcription Settings</h3>

            <div class="settings-row">
              <div class="setting-group">
                <label class="setting-label">
                  <mat-icon>mic</mat-icon>
                  Whisper Model
                </label>
                <select class="modern-select" formControlName="whisperModel">
                  <option value="tiny">Tiny - Fastest</option>
                  <option value="base">Base - Balanced</option>
                  <option value="small">Small - Better Quality</option>
                  <option value="medium">Medium - Great Quality</option>
                  <option value="large">Large - Best Quality</option>
                </select>
              </div>

              <div class="setting-group">
                <label class="setting-label">
                  <mat-icon>language</mat-icon>
                  Language
                </label>
                <input type="text"
                       class="modern-input"
                       formControlName="language"
                       placeholder="en">
              </div>
            </div>
          </div>
        </div>

        <!-- Step 5: Custom Instructions (Optional, only for AI analysis) -->
        <div class="form-step optional-step" *ngIf="isAIAnalysisEnabled()">
          <div class="step-content">
            <div class="step-title-row">
              <h3 class="step-title">Custom Instructions</h3>
              <span class="optional-badge">Optional</span>
            </div>

            <div class="setting-group">
              <textarea class="modern-textarea"
                        formControlName="customInstructions"
                        rows="6"
                        placeholder="Add specific instructions for the AI analysis...&#10;&#10;Examples:&#10;• Focus on technical discussions&#10;• Identify key quotes and timestamps&#10;• Look for mentions of specific topics"></textarea>
              <span class="hint-text">
                <mat-icon>info</mat-icon>
                Provide context or specific things to look for in the analysis
              </span>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
          <button type="button"
                  mat-stroked-button
                  class="secondary-btn"
                  (click)="saveSettings()">
            <mat-icon>bookmark</mat-icon>
            Save Settings
          </button>
          <button type="submit"
                  mat-raised-button
                  class="primary-btn"
                  [disabled]="isProcessing || analysisForm.invalid">
            <mat-icon>play_circle</mat-icon>
            <span>{{ isProcessing ? 'Processing...' : 'Start Analysis' }}</span>
          </button>
        </div>
      </form>
    </div>

    <!-- Right Column: Activity & Library -->
    <div class="activity-column">

      <!-- Processing Queue -->
      <div class="activity-section" *ngIf="processingJobs.length > 0 || currentJob">
        <div class="section-header">
          <h3>
            <mat-icon>hourglass_empty</mat-icon>
            Processing Queue
          </h3>
          <div class="queue-badges">
            <span class="badge active" *ngIf="getActiveJobs().length > 0">
              {{ getActiveJobs().length }} active
            </span>
            <span class="badge complete" *ngIf="getCompletedJobs().length > 0">
              {{ getCompletedJobs().length }} done
            </span>
          </div>
        </div>

        <!-- Active Jobs -->
        <div class="jobs-container">
          <div class="job-card active"
               *ngFor="let job of getActiveJobs()">
            <div class="job-status-indicator"></div>
            <div class="job-icon">
              <mat-icon [class.spinning]="job.stage !== 'completed' && job.stage !== 'failed'">
                {{ getJobStatusIcon(job.stage) }}
              </mat-icon>
            </div>
            <div class="job-info">
              <div class="job-name">{{ job.filename || job.url || 'Processing...' }}</div>
              <div class="job-status">{{ getJobStatusText(job) }}</div>
              <div class="job-progress" *ngIf="job.progress !== undefined && job.stage !== 'completed' && job.stage !== 'failed'">
                <div class="progress-track">
                  <div class="progress-fill" [style.width.%]="job.progress || 0"></div>
                </div>
                <span class="progress-text">{{ job.progress }}%</span>
              </div>
            </div>
          </div>

          <!-- Current Job (legacy) -->
          <div class="job-card active" *ngIf="currentJob && currentJob.status !== 'completed' && currentJob.status !== 'failed'">
            <div class="job-status-indicator"></div>
            <div class="job-icon">
              <mat-icon [class.spinning]="currentJob.status !== 'completed' && currentJob.status !== 'failed'">
                {{ getStatusIcon() }}
              </mat-icon>
            </div>
            <div class="job-info">
              <div class="job-name">{{ currentJob.input ? (currentJob.input.length > 40 ? '...' + currentJob.input.slice(-40) : currentJob.input) : 'Video Analysis' }}</div>
              <div class="job-status">{{ currentJob.currentPhase || currentJob.status }}</div>
              <div class="job-progress" *ngIf="currentJob.progress !== undefined">
                <div class="progress-track">
                  <div class="progress-fill" [style.width.%]="currentJob.progress || 0"></div>
                </div>
                <span class="progress-text">{{ currentJob.progress }}%</span>
              </div>
            </div>
          </div>

          <!-- Completed Job with Actions -->
          <div class="job-card completed" *ngIf="currentJob && currentJob.status === 'completed'">
            <div class="job-status-indicator success"></div>
            <div class="job-icon">
              <mat-icon>check_circle</mat-icon>
            </div>
            <div class="job-info">
              <div class="job-name">{{ currentJob.input ? (currentJob.input.length > 40 ? '...' + currentJob.input.slice(-40) : currentJob.input) : 'Video Analysis' }}</div>
              <div class="job-status success">Completed successfully</div>
              <div class="job-actions">
                <button mat-button
                        *ngIf="currentJob.analysisPath"
                        (click)="openAnalysisFile()"
                        class="action-btn">
                  <mat-icon>description</mat-icon>
                  View Analysis
                </button>
                <button mat-button
                        *ngIf="currentJob.transcriptPath"
                        (click)="openTranscriptFile()"
                        class="action-btn">
                  <mat-icon>subtitles</mat-icon>
                  View Transcript
                </button>
              </div>
            </div>
          </div>

          <!-- Failed Job -->
          <div class="job-card failed" *ngIf="currentJob && currentJob.status === 'failed'">
            <div class="job-status-indicator error"></div>
            <div class="job-icon">
              <mat-icon>error</mat-icon>
            </div>
            <div class="job-info">
              <div class="job-name">{{ currentJob.input ? (currentJob.input.length > 40 ? '...' + currentJob.input.slice(-40) : currentJob.input) : 'Video Analysis' }}</div>
              <div class="job-status error">Failed</div>
              <div class="error-message" *ngIf="currentJob.error">
                <mat-icon>warning</mat-icon>
                {{ currentJob.error }}
              </div>
            </div>
          </div>

          <!-- Completed Jobs from Queue -->
          <div class="job-card"
               *ngFor="let job of getCompletedJobs()"
               [class.completed]="job.stage === 'completed'"
               [class.failed]="job.stage === 'failed'">
            <div class="job-status-indicator" [class.success]="job.stage === 'completed'" [class.error]="job.stage === 'failed'"></div>
            <div class="job-icon">
              <mat-icon>{{ getJobStatusIcon(job.stage) }}</mat-icon>
            </div>
            <div class="job-info">
              <div class="job-name">{{ job.filename || job.url || 'Unknown' }}</div>
              <div class="job-status" [class.success]="job.stage === 'completed'" [class.error]="job.stage === 'failed'">
                {{ getJobStatusText(job) }}
                <span *ngIf="job.completedAt"> • {{ getRelativeTime(job.completedAt) }}</span>
              </div>
              <div class="error-message" *ngIf="job.error">
                <mat-icon>warning</mat-icon>
                {{ job.error }}
              </div>
            </div>
          </div>
        </div>

        <!-- Clear Completed Button -->
        <button mat-stroked-button
                *ngIf="getCompletedJobs().length > 0"
                (click)="clearCompleted()"
                class="clear-completed-btn">
          <mat-icon>clear_all</mat-icon>
          Clear Completed ({{ getCompletedJobs().length }})
        </button>
      </div>

      <!-- Video Library Section -->
      <div class="library-section">
        <div class="section-header">
          <h3>
            <mat-icon>video_library</mat-icon>
            Quick Select
          </h3>
        </div>

        <!-- Search -->
        <div class="library-search-wrapper">
          <mat-icon>search</mat-icon>
          <input type="text"
                 class="library-search"
                 [(ngModel)]="librarySearchQuery"
                 [ngModelOptions]="{standalone: true}"
                 (ngModelChange)="onLibrarySearchChange()"
                 placeholder="Search your library...">
        </div>

        <!-- Loading -->
        <div class="library-loading" *ngIf="isLoadingLibrary">
          <mat-icon class="spinning">sync</mat-icon>
          <span>Loading videos...</span>
        </div>

        <!-- Video List -->
        <div class="library-list" *ngIf="!isLoadingLibrary && filteredLibraryVideos.length > 0">
          <div class="library-item"
               *ngFor="let video of filteredLibraryVideos"
               (click)="selectLibraryVideo(video)">
            <div class="item-icon">
              <mat-icon>movie</mat-icon>
            </div>
            <div class="item-details">
              <div class="item-name">{{ video.filename }}</div>
              <div class="item-meta">
                <span *ngIf="video.duration_seconds">{{ formatDuration(video.duration_seconds) }}</span>
                <span *ngIf="video.file_size_bytes"> • {{ formatFileSize(video.file_size_bytes) }}</span>
              </div>
            </div>
            <mat-icon class="select-icon">chevron_right</mat-icon>
          </div>
        </div>

        <!-- Empty States -->
        <div class="library-empty" *ngIf="!isLoadingLibrary && filteredLibraryVideos.length === 0">
          <mat-icon>{{ libraryVideos.length === 0 ? 'video_library' : 'search_off' }}</mat-icon>
          <p>{{ libraryVideos.length === 0 ? 'No videos in library' : 'No results found' }}</p>
        </div>
      </div>
    </div>
  </div>
</div>
