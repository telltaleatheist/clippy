<div class="analysis-container">
  <!-- Header -->
  <div class="page-header">
    <h1>
      <mat-icon>psychology</mat-icon>
      Video Analysis
    </h1>
    <p class="header-subtitle">Automatically transcribe and analyze your videos with artificial intelligence</p>
  </div>

  <!-- Main Layout - Two Column -->
  <div class="main-layout" [class.resizing]="isResizing">
    <!-- Left Column: Configuration (30%) -->
    <div class="config-column">
      <form [formGroup]="analysisForm" (ngSubmit)="onSubmit()" class="analysis-form">

        <!-- Step 1: Video Source -->
        <div class="form-step">
          <div class="step-content">
            <h3 class="step-title">Choose Video Source</h3>

            <!-- Source Type Toggle -->
            <div class="source-toggle">
              <button type="button"
                      class="toggle-option"
                      [class.active]="analysisForm.get('inputType')?.value === 'url'"
                      (click)="analysisForm.patchValue({inputType: 'url'})">
                <mat-icon>link</mat-icon>
                <div class="option-text">
                  <span class="option-title">URL</span>
                  <span class="option-subtitle">YouTube, Vimeo, etc.</span>
                </div>
              </button>
              <button type="button"
                      class="toggle-option"
                      [class.active]="analysisForm.get('inputType')?.value === 'file'"
                      (click)="analysisForm.patchValue({inputType: 'file'})">
                <mat-icon>video_file</mat-icon>
                <div class="option-text">
                  <span class="option-title">Local File</span>
                  <span class="option-subtitle">MP4, MOV, AVI, etc.</span>
                </div>
              </button>
            </div>

            <!-- URL Input -->
            <ng-container *ngIf="analysisForm.get('inputType')?.value === 'url'">
              <div class="input-wrapper">
                <mat-icon class="input-icon">link</mat-icon>
                <input type="text"
                       class="modern-input"
                       placeholder="Paste video URL (e.g., https://youtube.com/watch?v=...)"
                       formControlName="input">
                <button type="button"
                        mat-icon-button
                        class="paste-btn"
                        (click)="pasteFromClipboard()"
                        matTooltip="Paste from clipboard">
                  <mat-icon>content_paste</mat-icon>
                </button>
              </div>
            </ng-container>

            <!-- Local File Input with Drop Zone -->
            <ng-container *ngIf="analysisForm.get('inputType')?.value === 'file'">
              <!-- File Selected State -->
              <div class="file-selected" *ngIf="analysisForm.get('input')?.value">
                <div class="file-icon">
                  <mat-icon>movie</mat-icon>
                </div>
                <div class="file-details">
                  <div class="file-name">{{ analysisForm.get('input')?.value | slice:-50 }}</div>
                  <div class="file-path">{{ analysisForm.get('input')?.value }}</div>
                </div>
                <button type="button"
                        mat-icon-button
                        class="remove-btn"
                        (click)="analysisForm.patchValue({input: ''})"
                        matTooltip="Remove file">
                  <mat-icon>close</mat-icon>
                </button>
              </div>

              <!-- Drop Zone (shown when no file selected) -->
              <div class="drop-zone"
                   *ngIf="!analysisForm.get('input')?.value"
                   (dragover)="onFileDragOver($event)"
                   (dragleave)="onFileDragLeave($event)"
                   (drop)="onFileDrop($event)"
                   [class.dragging]="isDraggingFile">
                <div class="drop-icon">
                  <mat-icon>cloud_upload</mat-icon>
                </div>
                <h4>Drag & drop your video here</h4>
                <span class="or-text">or</span>
                <button type="button"
                        mat-raised-button
                        color="primary"
                        (click)="browseFile()">
                  <mat-icon>folder_open</mat-icon>
                  Browse Files
                </button>
                <p class="formats">MP4, MOV, AVI, MKV, WebM supported</p>
              </div>
            </ng-container>
          </div>
        </div>

        <!-- Step 2: Processing Mode Selection -->
        <div class="form-step">
          <div class="step-content">
            <h3 class="step-title">Choose Processing Mode</h3>

            <!-- Mode Toggle -->
            <div class="mode-toggle">
              <button type="button"
                      class="toggle-option"
                      [class.active]="analysisForm.get('mode')?.value === 'full'"
                      (click)="analysisForm.patchValue({mode: 'full'})">
                <mat-icon>psychology</mat-icon>
                <div class="option-text">
                  <span class="option-title">Transcribe + Analysis</span>
                  <span class="option-subtitle">Full processing with insights</span>
                </div>
              </button>
              <button type="button"
                      class="toggle-option"
                      [class.active]="analysisForm.get('mode')?.value === 'transcribe-only'"
                      (click)="analysisForm.patchValue({mode: 'transcribe-only'})">
                <mat-icon>subtitles</mat-icon>
                <div class="option-text">
                  <span class="option-title">Transcribe Only</span>
                  <span class="option-subtitle">Generate transcript without AI</span>
                </div>
              </button>
            </div>
          </div>
        </div>

        <!-- Step 3: AI Configuration (Only shown if mode is 'full') -->
        <div class="form-step" *ngIf="isAIAnalysisEnabled()">
          <div class="step-content">
            <h3 class="step-title">Configure AI Settings</h3>

            <!-- Analysis Model Selection -->
            <div class="setting-group">
              <label class="setting-label">
                <mat-icon>psychology</mat-icon>
                Analysis Model
              </label>
              <select class="modern-select" formControlName="aiModel" (change)="onModelChange()">
                <optgroup label="Claude (API Key Required)">
                  <option value="claude:claude-sonnet-4-20250514">Claude Sonnet 4.5 - Newest & Most Capable</option>
                  <option value="claude:claude-3-5-sonnet-20241022">Claude 3.5 Sonnet - Recommended</option>
                  <option value="claude:claude-3-5-haiku-20241022">Claude 3.5 Haiku - Faster & Cheaper</option>
                </optgroup>
                <optgroup label="ChatGPT / OpenAI (API Key Required)">
                  <option value="openai:gpt-4o">GPT-4o - Best Performance</option>
                  <option value="openai:gpt-4-turbo">GPT-4 Turbo - Balanced</option>
                  <option value="openai:gpt-3.5-turbo">GPT-3.5 Turbo - Budget Friendly</option>
                </optgroup>
                <optgroup label="Ollama (Local - Free)">
                  <option *ngIf="availableOllamaModels.length === 0" value="" disabled>No Ollama models installed</option>
                  <option *ngFor="let model of availableOllamaModels" [value]="'ollama:' + model">{{ model }}</option>
                </optgroup>
              </select>
            </div>

            <!-- API Key (for Claude/OpenAI) -->
            <div class="setting-group" *ngIf="needsApiKey()">
              <label class="setting-label">
                <mat-icon>vpn_key</mat-icon>
                {{ getApiKeyLabel() }}
              </label>
              <div class="input-wrapper">
                <mat-icon class="input-icon">lock</mat-icon>
                <input type="password"
                       class="modern-input"
                       formControlName="apiKey"
                       [placeholder]="'Enter your ' + getApiKeyLabel()">
              </div>
            </div>

            <!-- Ollama Endpoint (for local models) -->
            <div class="setting-group" *ngIf="!needsApiKey()">
              <label class="setting-label">
                <mat-icon>dns</mat-icon>
                Ollama Endpoint
              </label>
              <div class="input-wrapper">
                <mat-icon class="input-icon">computer</mat-icon>
                <input type="text"
                       class="modern-input"
                       formControlName="ollamaEndpoint"
                       placeholder="http://localhost:11434">
              </div>
            </div>
          </div>
        </div>

        <!-- Step 4: Transcription Settings -->
        <div class="form-step">
          <div class="step-content">
            <h3 class="step-title">Transcription Settings</h3>

            <div class="settings-row">
              <div class="setting-group">
                <label class="setting-label">
                  <mat-icon>mic</mat-icon>
                  Whisper Model
                </label>
                <select class="modern-select" formControlName="whisperModel">
                  <option value="tiny">Tiny - Fastest</option>
                  <option value="base">Base - Balanced</option>
                  <option value="small">Small - Better Quality</option>
                  <option value="medium">Medium - Great Quality</option>
                  <option value="large">Large - Best Quality</option>
                </select>
              </div>

              <div class="setting-group">
                <label class="setting-label">
                  <mat-icon>language</mat-icon>
                  Language
                </label>
                <input type="text"
                       class="modern-input"
                       formControlName="language"
                       placeholder="en">
              </div>
            </div>
          </div>
        </div>

        <!-- Step 5: Custom Instructions (Optional, only for AI analysis) -->
        <div class="form-step optional-step" *ngIf="isAIAnalysisEnabled()">
          <div class="step-content">
            <div class="step-title-row">
              <h3 class="step-title">Custom Instructions</h3>
              <span class="optional-badge">Optional</span>
            </div>

            <div class="setting-group">
              <textarea class="modern-textarea"
                        formControlName="customInstructions"
                        rows="4"
                        placeholder="Add specific instructions for the AI analysis...&#10;&#10;Examples:&#10;• Focus on technical discussions&#10;• Identify key quotes and timestamps&#10;• Look for mentions of specific topics"></textarea>
              <span class="hint-text">
                <mat-icon>info</mat-icon>
                Provide context or specific things to look for in the analysis
              </span>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
          <button type="button"
                  mat-stroked-button
                  class="secondary-btn"
                  (click)="saveSettings()">
            <mat-icon>bookmark</mat-icon>
            Save Settings
          </button>
          <button type="submit"
                  mat-raised-button
                  class="primary-btn"
                  [disabled]="analysisForm.invalid">
            <mat-icon>add</mat-icon>
            <span>Add to Queue</span>
          </button>
        </div>
      </form>
    </div>

    <!-- Resize Handle -->
    <div class="resize-handle"
         [class.dragging]="isResizing"
         (mousedown)="startResize($event)"></div>

    <!-- Right Column: Queue Zone -->
    <div class="queue-column" #queueColumn>
      <!-- Queue Header -->
      <div class="queue-header">
        <h3>
          <mat-icon>queue</mat-icon>
          Analysis Queue
        </h3>
        <div class="queue-actions">
          <button mat-raised-button
                  color="primary"
                  (click)="startQueue()"
                  [disabled]="!hasPendingJobs()">
            <mat-icon>play_arrow</mat-icon>
            Start Queue
          </button>
          <button mat-stroked-button
                  color="warn"
                  (click)="clearQueue()"
                  [disabled]="!hasPendingJobs()">
            <mat-icon>clear_all</mat-icon>
            Clear
          </button>
        </div>
      </div>

      <!-- Queue List -->
      <div class="queue-list-container">
        <div class="queue-list" *ngIf="getAllQueueJobs().length > 0">
          <div *ngFor="let job of getAllQueueJobs()" class="queue-job-wrapper">
            <div class="queue-job-card"
                 [class.job-pending]="job.status === 'pending'"
                 [class.job-active]="isJobActive(job)"
                 [class.job-failed]="job.stage === 'failed'">

              <!-- Icon -->
              <div class="job-icon">
                <mat-spinner *ngIf="job.loading" diameter="24"></mat-spinner>
                <mat-icon *ngIf="!job.loading && job.status === 'pending'">hourglass_empty</mat-icon>
                <mat-icon *ngIf="!job.loading && isJobActive(job)" class="spinning">sync</mat-icon>
                <mat-icon *ngIf="job.stage === 'failed'">error</mat-icon>
              </div>

              <!-- Content -->
              <div class="job-content" (click)="toggleJobDetails(job.id)">
                <span class="job-title">{{ getQueueJobDisplayName(job) }}</span>
                <span class="job-subtitle">{{ getQueueJobSubtitle(job) }}</span>
              </div>

              <!-- Progress bar (for active jobs) -->
              <div class="job-progress-bar" *ngIf="isJobActive(job) && job.progress !== undefined">
                <mat-progress-bar
                  mode="determinate"
                  [value]="job.progress || 0"
                  color="primary">
                </mat-progress-bar>
              </div>

              <!-- Actions -->
              <div class="job-actions">
                <button mat-icon-button
                        *ngIf="job.status === 'pending'"
                        (click)="removePendingJob(job.id); $event.stopPropagation()"
                        matTooltip="Remove from queue"
                        class="remove-job-button">
                  <mat-icon>close</mat-icon>
                </button>
                <button mat-icon-button
                        *ngIf="isJobActive(job)"
                        matTooltip="Processing"
                        disabled>
                  <mat-icon>sync</mat-icon>
                </button>
              </div>
            </div>

            <!-- Expandable details -->
            <div class="job-details" *ngIf="isJobDetailsExpanded(job.id)">
              <div class="details-content">
                <div class="detail-row" *ngIf="job.input">
                  <span class="detail-label">Source:</span>
                  <span class="detail-value">{{ job.input }}</span>
                </div>
                <div class="detail-row" *ngIf="job.customInstructions">
                  <span class="detail-label">Instructions:</span>
                  <span class="detail-value">{{ job.customInstructions }}</span>
                </div>
                <div class="detail-row" *ngIf="job.stage">
                  <span class="detail-label">Status:</span>
                  <span class="detail-value">{{ getJobStatusText(job) }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Empty state -->
        <div class="queue-empty" *ngIf="getAllQueueJobs().length === 0">
          <mat-icon>inbox</mat-icon>
          <h3>No jobs in queue</h3>
          <p>Add videos using the form on the left to start processing</p>
        </div>
      </div>

      <!-- Completed Jobs Accordion -->
      <mat-accordion *ngIf="getCompletedJobs().length > 0" class="completed-accordion">
        <mat-expansion-panel [expanded]="isCompletedAccordionExpanded">
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon>history</mat-icon>
              Completed ({{ getCompletedJobs().length }})
            </mat-panel-title>
          </mat-expansion-panel-header>

          <div class="completed-jobs-list">
            <div *ngFor="let job of getCompletedJobs()" class="queue-job-wrapper">
              <div class="queue-job-card job-completed"
                   [class.job-failed]="job.stage === 'failed'">

                <!-- Icon -->
                <div class="job-icon">
                  <mat-icon>{{ job.stage === 'completed' ? 'check_circle' : 'error' }}</mat-icon>
                </div>

                <!-- Content -->
                <div class="job-content">
                  <span class="job-title">{{ job.filename || job.url || 'Unknown' }}</span>
                  <span class="job-subtitle">
                    {{ getJobStatusText(job) }}
                    <span *ngIf="job.completedAt"> • {{ getRelativeTime(job.completedAt) }}</span>
                  </span>
                </div>

                <!-- Actions -->
                <div class="job-actions">
                  <button mat-icon-button
                          matTooltip="Remove"
                          color="warn">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <button mat-stroked-button
                  class="clear-completed-btn"
                  (click)="clearCompleted()">
            <mat-icon>clear_all</mat-icon>
            Clear Completed ({{ getCompletedJobs().length }})
          </button>
        </mat-expansion-panel>
      </mat-accordion>

      <!-- Quick Select Section -->
      <div class="library-section">
        <div class="section-header">
          <h3>
            <mat-icon>video_library</mat-icon>
            Quick Select
          </h3>
        </div>

        <!-- Search -->
        <div class="library-search-wrapper">
          <mat-icon>search</mat-icon>
          <input type="text"
                 class="library-search"
                 [(ngModel)]="librarySearchQuery"
                 [ngModelOptions]="{standalone: true}"
                 (ngModelChange)="onLibrarySearchChange()"
                 placeholder="Search your library...">
        </div>

        <!-- Loading -->
        <div class="library-loading" *ngIf="isLoadingLibrary">
          <mat-icon class="spinning">sync</mat-icon>
          <span>Loading videos...</span>
        </div>

        <!-- Video List -->
        <div class="library-list" *ngIf="!isLoadingLibrary && filteredLibraryVideos.length > 0">
          <div class="library-item"
               *ngFor="let video of filteredLibraryVideos"
               (click)="selectLibraryVideo(video)">
            <div class="item-icon">
              <mat-icon>movie</mat-icon>
            </div>
            <div class="item-details">
              <div class="item-name">{{ video.filename }}</div>
              <div class="item-meta">
                <span *ngIf="video.duration_seconds">{{ formatDuration(video.duration_seconds) }}</span>
                <span *ngIf="video.file_size_bytes"> • {{ formatFileSize(video.file_size_bytes) }}</span>
              </div>
            </div>
            <mat-icon class="select-icon">chevron_right</mat-icon>
          </div>
        </div>

        <!-- Empty States -->
        <div class="library-empty" *ngIf="!isLoadingLibrary && filteredLibraryVideos.length === 0">
          <mat-icon>{{ libraryVideos.length === 0 ? 'video_library' : 'search_off' }}</mat-icon>
          <p>{{ libraryVideos.length === 0 ? 'No videos in library' : 'No results found' }}</p>
        </div>
      </div>
    </div>
  </div>
</div>
