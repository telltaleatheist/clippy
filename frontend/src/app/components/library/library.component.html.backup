<div class="library-container"
     tabindex="0"
     (keydown)="handleKeyDown($event)"
     (dragover)="onDragOver($event)"
     (dragleave)="onDragLeave($event)"
     (drop)="onDrop($event)">

  <!-- Drag and Drop Overlay -->
  <div class="drop-zone-overlay" *ngIf="isDragging">
    <div class="drop-zone-content">
      <mat-icon>cloud_upload</mat-icon>
      <h2>Drop media files here</h2>
      <p>Choose: Import, Transcribe, or Analyze</p>
      <p class="hint">Default: Import (no processing)</p>
    </div>
  </div>

  <!-- Header with stats and actions -->
  <div class="library-header">
    <div class="header-content">
      <div class="title-and-selector">
        <h1>
          <mat-icon>video_library</mat-icon>
          Video Library
        </h1>

        <!-- Library Selector -->
        <div class="library-selector">
          <!-- Loading state -->
          <div *ngIf="isLoadingLibraries" class="library-loading">
            <mat-spinner diameter="24"></mat-spinner>
            <span style="margin-left: 8px;">Connecting to library service...</span>
          </div>

          <!-- Library dropdown when loaded -->
          <mat-form-field appearance="outline" class="library-dropdown" *ngIf="!isLoadingLibraries && libraries.length > 0">
            <mat-label>Library</mat-label>
            <mat-select [(ngModel)]="selectedLibraryId" (selectionChange)="onLibraryChange()">
              <mat-option *ngFor="let library of libraries" [value]="library.id">
                {{ library.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Create library button when no libraries exist -->
          <button mat-raised-button color="accent" (click)="openManageLibraries()" *ngIf="!isLoadingLibraries && libraries.length === 0">
            <mat-icon>add</mat-icon>
            Create Library
          </button>

          <!-- Manage button -->
          <button mat-icon-button (click)="openManageLibraries()" matTooltip="Manage Libraries" *ngIf="!isLoadingLibraries && libraries.length > 0">
            <mat-icon>settings</mat-icon>
          </button>
        </div>
      </div>

    </div>

    <!-- Action buttons - Library View -->
    <div class="header-actions" *ngIf="pageMode === 'library'">
      <button mat-raised-button color="primary" (click)="openImportManager()" matTooltip="Import specific videos from clips folder">
        <mat-icon>file_download</mat-icon>
        Import Videos
      </button>
      <button mat-raised-button color="primary" (click)="downloadFromUrl()" matTooltip="Download video from URL and add to queue">
        <mat-icon>link</mat-icon>
        Download from URL
      </button>
      <button mat-raised-button color="accent" (click)="viewUnimportedVideos()" matTooltip="Scan for new videos, find orphaned entries, and manage your library">
        <mat-icon>manage_search</mat-icon>
        Video Management
        <span class="badge" *ngIf="stats && stats.unlinkedVideos > 0">{{ stats.unlinkedVideos }}</span>
      </button>
    </div>

    <!-- Action buttons - Management View -->
    <div class="header-actions" *ngIf="pageMode === 'management'">
      <button mat-raised-button (click)="backToLibrary()">
        <mat-icon>arrow_back</mat-icon>
        Back to Library
      </button>
      <button mat-raised-button
              color="primary"
              (click)="relinkSelectedOrphans()"
              [disabled]="selectedOrphanedVideos.size === 0"
              matTooltip="Select a new folder that contains the missing files">
        <mat-icon>link</mat-icon>
        Relink Selected ({{ selectedOrphanedVideos.size }})
      </button>
      <button mat-raised-button
              color="warn"
              (click)="deleteSelectedOrphans()"
              [disabled]="selectedOrphanedVideos.size === 0"
              matTooltip="Remove selected entries from database">
        <mat-icon>delete</mat-icon>
        Delete Selected ({{ selectedOrphanedVideos.size }})
      </button>
    </div>
  </div>

  <!-- Main Content -->

  <!-- Library View -->
  <div *ngIf="pageMode === 'library'">
    <!-- Search Filters Accordion -->
    <mat-accordion class="search-filters-accordion">
      <mat-expansion-panel [expanded]="searchFiltersExpanded" (opened)="searchFiltersExpanded = true" (closed)="searchFiltersExpanded = false">
        <mat-expansion-panel-header>
          <mat-panel-title class="search-in-header">
            <mat-icon class="search-icon">search</mat-icon>
            <input
              class="header-search-input"
              type="text"
              [(ngModel)]="searchQuery"
              (ngModelChange)="onSearchChange()"
              (click)="searchFiltersExpanded = true; $event.stopPropagation()"
              placeholder="Search videos..."
              [matTooltip]="searchQuery || selectedTags.length > 0 ? '' : 'Click to expand filters and sorting options'">
            <button mat-icon-button
                    class="clear-search-btn"
                    *ngIf="searchQuery || selectedTags.length > 0"
                    (click)="clearSearch(); $event.stopPropagation()"
                    matTooltip="Clear search">
              <mat-icon>clear</mat-icon>
            </button>
            <span *ngIf="selectedTags.length > 0" class="active-indicator">{{ selectedTags.length }} tag{{ selectedTags.length > 1 ? 's' : '' }}</span>
          </mat-panel-title>
        </mat-expansion-panel-header>

        <!-- Search Filters -->
        <div class="filter-section">
          <div class="filter-section-title">Search in:</div>
          <div class="filter-checkboxes-compact">
            <mat-checkbox [(ngModel)]="searchFilters.filename" (change)="onSearchChange()">Filename</mat-checkbox>
            <mat-checkbox [(ngModel)]="searchFilters.aiDescription" (change)="onSearchChange()">AI Description</mat-checkbox>
            <mat-checkbox [(ngModel)]="searchFilters.transcript" (change)="onSearchChange()">Transcript</mat-checkbox>
            <mat-checkbox [(ngModel)]="searchFilters.analysis" (change)="onSearchChange()">Analysis</mat-checkbox>
            <mat-checkbox [(ngModel)]="searchFilters.tags" (change)="onSearchChange()">Tags</mat-checkbox>
          </div>
        </div>

        <!-- Sort buttons -->
        <div class="filter-section">
          <div class="filter-section-title">Sort by:</div>
          <div class="sort-buttons-compact">
            <button mat-stroked-button
                    (click)="changeSortBy('date')"
                    [color]="sortBy === 'date' ? 'primary' : undefined">
              Date {{ sortBy === 'date' ? (sortOrder === 'desc' ? '↓' : '↑') : '' }}
            </button>
            <button mat-stroked-button
                    (click)="changeSortBy('date-added')"
                    [color]="sortBy === 'date-added' ? 'primary' : undefined">
              Added {{ sortBy === 'date-added' ? (sortOrder === 'desc' ? '↓' : '↑') : '' }}
            </button>
            <button mat-stroked-button
                    (click)="changeSortBy('filename')"
                    [color]="sortBy === 'filename' ? 'primary' : undefined">
              Name {{ sortBy === 'filename' ? (sortOrder === 'desc' ? '↓' : '↑') : '' }}
            </button>
            <button mat-stroked-button
                    (click)="changeSortBy('size')"
                    [color]="sortBy === 'size' ? 'primary' : undefined">
              Size {{ sortBy === 'size' ? (sortOrder === 'desc' ? '↓' : '↑') : '' }}
            </button>
            <button mat-stroked-button
                    (click)="changeSortBy('no-transcript')"
                    [color]="sortBy === 'no-transcript' ? 'primary' : undefined">
              No Transcript {{ sortBy === 'no-transcript' ? (sortOrder === 'desc' ? '↓' : '↑') : '' }}
            </button>
            <button mat-stroked-button
                    (click)="changeSortBy('no-analysis')"
                    [color]="sortBy === 'no-analysis' ? 'primary' : undefined">
              No Analysis {{ sortBy === 'no-analysis' ? (sortOrder === 'desc' ? '↓' : '↑') : '' }}
            </button>
          </div>
        </div>

        <!-- Tag Filters -->
        <div class="filter-section" *ngIf="allTags && (allTags.people.length > 0 || allTags.topic.length > 0)">
          <div class="filter-section-title">
            Filter by Tags
            <button mat-button
                    *ngIf="selectedTags.length > 0"
                    color="warn"
                    (click)="clearTagFilters()"
                    style="margin-left: 8px; font-size: 12px; padding: 0 8px; min-width: auto; line-height: 24px;">
              Clear ({{ selectedTags.length }})
            </button>
          </div>

          <!-- Compact Tag Chips -->
          <div class="tag-chips-compact">
            <div class="tag-group" *ngIf="allTags?.people && allTags.people.length > 0">
              <span class="tag-group-label">People:</span>
              <mat-chip-set class="compact-chip-set">
                <mat-chip
                  *ngFor="let tag of allTags.people.slice(0, 15)"
                  (click)="toggleTag(tag.name)"
                  [class.selected]="isTagSelected(tag.name)"
                  class="compact-chip">
                  {{ tag.name }} <span class="chip-count">({{ tag.count }})</span>
                </mat-chip>
              </mat-chip-set>
            </div>

            <div class="tag-group" *ngIf="allTags?.topic && allTags.topic.length > 0">
              <span class="tag-group-label">Topics:</span>
              <mat-chip-set class="compact-chip-set">
                <mat-chip
                  *ngFor="let tag of allTags.topic.slice(0, 15)"
                  (click)="toggleTag(tag.name)"
                  [class.selected]="isTagSelected(tag.name)"
                  class="compact-chip">
                  {{ tag.name }} <span class="chip-count">({{ tag.count }})</span>
                </mat-chip>
              </mat-chip-set>
            </div>
          </div>
        </div>
      </mat-expansion-panel>
    </mat-accordion>

  <!-- Results count and selection buttons -->
  <div class="results-header" *ngIf="filteredVideos.length > 0 || (!isLoading && filteredVideos.length === 0)">
    <div class="results-count">
      <div class="selection-buttons" *ngIf="filteredVideos.length > 0">
        <button mat-stroked-button
                (click)="toggleAllSelection()"
                [color]="isAllSelected ? 'primary' : undefined"
                matTooltip="Select all visible videos (Cmd/Ctrl+A)">
          <mat-icon>select_all</mat-icon>
          All
        </button>
        <button mat-stroked-button
                (click)="selectAllMissingTranscript()"
                [color]="isMissingTranscriptSelected ? 'primary' : undefined"
                matTooltip="Select all videos missing transcription">
          <mat-icon>subtitles_off</mat-icon>
          No Transcript
        </button>
        <button mat-stroked-button
                (click)="selectAllMissingAnalysis()"
                [color]="isMissingAnalysisSelected ? 'primary' : undefined"
                matTooltip="Select all videos missing AI analysis">
          <mat-icon>psychology</mat-icon>
          No Analysis
        </button>

        <!-- File Type Filter Button -->
        <button mat-stroked-button
                [matMenuTriggerFor]="fileTypeMenu"
                matTooltip="Filter by file type">
          <mat-icon>filter_list</mat-icon>
          File Types
        </button>
      </div>

      <mat-menu #fileTypeMenu="matMenu" class="file-type-menu">
        <div class="menu-header" (click)="$event.stopPropagation()">
          <span>Show File Types</span>
          <button mat-button (click)="selectAllFileTypes()">All</button>
        </div>
        <mat-divider></mat-divider>
        <button mat-menu-item (click)="$event.stopPropagation(); toggleFileTypeFilter('video')">
          <mat-checkbox [checked]="fileTypeFilters.video" (change)="toggleFileTypeFilter('video')" (click)="$event.stopPropagation()"></mat-checkbox>
          <mat-icon>movie</mat-icon>
          <span>Video (.mov, .mp4, .avi, .mkv, .webm, .m4v, .flv)</span>
        </button>
        <button mat-menu-item (click)="$event.stopPropagation(); toggleFileTypeFilter('audio')">
          <mat-checkbox [checked]="fileTypeFilters.audio" (change)="toggleFileTypeFilter('audio')" (click)="$event.stopPropagation()"></mat-checkbox>
          <mat-icon>audiotrack</mat-icon>
          <span>Audio (.mp3, .m4a, .aac, .flac, .wav, .ogg)</span>
        </button>
        <button mat-menu-item (click)="$event.stopPropagation(); toggleFileTypeFilter('document')">
          <mat-checkbox [checked]="fileTypeFilters.document" (change)="toggleFileTypeFilter('document')" (click)="$event.stopPropagation()"></mat-checkbox>
          <mat-icon>description</mat-icon>
          <span>Document (.pdf, .epub, .mobi, .txt, .md)</span>
        </button>
        <button mat-menu-item (click)="$event.stopPropagation(); toggleFileTypeFilter('image')">
          <mat-checkbox [checked]="fileTypeFilters.image" (change)="toggleFileTypeFilter('image')" (click)="$event.stopPropagation()"></mat-checkbox>
          <mat-icon>image</mat-icon>
          <span>Image (.jpg, .png, .gif, .webp, .bmp)</span>
        </button>
        <button mat-menu-item (click)="$event.stopPropagation(); toggleFileTypeFilter('webpage')">
          <mat-checkbox [checked]="fileTypeFilters.webpage" (change)="toggleFileTypeFilter('webpage')" (click)="$event.stopPropagation()"></mat-checkbox>
          <mat-icon>public</mat-icon>
          <span>Webpage (.html, .htm, .mhtml)</span>
        </button>
      </mat-menu>

      <span class="count-text">
        Showing {{ filteredVideos.length }} of {{ videos.length }} videos
        <span *ngIf="selectedTags.length > 0"> (filtered by {{ selectedTags.length }} tag{{ selectedTags.length > 1 ? 's' : '' }})</span>
        <span *ngIf="getSelectedCount() > 0" class="selected-info"> • {{ getSelectedCount() }} selected</span>
        <span *ngIf="isInitialLoad && filteredVideos.length > 0" class="loading-more">
          <mat-spinner diameter="16" style="display: inline-block; margin-left: 8px;"></mat-spinner>
          <span style="margin-left: 8px; font-size: 0.9em; color: #666;">Loading more...</span>
        </span>
      </span>
    </div>
    <div class="selection-actions">
      <button
        mat-raised-button
        color="primary"
        [disabled]="getSelectedCount() === 0"
        (click)="analyzeSelected()"
        matTooltip="Analyze or transcribe selected videos">
        <mat-icon>psychology</mat-icon>
        Analyze ({{ getSelectedCount() }})
      </button>
      <button
        mat-raised-button
        color="accent"
        [disabled]="getSelectedCount() !== 1"
        (click)="openVideoEditor()"
        matTooltip="Open video editor (requires exactly one video selected)">
        <mat-icon>video_settings</mat-icon>
        Video Editor
      </button>
      <button
        mat-raised-button
        [disabled]="getSelectedCount() !== 1"
        (click)="openMetadataEditorForSelected()"
        matTooltip="View details for selected video">
        <mat-icon>info</mat-icon>
        View Details
      </button>
    </div>
  </div>

  <!-- Loading spinner (only show when truly loading with no videos yet) -->
  <div class="loading-container" *ngIf="isLoading && filteredVideos.length === 0">
    <mat-spinner></mat-spinner>
    <p>Loading video library...</p>
  </div>

  <!-- Video List with ItemListComponent -->
  <app-item-list
    *ngIf="filteredVideos.length > 0"
    [items]="videosAsListItems"
    [displayConfig]="listDisplayConfig"
    [groupConfig]="listGroupConfig"
    [keyboardConfig]="listKeyboardConfig"
    [selectionMode]="SelectionMode.Multiple"
    [contextMenuActions]="listContextMenuActions"
    [statusMapper]="getVideoStatusMapper"
    (itemClick)="onListItemClick($event)"
    (itemDoubleClick)="onListItemDoubleClick($event)"
    (spaceAction)="onListSpaceAction($event)"
    (deleteAction)="onListDeleteAction($event)"
    (contextMenuAction)="onListContextMenuAction($event)">
  </app-item-list>

  <!-- OLD VIDEO LIST (commented out for reference) -->
  <!--
  <div *ngIf="filteredVideos.length > 0" class="video-list-container" (click)="onListContainerClick($event)">
    <div *ngFor="let group of groupedVideos" class="week-group">
      <div class="week-header"
           [class.selected]="isWeekSelected(group.week)"
           (click)="selectWeekSection(group.week, $event)">
        <mat-icon class="collapse-icon" (click)="toggleWeek(group.week, $event); $event.stopPropagation()">
          {{ isWeekCollapsed(group.week) ? 'chevron_right' : 'expand_more' }}
        </mat-icon>
        <span class="week-title">{{ group.week }}</span>
        <span class="week-count">{{ group.videos.length }} video{{ group.videos.length !== 1 ? 's' : '' }}</span>
      </div>
      <div *ngIf="!isWeekCollapsed(group.week)" class="week-videos">
        <div *ngFor="let video of group.videos" class="video-card-wrapper">
      <div class="video-card"
           [attr.data-video-id]="video.id"
           [class.long-video]="isLongVideo(video)"
           [class.missing-transcript]="!video.has_transcript && canAnalyzeMedia(video)"
           [class.missing-analysis]="!video.has_analysis && canAnalyzeMedia(video)"
           [class.missing-both]="!video.has_transcript && !video.has_analysis && canAnalyzeMedia(video)"
           [class.highlighted]="isVideoHighlighted(video)"
           [class.selected]="isVideoSelected(video)"
           (click)="highlightVideo(video, $event)"
           (dblclick)="onVideoDoubleClick(video, $event)"
           (contextmenu)="onVideoContextMenu($event, video)">

        <!-- Status Indicator (color-coded based on transcript/analysis status) -->
        <div class="card-status-indicator"
             [class.has-both]="video.has_transcript && video.has_analysis"
             [class.has-transcript-only]="video.has_transcript && !video.has_analysis && canAnalyzeMedia(video)"
             [class.has-analysis-only]="!video.has_transcript && video.has_analysis && canAnalyzeMedia(video)"
             [class.has-neither]="!video.has_transcript && !video.has_analysis && canAnalyzeMedia(video)"
             [matTooltip]="getStatusTooltip(video)">
        </div>

        <!-- Content (non-editable by click) -->
        <div class="card-content">
          <!-- Media type icon -->
          <mat-icon class="media-type-icon" [matTooltip]="getMediaTypeLabel(video.media_type)">
            {{ getMediaTypeIcon(video.media_type) }}
          </mat-icon>

          <!-- Date chip (with placeholder for alignment when empty) -->
          <mat-chip *ngIf="parseFilename(video.filename).date && !editingVideo[video.id]?.date"
                    class="date-chip">
            {{ formatDateChip(parseFilename(video.filename).date) }}
          </mat-chip>
          <span *ngIf="!parseFilename(video.filename).date && !editingVideo[video.id]?.date"
                class="date-placeholder"></span>
          <input *ngIf="editingVideo[video.id]?.date"
                 type="text"
                 class="date-input"
                 [(ngModel)]="editedValues[video.id].date"
                 (keydown)="onEditKeydown(video, $event)"
                 (blur)="onEditBlur(video, 'date')"
                 (click)="$event.stopPropagation()"
                 placeholder="yyyy-mm-dd"
                 #dateInput>

          <!-- Title (editable on click) -->
          <span *ngIf="!editingVideo[video.id]?.title" class="video-title-text">
            {{ parseFilename(video.filename).title }}
          </span>
          <input *ngIf="editingVideo[video.id]?.title"
                 type="text"
                 class="title-input"
                 [(ngModel)]="editedValues[video.id].title"
                 (keydown)="onEditKeydown(video, $event)"
                 (blur)="onEditBlur(video, 'title')"
                 (click)="$event.stopPropagation()"
                 placeholder="Video title"
                 #titleInput>

          <!-- Extension (with placeholder for alignment when empty) -->
          <span *ngIf="parseFilename(video.filename).extension && !editingVideo[video.id]?.extension"
                class="extension-text">
            .{{ parseFilename(video.filename).extension }}
          </span>
          <span *ngIf="!parseFilename(video.filename).extension && !editingVideo[video.id]?.extension"
                class="extension-placeholder"></span>
          <input *ngIf="editingVideo[video.id]?.extension"
                 type="text"
                 class="extension-input"
                 [(ngModel)]="editedValues[video.id].extension"
                 (keydown)="onEditKeydown(video, $event)"
                 (blur)="onEditBlur(video, 'extension')"
                 (click)="$event.stopPropagation()"
                 placeholder="mp4"
                 #extensionInput>

          <mat-icon *ngIf="isLongVideo(video)" class="long-video-badge" matTooltip="Long video (> 10 minutes)">schedule</mat-icon>

          <!-- Search match indicator -->
          <mat-chip *ngIf="video.matchType && searchQuery" class="match-indicator" [matTooltip]="'Found in: ' + getMatchTypeLabel(video.matchType)">
            <mat-icon>{{ getMatchTypeIcon(video.matchType) }}</mat-icon>
            {{ getMatchTypeLabel(video.matchType) }}
          </mat-chip>

          <!-- Subtitle (duration info) on the right side -->
          <span class="video-subtitle">
            <span *ngIf="video.date_folder">{{ formatDate(video.date_folder) }}</span>
            <span *ngIf="video.duration_seconds"> • {{ formatDuration(video.duration_seconds) }}</span>
          </span>
        </div>

        <!-- Action buttons on the right -->
        <div class="card-actions">
          <button mat-icon-button (click)="onThreeDotsClick($event, video)" matTooltip="More actions">
            <mat-icon>more_vert</mat-icon>
          </button>
          <button mat-icon-button color="warn" (click)="deleteVideo(video); $event.stopPropagation()" matTooltip="Delete video from library">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      </div>
    </div>
      </div>
    </div>
  </div>
  -->

  <!-- Context Menu (Right-click) - positioned at cursor -->
  <div style="visibility: hidden; position: fixed;"
       [style.left.px]="contextMenuPosition.x"
       [style.top.px]="contextMenuPosition.y"
       [matMenuTriggerFor]="videoContextMenu"
       #contextMenuTrigger="matMenuTrigger">
  </div>

  <mat-menu #videoContextMenu="matMenu">
    <ng-container *ngIf="contextMenuVideo">
      <!-- Single video actions -->
      <button mat-menu-item (click)="startRenamingVideo(contextMenuVideo)" *ngIf="getSelectedCount() === 1">
        <mat-icon>edit</mat-icon>
        <span>Rename</span>
      </button>
      <button mat-menu-item (click)="openVideoPlayer(contextMenuVideo)" *ngIf="getSelectedCount() === 1 && canAnalyzeMedia(contextMenuVideo)">
        <mat-icon>play_arrow</mat-icon>
        <span>Open in Video Editor</span>
      </button>
      <button mat-menu-item (click)="openMetadataEditor(contextMenuVideo)" *ngIf="getSelectedCount() === 1">
        <mat-icon>info</mat-icon>
        <span>View Details</span>
      </button>
      <button mat-menu-item (click)="copyFilename(contextMenuVideo)" *ngIf="getSelectedCount() === 1">
        <mat-icon>content_copy</mat-icon>
        <span>Copy Filename</span>
      </button>
      <button mat-menu-item (click)="openFileLocation(contextMenuVideo)" *ngIf="getSelectedCount() === 1">
        <mat-icon>folder_open</mat-icon>
        <span>Open File Location</span>
      </button>
      <mat-divider *ngIf="getSelectedCount() === 1"></mat-divider>

      <!-- Multi-selection actions -->
      <button mat-menu-item (click)="analyzeSelected()" *ngIf="hasAnalyzableSelection()">
        <mat-icon>psychology</mat-icon>
        <span>Analyze{{ getSelectedCount() > 1 ? ' (' + getSelectedCount() + ')' : '' }}</span>
      </button>
      <button mat-menu-item (click)="moveToLibrary()">
        <mat-icon>drive_file_move</mat-icon>
        <span>Move to...{{ getSelectedCount() > 1 ? ' (' + getSelectedCount() + ')' : '' }}</span>
      </button>
      <mat-divider></mat-divider>
      <button mat-menu-item (click)="deleteSelected()">
        <mat-icon color="warn">delete</mat-icon>
        <span>Delete{{ getSelectedCount() > 1 ? ' (' + getSelectedCount() + ')' : '' }}</span>
      </button>
    </ng-container>
  </mat-menu>

  <!-- Empty state -->
  <div class="empty-state" *ngIf="!isLoading && filteredVideos.length === 0">
    <mat-icon>video_library</mat-icon>
    <h2>No videos found</h2>
    <p *ngIf="searchQuery">Try adjusting your search query</p>
    <p *ngIf="!searchQuery && videos.length === 0">Click "Import Videos" to select specific videos or "Scan All" to import all videos from your clips directory</p>
    <p *ngIf="!searchQuery && videos.length > 0">No videos match the current filters</p>
  </div>

  <!-- FLOATING PREVIEW PANEL FOR LIST VIEW -->
  <div
    class="floating-preview-panel"
    *ngIf="isPreviewModalOpen && highlightedVideo"
    [style.left.px]="previewPanelX"
    [style.top.px]="previewPanelY"
    [style.width.px]="previewPanelWidth"
    [style.height.px]="previewPanelHeight"
    [class.dragging]="isDraggingPreviewPanel"
    [class.resizing]="isResizingPreviewPanel">

    <!-- Drag Handle Bar -->
    <div class="preview-panel-header" (mousedown)="startDragPreviewPanel($event)">
      <mat-icon class="drag-icon">drag_indicator</mat-icon>
      <span class="header-title">Preview</span>
      <button mat-icon-button
              (click)="togglePreviewAutoPlay()"
              [color]="previewAutoPlayEnabled ? 'primary' : ''"
              [matTooltip]="previewAutoPlayEnabled ? 'Auto-play: On' : 'Auto-play: Off'"
              (mousedown)="$event.stopPropagation()">
        <mat-icon>{{ previewAutoPlayEnabled ? 'play_circle' : 'pause_circle' }}</mat-icon>
      </button>
      <button mat-icon-button class="close-panel-btn" (click)="closePreviewModal()" (mousedown)="$event.stopPropagation()">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <!-- Media Player (Video/Audio/Image) -->
    <div class="preview-panel-video">
      <!-- Video Player -->
      <video #previewVideoPlayer
             *ngIf="highlightedVideo.media_type === 'video'"
             [src]="getVideoStreamUrl(highlightedVideo)"
             controls
             class="preview-video-player">
      </video>

      <!-- Audio Player -->
      <audio *ngIf="highlightedVideo.media_type === 'audio'"
             [src]="getVideoStreamUrl(highlightedVideo)"
             controls
             class="preview-audio-player">
      </audio>

      <!-- Image Viewer -->
      <img *ngIf="highlightedVideo.media_type === 'image'"
           [src]="getVideoStreamUrl(highlightedVideo)"
           class="preview-image-viewer"
           [alt]="highlightedVideo.filename">

      <!-- Unsupported Media Type Message -->
      <div *ngIf="highlightedVideo.media_type !== 'video' && highlightedVideo.media_type !== 'audio' && highlightedVideo.media_type !== 'image'"
           class="unsupported-preview">
        <mat-icon>{{ getMediaTypeIcon(highlightedVideo.media_type) }}</mat-icon>
        <p>{{ getMediaTypeLabel(highlightedVideo.media_type) }} preview not available</p>
        <p class="hint">Open "View Details" to see more information</p>
      </div>
    </div>

    <!-- Title Section -->
    <div class="preview-panel-title">
      <span class="video-title">{{ parseFilename(highlightedVideo.filename).title }}</span>
    </div>

    <!-- Action Buttons -->
    <div class="preview-panel-actions">
      <button mat-raised-button color="primary" (click)="analyzeVideo(highlightedVideo)" class="action-btn">
        <mat-icon>psychology</mat-icon>
        Analyze
      </button>
      <button mat-raised-button color="accent" (click)="openVideoPlayer(highlightedVideo)" class="action-btn">
        <mat-icon>video_settings</mat-icon>
        Video Editor
      </button>
      <button mat-raised-button (click)="openMetadataEditor(highlightedVideo); closePreviewModal()" class="action-btn">
        <mat-icon>info</mat-icon>
        View Details
      </button>
    </div>

    <!-- Keyboard Hints -->
    <div class="preview-panel-hints">
      <span><mat-icon>keyboard</mat-icon> Space</span>
      <span><mat-icon>keyboard</mat-icon> ↑↓</span>
      <span><mat-icon>keyboard</mat-icon> Esc</span>
    </div>

    <!-- Resize Handles -->
    <div class="preview-panel-resize-handle preview-panel-resize-handle-right" (mousedown)="startResizePreviewPanel($event)">
      <mat-icon>drag_handle</mat-icon>
    </div>
    <div class="preview-panel-resize-handle preview-panel-resize-handle-left" (mousedown)="startResizePreviewPanelLeft($event)">
      <mat-icon>drag_handle</mat-icon>
    </div>
  </div>
  </div>

  <!-- Management View -->
  <div *ngIf="pageMode === 'management'" class="management-view" (click)="onManagementViewClick($event)" (contextmenu)="onManagementViewRightClick($event)">
    <div class="management-header">
      <h2>
        <mat-icon>settings</mat-icon>
        Video Management
      </h2>
      <p class="description">Manage orphaned files and database entries</p>
    </div>

    <mat-tab-group (selectedTabChange)="onManagementTabChange($event)">
      <!-- Tab 1: Orphaned Files -->
      <mat-tab label="Orphaned Files">
        <div class="tab-content">
          <div class="tab-header">
            <p class="tab-description">Video files in the clips folder that haven't been imported to the database yet.</p>
            <div class="tab-actions">
              <button mat-raised-button
                      color="primary"
                      (click)="loadUnimportedVideos()"
                      [disabled]="loadingUnimported">
                <mat-icon>search</mat-icon>
                {{ loadingUnimported ? 'Scanning...' : 'Scan for Orphaned Files' }}
              </button>
              <button mat-raised-button
                      color="accent"
                      (click)="importSelectedVideos()"
                      [disabled]="selectedUnimportedVideos.size === 0 || loadingUnimported"
                      matTooltip="Import selected videos to database">
                <mat-icon>add</mat-icon>
                Import Selected ({{ selectedUnimportedVideos.size }})
              </button>
            </div>
            <p class="count-info" *ngIf="!loadingUnimported && unimportedVideos.length > 0">
              <mat-icon class="warning-icon">warning</mat-icon>
              {{ unimportedVideos.length }} orphaned file{{ unimportedVideos.length !== 1 ? 's' : '' }} found
            </p>
          </div>

          <!-- Loading state -->
          <div class="loading-container" *ngIf="loadingUnimported">
            <mat-spinner></mat-spinner>
            <p>Scanning for orphaned files...</p>
          </div>

          <!-- Selection header -->
          <div class="results-header" *ngIf="!loadingUnimported && unimportedVideos.length > 0">
            <div class="results-count">
              <div class="selection-buttons">
                <button mat-stroked-button
                        (click)="toggleAllUnimportedSelection()"
                        [color]="isAllUnimportedSelected ? 'primary' : undefined"
                        matTooltip="Select all orphaned files">
                  <mat-icon>select_all</mat-icon>
                  All
                </button>
              </div>
              <span class="count-text">
                {{ selectedUnimportedVideos.size > 0 ? selectedUnimportedVideos.size + ' selected of ' : '' }}{{ unimportedVideos.length }} file{{ unimportedVideos.length !== 1 ? 's' : '' }}
              </span>
            </div>
          </div>

          <!-- Unimported videos list container -->
          <div *ngIf="!loadingUnimported && unimportedVideos.length > 0" class="management-list-container">
            <div class="management-video-list">
              <div class="management-video-row"
                   *ngFor="let video of unimportedVideos"
                   [class.selected]="selectedUnimportedVideos.has(video.fullPath)"
                   (click)="onManagementVideoClick($event, video.fullPath, 'unimported')"
                   (contextmenu)="onManagementVideoRightClick($event, video, 'unimported')">

                <!-- Green status indicator -->
                <div class="status-dot"></div>

                <!-- Date badge (extract from filename) -->
                <div class="date-badge" *ngIf="parseFilename(video.filename).date">
                  {{ formatDateChip(parseFilename(video.filename).date) }}
                </div>

                <!-- Video title -->
                <div class="video-title-text">{{ parseFilename(video.filename).title || video.filename }}</div>

                <!-- File extension -->
                <div class="file-extension">.{{ parseFilename(video.filename).extension }}</div>

                <!-- Date added -->
                <div class="date-added">{{ video.dateFolder || 'Unknown' }}</div>

                <!-- Actions menu -->
                <button mat-icon-button
                        class="actions-menu"
                        #menuTrigger="matMenuTrigger"
                        [matMenuTriggerFor]="unimportedVideoMenu"
                        [matMenuTriggerData]="{video: video}"
                        (click)="$event.stopPropagation()">
                  <mat-icon>more_vert</mat-icon>
                </button>
              </div>
            </div>
          </div>

          <!-- Empty state -->
          <div class="empty-state" *ngIf="!loadingUnimported && unimportedVideos.length === 0">
            <mat-icon>check_circle</mat-icon>
            <p>No orphaned files found</p>
            <p class="secondary">All video files in the clips folder have been imported</p>
          </div>
        </div>
      </mat-tab>

      <!-- Tab 2: Orphaned Database Entries -->
      <mat-tab label="Orphaned Database Entries">
        <div class="tab-content">
          <div class="tab-header">
            <p class="tab-description">Database entries where the video file no longer exists on disk.</p>
            <div class="tab-actions">
              <button mat-raised-button
                      color="primary"
                      (click)="loadOrphanedVideos()"
                      [disabled]="loadingOrphaned">
                <mat-icon>search</mat-icon>
                {{ loadingOrphaned ? 'Scanning...' : 'Scan for Orphaned Entries' }}
              </button>
              <button mat-raised-button
                      color="warn"
                      (click)="pruneAllOrphans()"
                      [disabled]="orphanedVideos.length === 0 || loadingOrphaned"
                      matTooltip="Remove all orphaned entries from database">
                <mat-icon>delete_sweep</mat-icon>
                Prune All ({{ orphanedVideos.length }})
              </button>
            </div>
            <p class="count-info" *ngIf="!loadingOrphaned && orphanedVideos.length > 0">
              <mat-icon class="warning-icon">warning</mat-icon>
              {{ orphanedVideos.length }} orphaned entr{{ orphanedVideos.length !== 1 ? 'ies' : 'y' }} found
            </p>
          </div>

          <!-- Loading state -->
          <div class="loading-container" *ngIf="loadingOrphaned">
            <mat-spinner></mat-spinner>
            <p>Scanning for orphaned entries...</p>
          </div>

          <!-- Selection header -->
          <div class="results-header" *ngIf="!loadingOrphaned && orphanedVideos.length > 0">
            <div class="results-count">
              <div class="selection-buttons">
                <button mat-stroked-button
                        (click)="toggleAllOrphanedSelection()"
                        [color]="isAllOrphanedSelected ? 'primary' : undefined"
                        matTooltip="Select all orphaned videos">
                  <mat-icon>select_all</mat-icon>
                  All
                </button>
              </div>
              <span class="count-text">
                {{ selectedOrphanedVideos.size > 0 ? selectedOrphanedVideos.size + ' selected of ' : '' }}{{ orphanedVideos.length }} video{{ orphanedVideos.length !== 1 ? 's' : '' }}
              </span>
            </div>
          </div>

          <!-- Orphaned videos list container -->
          <div *ngIf="!loadingOrphaned && orphanedVideos.length > 0" class="management-list-container">
            <div class="management-video-list">
              <div class="management-video-row"
                   *ngFor="let video of orphanedVideos"
                   [class.selected]="selectedOrphanedVideos.has(video.id)"
                   (click)="onManagementVideoClick($event, video.id, 'orphaned')"
                   (contextmenu)="onManagementVideoRightClick($event, video, 'orphaned')">

                <!-- Green status indicator -->
                <div class="status-dot"></div>

                <!-- Date badge (extract from filename) -->
                <div class="date-badge" *ngIf="parseFilename(video.filename).date">
                  {{ formatDateChip(parseFilename(video.filename).date) }}
                </div>

                <!-- Video title -->
                <div class="video-title-text">{{ parseFilename(video.filename).title || video.filename }}</div>

                <!-- File extension -->
                <div class="file-extension">.{{ parseFilename(video.filename).extension }}</div>

                <!-- File path -->
                <div class="file-path">{{ video.current_path }}</div>

                <!-- Actions menu -->
                <button mat-icon-button
                        class="actions-menu"
                        #menuTrigger="matMenuTrigger"
                        [matMenuTriggerFor]="orphanedVideoMenu"
                        [matMenuTriggerData]="{video: video}"
                        (click)="$event.stopPropagation()">
                  <mat-icon>more_vert</mat-icon>
                </button>
              </div>
            </div>
          </div>

          <!-- Empty state -->
          <div class="empty-state" *ngIf="!loadingOrphaned && orphanedVideos.length === 0">
            <mat-icon>check_circle</mat-icon>
            <p>No orphaned entries found</p>
            <p class="secondary">All database entries have valid video files</p>
          </div>
        </div>
      </mat-tab>
    </mat-tab-group>

    <!-- Hidden positioned trigger for management context menus -->
    <div style="visibility: hidden; position: fixed;"
         [style.left.px]="managementContextMenuPosition.x"
         [style.top.px]="managementContextMenuPosition.y"
         [matMenuTriggerFor]="managementContextMenu"
         #managementContextMenuTrigger="matMenuTrigger">
    </div>

    <!-- Unified Management Context Menu -->
    <mat-menu #managementContextMenu="matMenu">
      <!-- Unimported video actions -->
      <ng-container *ngIf="selectedUnimportedVideos.size > 0">
        <button mat-menu-item (click)="importSelectedVideos()">
          <mat-icon>add</mat-icon>
          <span>Import {{ selectedUnimportedVideos.size }} to Database</span>
        </button>
        <button mat-menu-item (click)="deleteSelectedUnimportedVideos()">
          <mat-icon>delete</mat-icon>
          <span>Delete {{ selectedUnimportedVideos.size }} File(s)</span>
        </button>
      </ng-container>

      <!-- Orphaned video actions -->
      <ng-container *ngIf="selectedOrphanedVideos.size > 0 && selectedUnimportedVideos.size === 0">
        <button mat-menu-item (click)="relinkOrphanedVideos()">
          <mat-icon>link</mat-icon>
          <span>Relink {{ selectedOrphanedVideos.size }} Selected</span>
        </button>
        <button mat-menu-item (click)="deleteSelectedOrphans()">
          <mat-icon>delete</mat-icon>
          <span>Delete {{ selectedOrphanedVideos.size }} from Database</span>
        </button>
      </ng-container>
    </mat-menu>

    <!-- Context Menu for Unimported Videos -->
    <mat-menu #unimportedVideoMenu="matMenu">
      <ng-template matMenuContent let-video="video">
        <button mat-menu-item (click)="importSelectedVideos()">
          <mat-icon>add</mat-icon>
          <span>Import to Database</span>
        </button>
        <button mat-menu-item (click)="deleteUnimportedVideo(video)">
          <mat-icon>delete</mat-icon>
          <span>Delete File</span>
        </button>
      </ng-template>
    </mat-menu>

    <!-- Context Menu for Orphaned Database Entries -->
    <mat-menu #orphanedVideoMenu="matMenu">
      <ng-template matMenuContent let-video="video">
        <button mat-menu-item (click)="relinkOrphanedVideos()">
          <mat-icon>link</mat-icon>
          <span>Relink Selected</span>
        </button>
        <button mat-menu-item (click)="deleteSelectedOrphans()">
          <mat-icon>delete</mat-icon>
          <span>Delete from Database</span>
        </button>
      </ng-template>
    </mat-menu>
  </div>

</div>
