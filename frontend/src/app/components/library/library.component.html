<div class="library-container"
     (dragover)="onDragOver($event)"
     (dragleave)="onDragLeave($event)"
     (drop)="onDrop($event)">

  <!-- Drag and Drop Overlay -->
  <div class="drop-zone-overlay" *ngIf="isDragging">
    <div class="drop-zone-content">
      <mat-icon>cloud_upload</mat-icon>
      <h2>Drop videos here to import</h2>
      <p>Release to add videos to your library</p>
    </div>
  </div>

  <!-- Header with stats and actions -->
  <div class="library-header">
    <div class="header-content">
      <div class="title-and-selector">
        <h1>
          <mat-icon>video_library</mat-icon>
          Video Library
        </h1>

        <!-- Library Selector -->
        <div class="library-selector">
          <!-- Loading state -->
          <div *ngIf="isLoadingLibraries" class="library-loading">
            <mat-spinner diameter="24"></mat-spinner>
            <span style="margin-left: 8px;">Connecting to library service...</span>
          </div>

          <!-- Library dropdown when loaded -->
          <mat-form-field appearance="outline" class="library-dropdown" *ngIf="!isLoadingLibraries && libraries.length > 0">
            <mat-label>Library</mat-label>
            <mat-select [(ngModel)]="selectedLibraryId" (selectionChange)="onLibraryChange()">
              <mat-option *ngFor="let library of libraries" [value]="library.id">
                {{ library.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Create library button when no libraries exist -->
          <button mat-raised-button color="accent" (click)="openManageLibraries()" *ngIf="!isLoadingLibraries && libraries.length === 0">
            <mat-icon>add</mat-icon>
            Create Library
          </button>

          <!-- Manage button -->
          <button mat-icon-button (click)="openManageLibraries()" matTooltip="Manage Libraries" *ngIf="!isLoadingLibraries && libraries.length > 0">
            <mat-icon>settings</mat-icon>
          </button>
        </div>
      </div>

    </div>

    <!-- Action buttons - Library View -->
    <div class="header-actions" *ngIf="pageMode === 'library'">
      <button mat-raised-button color="primary" (click)="openImportManager()" matTooltip="Import specific videos from clips folder">
        <mat-icon>file_download</mat-icon>
        Import Videos
      </button>
      <button mat-raised-button color="primary" (click)="downloadFromUrl()" matTooltip="Download video from URL and add to queue">
        <mat-icon>link</mat-icon>
        Download from URL
      </button>
      <button mat-raised-button color="accent" (click)="viewUnimportedVideos()" matTooltip="Scan for new videos, find orphaned entries, and manage your library">
        <mat-icon>manage_search</mat-icon>
        Video Management
        <span class="badge" *ngIf="stats && stats.unlinkedVideos > 0">{{ stats.unlinkedVideos }}</span>
      </button>
    </div>

    <!-- Action buttons - Management View -->
    <div class="header-actions" *ngIf="pageMode === 'management'">
      <button mat-raised-button (click)="backToLibrary()">
        <mat-icon>arrow_back</mat-icon>
        Back to Library
      </button>
      <button mat-raised-button
              color="primary"
              (click)="relinkSelectedOrphans()"
              [disabled]="selectedOrphanedVideos.size === 0"
              matTooltip="Select a new folder that contains the missing files">
        <mat-icon>link</mat-icon>
        Relink Selected ({{ selectedOrphanedVideos.size }})
      </button>
      <button mat-raised-button
              color="warn"
              (click)="deleteSelectedOrphans()"
              [disabled]="selectedOrphanedVideos.size === 0"
              matTooltip="Remove selected entries from database">
        <mat-icon>delete</mat-icon>
        Delete Selected ({{ selectedOrphanedVideos.size }})
      </button>
    </div>
  </div>

  <!-- Main Content -->

  <!-- Library View -->
  <div *ngIf="pageMode === 'library'">
    <!-- Compact Search Box -->
    <div class="compact-search-container">
      <mat-form-field appearance="outline" class="compact-search-field">
        <input matInput
               [(ngModel)]="searchQuery"
               (ngModelChange)="onSearchChange()"
               (focus)="searchFiltersExpanded = true"
               placeholder="Search videos..."
               [matTooltip]="searchQuery || selectedTags.length > 0 ? '' : 'Click to expand search options'">
        <mat-icon matPrefix>search</mat-icon>
        <button mat-icon-button matSuffix
                *ngIf="searchQuery || selectedTags.length > 0"
                (click)="clearSearch(); $event.stopPropagation()"
                matTooltip="Clear search">
          <mat-icon>clear</mat-icon>
        </button>
      </mat-form-field>
    </div>

    <!-- Search Filters Accordion -->
    <mat-accordion class="search-filters-accordion">
      <mat-expansion-panel [expanded]="searchFiltersExpanded" (opened)="searchFiltersExpanded = true" (closed)="searchFiltersExpanded = false">
        <mat-expansion-panel-header>
          <mat-panel-title>
            <mat-icon>tune</mat-icon>
            Filters & Sorting
            <span *ngIf="selectedTags.length > 0" class="active-indicator"> • {{ selectedTags.length }} tag{{ selectedTags.length > 1 ? 's' : '' }}</span>
          </mat-panel-title>
        </mat-expansion-panel-header>

        <!-- Search Filters -->
        <div class="filter-section">
          <div class="filter-section-title">Search in:</div>
          <div class="filter-checkboxes-compact">
            <mat-checkbox [(ngModel)]="searchFilters.filename" (change)="onSearchChange()">Filename</mat-checkbox>
            <mat-checkbox [(ngModel)]="searchFilters.aiDescription" (change)="onSearchChange()">AI Description</mat-checkbox>
            <mat-checkbox [(ngModel)]="searchFilters.transcript" (change)="onSearchChange()">Transcript</mat-checkbox>
            <mat-checkbox [(ngModel)]="searchFilters.analysis" (change)="onSearchChange()">Analysis</mat-checkbox>
            <mat-checkbox [(ngModel)]="searchFilters.tags" (change)="onSearchChange()">Tags</mat-checkbox>
          </div>
        </div>

        <!-- Sort buttons -->
        <div class="filter-section">
          <div class="filter-section-title">Sort by:</div>
          <div class="sort-buttons-compact">
            <button mat-stroked-button
                    (click)="changeSortBy('date')"
                    [color]="sortBy === 'date' ? 'primary' : undefined">
              Date {{ sortBy === 'date' ? (sortOrder === 'desc' ? '↓' : '↑') : '' }}
            </button>
            <button mat-stroked-button
                    (click)="changeSortBy('date-added')"
                    [color]="sortBy === 'date-added' ? 'primary' : undefined">
              Added {{ sortBy === 'date-added' ? (sortOrder === 'desc' ? '↓' : '↑') : '' }}
            </button>
            <button mat-stroked-button
                    (click)="changeSortBy('filename')"
                    [color]="sortBy === 'filename' ? 'primary' : undefined">
              Name {{ sortBy === 'filename' ? (sortOrder === 'desc' ? '↓' : '↑') : '' }}
            </button>
            <button mat-stroked-button
                    (click)="changeSortBy('size')"
                    [color]="sortBy === 'size' ? 'primary' : undefined">
              Size {{ sortBy === 'size' ? (sortOrder === 'desc' ? '↓' : '↑') : '' }}
            </button>
            <button mat-stroked-button
                    (click)="changeSortBy('no-transcript')"
                    [color]="sortBy === 'no-transcript' ? 'primary' : undefined">
              No Transcript {{ sortBy === 'no-transcript' ? (sortOrder === 'desc' ? '↓' : '↑') : '' }}
            </button>
            <button mat-stroked-button
                    (click)="changeSortBy('no-analysis')"
                    [color]="sortBy === 'no-analysis' ? 'primary' : undefined">
              No Analysis {{ sortBy === 'no-analysis' ? (sortOrder === 'desc' ? '↓' : '↑') : '' }}
            </button>
          </div>
        </div>

        <!-- Tag Filters -->
        <div class="filter-section" *ngIf="allTags && (allTags.people.length > 0 || allTags.topic.length > 0)">
          <div class="filter-section-title">
            Filter by Tags
            <button mat-button
                    *ngIf="selectedTags.length > 0"
                    color="warn"
                    (click)="clearTagFilters()"
                    style="margin-left: 8px; font-size: 12px; padding: 0 8px; min-width: auto; line-height: 24px;">
              Clear ({{ selectedTags.length }})
            </button>
          </div>

          <!-- Compact Tag Chips -->
          <div class="tag-chips-compact">
            <div class="tag-group" *ngIf="allTags?.people && allTags.people.length > 0">
              <span class="tag-group-label">People:</span>
              <mat-chip-set class="compact-chip-set">
                <mat-chip
                  *ngFor="let tag of allTags.people.slice(0, 15)"
                  (click)="toggleTag(tag.name)"
                  [class.selected]="isTagSelected(tag.name)"
                  class="compact-chip">
                  {{ tag.name }} <span class="chip-count">({{ tag.count }})</span>
                </mat-chip>
              </mat-chip-set>
            </div>

            <div class="tag-group" *ngIf="allTags?.topic && allTags.topic.length > 0">
              <span class="tag-group-label">Topics:</span>
              <mat-chip-set class="compact-chip-set">
                <mat-chip
                  *ngFor="let tag of allTags.topic.slice(0, 15)"
                  (click)="toggleTag(tag.name)"
                  [class.selected]="isTagSelected(tag.name)"
                  class="compact-chip">
                  {{ tag.name }} <span class="chip-count">({{ tag.count }})</span>
                </mat-chip>
              </mat-chip-set>
            </div>
          </div>
        </div>
      </mat-expansion-panel>
    </mat-accordion>

  <!-- Results count and selection buttons -->
  <div class="results-header" *ngIf="filteredVideos.length > 0 || (!isLoading && filteredVideos.length === 0)">
    <div class="results-count">
      <div class="selection-buttons" *ngIf="filteredVideos.length > 0">
        <button mat-stroked-button
                (click)="toggleAllSelection()"
                [color]="isAllSelected ? 'primary' : undefined"
                matTooltip="Select all visible videos (Cmd/Ctrl+A)">
          <mat-icon>select_all</mat-icon>
          All
        </button>
        <button mat-stroked-button
                (click)="selectAllMissingTranscript()"
                [color]="isMissingTranscriptSelected ? 'primary' : undefined"
                matTooltip="Select all videos missing transcription">
          <mat-icon>subtitles_off</mat-icon>
          No Transcript
        </button>
        <button mat-stroked-button
                (click)="selectAllMissingAnalysis()"
                [color]="isMissingAnalysisSelected ? 'primary' : undefined"
                matTooltip="Select all videos missing AI analysis">
          <mat-icon>psychology</mat-icon>
          No Analysis
        </button>
      </div>
      <span class="count-text">
        Showing {{ filteredVideos.length }} of {{ videos.length }} videos
        <span *ngIf="selectedTags.length > 0"> (filtered by {{ selectedTags.length }} tag{{ selectedTags.length > 1 ? 's' : '' }})</span>
        <span *ngIf="getSelectedCount() > 0" class="selected-info"> • {{ getSelectedCount() }} selected</span>
        <span *ngIf="isInitialLoad && filteredVideos.length > 0" class="loading-more">
          <mat-spinner diameter="16" style="display: inline-block; margin-left: 8px;"></mat-spinner>
          <span style="margin-left: 8px; font-size: 0.9em; color: #666;">Loading more...</span>
        </span>
      </span>
    </div>
    <div class="selection-actions">
      <button
        mat-raised-button
        color="primary"
        [disabled]="getSelectedCount() === 0"
        (click)="analyzeSelected()"
        matTooltip="Analyze or transcribe selected videos">
        <mat-icon>psychology</mat-icon>
        Analyze ({{ getSelectedCount() }})
      </button>
      <button
        mat-raised-button
        color="accent"
        [disabled]="getSelectedCount() !== 1"
        (click)="openVideoEditor()"
        matTooltip="Open video editor (requires exactly one video selected)">
        <mat-icon>video_settings</mat-icon>
        Video Editor
      </button>
    </div>
  </div>

  <!-- Loading spinner (only show when truly loading with no videos yet) -->
  <div class="loading-container" *ngIf="isLoading && filteredVideos.length === 0">
    <mat-spinner></mat-spinner>
    <p>Loading video library...</p>
  </div>

  <!-- Video List with Week Grouping -->
  <div *ngIf="filteredVideos.length > 0" class="video-list-container" (click)="onListContainerClick($event)">
    <div *ngFor="let group of groupedVideos" class="week-group">
      <!-- Week header with collapse toggle -->
      <div class="week-header"
           [class.selected]="isWeekSelected(group.week)"
           (click)="selectWeekSection(group.week, $event)">
        <mat-icon class="collapse-icon" (click)="toggleWeek(group.week, $event); $event.stopPropagation()">
          {{ isWeekCollapsed(group.week) ? 'chevron_right' : 'expand_more' }}
        </mat-icon>
        <span class="week-title">{{ group.week }}</span>
        <span class="week-count">{{ group.videos.length }} video{{ group.videos.length !== 1 ? 's' : '' }}</span>
      </div>

      <!-- Videos in this week -->
      <div *ngIf="!isWeekCollapsed(group.week)" class="week-videos">
        <div *ngFor="let video of group.videos" class="video-card-wrapper">
      <div class="video-card"
           [attr.data-video-id]="video.id"
           [class.long-video]="isLongVideo(video)"
           [class.missing-transcript]="!video.has_transcript"
           [class.missing-analysis]="!video.has_analysis"
           [class.missing-both]="!video.has_transcript && !video.has_analysis"
           [class.highlighted]="isVideoHighlighted(video)"
           [class.selected]="isVideoSelected(video)"
           (click)="highlightVideo(video, $event)"
           (dblclick)="onVideoDoubleClick(video, $event)"
           (contextmenu)="onVideoContextMenu($event, video)">

        <!-- Status Indicator (color-coded based on transcript/analysis status) -->
        <div class="card-status-indicator"
             [class.has-both]="video.has_transcript && video.has_analysis"
             [class.has-transcript-only]="video.has_transcript && !video.has_analysis"
             [class.has-analysis-only]="!video.has_transcript && video.has_analysis"
             [class.has-neither]="!video.has_transcript && !video.has_analysis"
             [matTooltip]="getStatusTooltip(video)">
        </div>

        <!-- Content (non-editable by click) -->
        <div class="card-content">
          <!-- Date chip (with placeholder for alignment when empty) -->
          <mat-chip *ngIf="parseFilename(video.filename).date && !editingVideo[video.id]?.date"
                    class="date-chip">
            {{ formatDateChip(parseFilename(video.filename).date) }}
          </mat-chip>
          <span *ngIf="!parseFilename(video.filename).date && !editingVideo[video.id]?.date"
                class="date-placeholder"></span>
          <input *ngIf="editingVideo[video.id]?.date"
                 type="text"
                 class="date-input"
                 [(ngModel)]="editedValues[video.id].date"
                 (keydown)="onEditKeydown(video, $event)"
                 (blur)="onEditBlur(video, 'date')"
                 (click)="$event.stopPropagation()"
                 placeholder="yyyy-mm-dd"
                 #dateInput>

          <!-- Title (editable on click) -->
          <span *ngIf="!editingVideo[video.id]?.title" class="video-title-text">
            {{ parseFilename(video.filename).title }}
          </span>
          <input *ngIf="editingVideo[video.id]?.title"
                 type="text"
                 class="title-input"
                 [(ngModel)]="editedValues[video.id].title"
                 (keydown)="onEditKeydown(video, $event)"
                 (blur)="onEditBlur(video, 'title')"
                 (click)="$event.stopPropagation()"
                 placeholder="Video title"
                 #titleInput>

          <!-- Extension (with placeholder for alignment when empty) -->
          <span *ngIf="parseFilename(video.filename).extension && !editingVideo[video.id]?.extension"
                class="extension-text">
            .{{ parseFilename(video.filename).extension }}
          </span>
          <span *ngIf="!parseFilename(video.filename).extension && !editingVideo[video.id]?.extension"
                class="extension-placeholder"></span>
          <input *ngIf="editingVideo[video.id]?.extension"
                 type="text"
                 class="extension-input"
                 [(ngModel)]="editedValues[video.id].extension"
                 (keydown)="onEditKeydown(video, $event)"
                 (blur)="onEditBlur(video, 'extension')"
                 (click)="$event.stopPropagation()"
                 placeholder="mp4"
                 #extensionInput>

          <mat-icon *ngIf="isLongVideo(video)" class="long-video-badge" matTooltip="Long video (> 10 minutes)">schedule</mat-icon>

          <!-- Search match indicator -->
          <mat-chip *ngIf="video.matchType && searchQuery" class="match-indicator" [matTooltip]="'Found in: ' + getMatchTypeLabel(video.matchType)">
            <mat-icon>{{ getMatchTypeIcon(video.matchType) }}</mat-icon>
            {{ getMatchTypeLabel(video.matchType) }}
          </mat-chip>

          <!-- Subtitle (duration info) on the right side -->
          <span class="video-subtitle">
            <span *ngIf="video.date_folder">{{ formatDate(video.date_folder) }}</span>
            <span *ngIf="video.duration_seconds"> • {{ formatDuration(video.duration_seconds) }}</span>
          </span>
        </div>

        <!-- Action buttons on the right -->
        <div class="card-actions">
          <button mat-icon-button (click)="onThreeDotsClick($event, video)" matTooltip="More actions">
            <mat-icon>more_vert</mat-icon>
          </button>
          <button mat-icon-button color="warn" (click)="deleteVideo(video); $event.stopPropagation()" matTooltip="Delete video from library">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      </div>
    </div>
      </div>
    </div>
  </div>

  <!-- Context Menu (Right-click) - positioned at cursor -->
  <div style="visibility: hidden; position: fixed;"
       [style.left.px]="contextMenuPosition.x"
       [style.top.px]="contextMenuPosition.y"
       [matMenuTriggerFor]="videoContextMenu"
       #contextMenuTrigger="matMenuTrigger">
  </div>

  <mat-menu #videoContextMenu="matMenu">
    <ng-container *ngIf="contextMenuVideo">
      <!-- Single video actions -->
      <button mat-menu-item (click)="startRenamingVideo(contextMenuVideo)" *ngIf="getSelectedCount() === 1">
        <mat-icon>edit</mat-icon>
        <span>Rename</span>
      </button>
      <button mat-menu-item (click)="openVideoPlayer(contextMenuVideo)" *ngIf="getSelectedCount() === 1">
        <mat-icon>play_arrow</mat-icon>
        <span>Open in Video Editor</span>
      </button>
      <button mat-menu-item (click)="openMetadataEditor(contextMenuVideo)" *ngIf="getSelectedCount() === 1">
        <mat-icon>info</mat-icon>
        <span>View Details</span>
      </button>
      <button mat-menu-item (click)="copyFilename(contextMenuVideo)" *ngIf="getSelectedCount() === 1">
        <mat-icon>content_copy</mat-icon>
        <span>Copy Filename</span>
      </button>
      <button mat-menu-item (click)="openFileLocation(contextMenuVideo)" *ngIf="getSelectedCount() === 1">
        <mat-icon>folder_open</mat-icon>
        <span>Open File Location</span>
      </button>
      <mat-divider *ngIf="getSelectedCount() === 1"></mat-divider>

      <!-- Multi-selection actions -->
      <button mat-menu-item (click)="analyzeSelected()">
        <mat-icon>psychology</mat-icon>
        <span>Analyze{{ getSelectedCount() > 1 ? ' (' + getSelectedCount() + ')' : '' }}</span>
      </button>
      <button mat-menu-item (click)="moveToLibrary()">
        <mat-icon>drive_file_move</mat-icon>
        <span>Move to...{{ getSelectedCount() > 1 ? ' (' + getSelectedCount() + ')' : '' }}</span>
      </button>
      <mat-divider></mat-divider>
      <button mat-menu-item (click)="deleteSelected()">
        <mat-icon color="warn">delete</mat-icon>
        <span>Delete{{ getSelectedCount() > 1 ? ' (' + getSelectedCount() + ')' : '' }}</span>
      </button>
    </ng-container>
  </mat-menu>

  <!-- Empty state -->
  <div class="empty-state" *ngIf="!isLoading && filteredVideos.length === 0">
    <mat-icon>video_library</mat-icon>
    <h2>No videos found</h2>
    <p *ngIf="searchQuery">Try adjusting your search query</p>
    <p *ngIf="!searchQuery && videos.length === 0">Click "Import Videos" to select specific videos or "Scan All" to import all videos from your clips directory</p>
    <p *ngIf="!searchQuery && videos.length > 0">No videos match the current filters</p>
  </div>

  <!-- FLOATING PREVIEW PANEL FOR LIST VIEW -->
  <div
    class="floating-preview-panel"
    *ngIf="isPreviewModalOpen && highlightedVideo"
    [style.left.px]="previewPanelX"
    [style.top.px]="previewPanelY"
    [style.width.px]="previewPanelWidth"
    [style.height.px]="previewPanelHeight"
    [class.dragging]="isDraggingPreviewPanel"
    [class.resizing]="isResizingPreviewPanel">

    <!-- Drag Handle Bar -->
    <div class="preview-panel-header" (mousedown)="startDragPreviewPanel($event)">
      <mat-icon class="drag-icon">drag_indicator</mat-icon>
      <span class="header-title">Preview</span>
      <button mat-icon-button
              (click)="togglePreviewAutoPlay()"
              [color]="previewAutoPlayEnabled ? 'primary' : ''"
              [matTooltip]="previewAutoPlayEnabled ? 'Auto-play: On' : 'Auto-play: Off'"
              (mousedown)="$event.stopPropagation()">
        <mat-icon>{{ previewAutoPlayEnabled ? 'play_circle' : 'pause_circle' }}</mat-icon>
      </button>
      <button mat-icon-button class="close-panel-btn" (click)="closePreviewModal()" (mousedown)="$event.stopPropagation()">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <!-- Video Player -->
    <div class="preview-panel-video">
      <video #previewVideoPlayer
             [src]="getVideoStreamUrl(highlightedVideo)"
             controls
             class="preview-video-player">
      </video>
    </div>

    <!-- Title Section -->
    <div class="preview-panel-title">
      <span class="video-title">{{ parseFilename(highlightedVideo.filename).title }}</span>
    </div>

    <!-- Action Buttons -->
    <div class="preview-panel-actions">
      <button mat-raised-button color="primary" (click)="openVideoPlayer(highlightedVideo)" class="action-btn">
        <mat-icon>edit</mat-icon>
        Video Editor
      </button>
      <button mat-raised-button (click)="openMetadataEditor(highlightedVideo); closePreviewModal()" class="action-btn">
        <mat-icon>info</mat-icon>
        Details
      </button>
    </div>

    <!-- Keyboard Hints -->
    <div class="preview-panel-hints">
      <span><mat-icon>keyboard</mat-icon> Space</span>
      <span><mat-icon>keyboard</mat-icon> ↑↓</span>
      <span><mat-icon>keyboard</mat-icon> Esc</span>
    </div>

    <!-- Resize Handles -->
    <div class="preview-panel-resize-handle preview-panel-resize-handle-right" (mousedown)="startResizePreviewPanel($event)">
      <mat-icon>drag_handle</mat-icon>
    </div>
    <div class="preview-panel-resize-handle preview-panel-resize-handle-left" (mousedown)="startResizePreviewPanelLeft($event)">
      <mat-icon>drag_handle</mat-icon>
    </div>
  </div>
  </div>

  <!-- Management View -->
  <div *ngIf="pageMode === 'management'" class="management-view">
    <div class="management-header">
      <div class="header-content">
        <div>
          <h2>
            <mat-icon>broken_image</mat-icon>
            Orphaned Video Entries
          </h2>
          <p class="description">Database entries where the video file no longer exists on disk.</p>
        </div>
        <div class="header-actions-inline">
          <button mat-raised-button
                  color="accent"
                  (click)="scanDirectoryForVideos()"
                  matTooltip="Scan a directory for videos that haven't been imported yet">
            <mat-icon>folder_open</mat-icon>
            Scan Directory
          </button>
          <button mat-raised-button
                  color="primary"
                  (click)="loadOrphanedVideos()"
                  [disabled]="loadingOrphaned">
            <mat-icon>search</mat-icon>
            {{ loadingOrphaned ? 'Scanning...' : 'Scan for Orphans' }}
          </button>
          <button mat-raised-button
                  color="warn"
                  (click)="pruneAllOrphans()"
                  [disabled]="orphanedVideos.length === 0 || loadingOrphaned"
                  matTooltip="Remove all orphaned entries from database">
            <mat-icon>delete_sweep</mat-icon>
            Prune All ({{ orphanedVideos.length }})
          </button>
        </div>
      </div>
      <p class="count-info" *ngIf="!loadingOrphaned && orphanedVideos.length > 0">
        <mat-icon class="warning-icon">warning</mat-icon>
        {{ orphanedVideos.length }} orphaned entr{{ orphanedVideos.length !== 1 ? 'ies' : 'y' }} found
      </p>
    </div>

    <!-- Loading state -->
    <div class="loading-container" *ngIf="loadingOrphaned">
      <mat-spinner></mat-spinner>
      <p>Scanning for orphaned entries...</p>
    </div>

    <!-- Selection header -->
    <div class="results-header" *ngIf="!loadingOrphaned && orphanedVideos.length > 0">
      <div class="results-count">
        <div class="selection-buttons">
          <button mat-stroked-button
                  (click)="toggleAllOrphanedSelection()"
                  [color]="isAllOrphanedSelected ? 'primary' : undefined"
                  matTooltip="Select all orphaned videos">
            <mat-icon>select_all</mat-icon>
            All
          </button>
        </div>
        <span class="count-text">
          {{ selectedOrphanedVideos.size > 0 ? selectedOrphanedVideos.size + ' selected of ' : '' }}{{ orphanedVideos.length }} video{{ orphanedVideos.length !== 1 ? 's' : '' }}
        </span>
      </div>
    </div>

    <!-- Orphaned videos list -->
    <div *ngIf="!loadingOrphaned && orphanedVideos.length > 0" class="video-list-container orphaned-list">
      <div class="video-item orphaned-item"
           *ngFor="let video of orphanedVideos"
           [class.selected]="selectedOrphanedVideos.has(video.id)"
           (click)="toggleOrphanedVideo(video.id)">
        <div class="video-item-content">
          <div class="checkbox-wrapper">
            <mat-checkbox
              [checked]="selectedOrphanedVideos.has(video.id)"
              (click)="$event.stopPropagation()"
              (change)="toggleOrphanedVideo(video.id)">
            </mat-checkbox>
          </div>
          <div class="video-info-compact">
            <span class="video-title">{{ video.filename }}</span>
            <span class="video-path">{{ video.current_path }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Empty state -->
    <div class="empty-state" *ngIf="!loadingOrphaned && orphanedVideos.length === 0">
      <mat-icon>check_circle</mat-icon>
      <p>No orphaned entries found</p>
      <p class="secondary">All database entries have valid video files</p>
    </div>
  </div>

</div>
