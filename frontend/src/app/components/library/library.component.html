<div class="library-container"
     (dragenter)="onDragEnter($event)"
     (dragover)="onDragOver($event)"
     (dragleave)="onDragLeave($event)"
     (drop)="onDrop($event)">

  <!-- Drag and Drop Overlay -->
  <app-drop-zone-overlay [isVisible]="isDragging"></app-drop-zone-overlay>

  <!-- Library Header Component -->
  <app-library-header
    [libraries]="libraries"
    [selectedLibraryId]="selectedLibraryId"
    [isLoadingLibraries]="isLoadingLibraries"
    [stats]="stats"
    (libraryChange)="onLibraryChange()"
    (manageLibraries)="openManageLibraries()"
    (importVideos)="openImportManager()"
    (downloadFromUrl)="downloadFromUrl()"
    (analytics)="openAnalytics()">
  </app-library-header>

  <!-- Main Content -->

  <!-- Library View -->
  <div class="library-content">
    <!-- Search Bar Component -->
    <app-search-bar
      [searchQuery]="searchQuery"
      [searchFilters]="searchFilters"
      [selectedTags]="selectedTags"
      [fileTypeFilters]="fileTypeFilters"
      [sortBy]="sortBy"
      [sortOrder]="sortOrder"
      [allTags]="allTags"
      [filtersExpanded]="searchFiltersExpanded"
      [showOnlyTitleSuggestions]="showOnlyTitleSuggestions"
      (criteriaChange)="onSearchCriteriaChange($event)"
      (clearAll)="onClearAllSearch()"
      (filtersExpandedChange)="searchFiltersExpanded = $event">
    </app-search-bar>

  <!-- Results Toolbar -->
  <app-results-toolbar
    [totalResults]="filteredVideos.length"
    [totalVideos]="videos.length"
    [selectedCount]="getSelectedCount()"
    [isAllSelected]="isAllSelected"
    [isMissingTranscriptSelected]="isMissingTranscriptSelected"
    [isMissingAnalysisSelected]="isMissingAnalysisSelected"
    [isSearching]="!!searchQuery"
    [showWhenEmpty]="!isLoading"
    (selectAllClick)="toggleAllSelection()"
    (selectMissingTranscriptClick)="selectAllMissingTranscript()"
    (selectMissingAnalysisClick)="selectAllMissingAnalysis()"
    (collapseAllClick)="collapseAllSections()"
    (expandAllClick)="expandAllSections()"
    (analyzeClick)="analyzeSelected()"
    (openEditorClick)="openVideoEditor()"
    (viewDetailsClick)="openMetadataEditorForSelected()">

    <!-- File type menu items -->
    <ng-container fileTypeMenuItems>
      <div class="menu-header" (click)="$event.stopPropagation()">
        <span>Show File Types</span>
        <button mat-button (click)="selectAllFileTypes()">All</button>
        <button mat-icon-button (click)="closeFileTypeMenu()" matTooltip="Close menu">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <mat-divider></mat-divider>
      <button mat-menu-item (click)="$event.stopPropagation(); toggleFileTypeFilter('video')">
        <mat-checkbox [checked]="fileTypeFilters.video" (change)="toggleFileTypeFilter('video')" (click)="$event.stopPropagation()"></mat-checkbox>
        <mat-icon>movie</mat-icon>
        <span>Video (.mov, .mp4, .avi, .mkv, .webm, .m4v, .flv)</span>
      </button>
      <button mat-menu-item (click)="$event.stopPropagation(); toggleFileTypeFilter('audio')">
        <mat-checkbox [checked]="fileTypeFilters.audio" (change)="toggleFileTypeFilter('audio')" (click)="$event.stopPropagation()"></mat-checkbox>
        <mat-icon>audiotrack</mat-icon>
        <span>Audio (.mp3, .m4a, .aac, .flac, .wav, .ogg)</span>
      </button>
      <button mat-menu-item (click)="$event.stopPropagation(); toggleFileTypeFilter('document')">
        <mat-checkbox [checked]="fileTypeFilters.document" (change)="toggleFileTypeFilter('document')" (click)="$event.stopPropagation()"></mat-checkbox>
        <mat-icon>description</mat-icon>
        <span>Document (.pdf, .epub, .mobi, .txt, .md)</span>
      </button>
      <button mat-menu-item (click)="$event.stopPropagation(); toggleFileTypeFilter('image')">
        <mat-checkbox [checked]="fileTypeFilters.image" (change)="toggleFileTypeFilter('image')" (click)="$event.stopPropagation()"></mat-checkbox>
        <mat-icon>image</mat-icon>
        <span>Image (.jpg, .png, .gif, .webp, .bmp)</span>
      </button>
      <button mat-menu-item (click)="$event.stopPropagation(); toggleFileTypeFilter('webpage')">
        <mat-checkbox [checked]="fileTypeFilters.webpage" (change)="toggleFileTypeFilter('webpage')" (click)="$event.stopPropagation()"></mat-checkbox>
        <mat-icon>public</mat-icon>
        <span>Webpage (.html, .htm, .mhtml)</span>
      </button>
    </ng-container>
  </app-results-toolbar>

  <!-- Loading State -->
  <app-loading-state
    *ngIf="isLoading && filteredVideos.length === 0"
    message="Loading video library...">
  </app-loading-state>

  <!-- Video List with CascadeListComponent -->
  <cascade-list
    #cascadeList
    *ngIf="filteredVideos.length > 0"
    [items]="videosAsListItems"
    [displayConfig]="listDisplayConfig"
    [groupConfig]="listGroupConfig"
    [keyboardConfig]="listKeyboardConfig"
    [childrenConfig]="listChildrenConfig"
    [selectionMode]="SelectionMode.Multiple"
    [selectedItemIds]="selectedVideos"
    [highlightedItemId]="highlightedVideo?.id || null"
    [statusMapper]="getVideoStatusMapper"
    [progressMapper]="videoProgressMapper"
    [progressVersion]="progressVersion"
    [initialCollapsedGroups]="collapsedWeeks"
    (itemClick)="onListItemClick($event)"
    (itemDoubleClick)="onListItemDoubleClick($event)"
    (itemsSelected)="onListItemsSelected($event)"
    (itemsDeselected)="onListItemsDeselected($event)"
    (itemHighlighted)="onListItemHighlighted($event)"
    (spaceAction)="onListSpaceAction($event)"
    (deleteAction)="onListDeleteAction($event)"
    (contextMenu)="onListContextMenu($event)">
  </cascade-list>

  <!-- Video Context Menu -->
  <app-video-context-menu
    [video]="contextMenuVideo"
    [position]="contextMenuPosition"
    [selectedCount]="getSelectedCount()"
    [canAnalyze]="canAnalyzeMedia(contextMenuVideo)"
    [hasSuggestedTitle]="!!contextMenuVideo?.suggested_title"
    (menuAction)="handleContextMenuAction($event)">
  </app-video-context-menu>

  <!-- Empty State -->
  <app-empty-state
    *ngIf="!isLoading && filteredVideos.length === 0"
    icon="video_library"
    title="No videos found"
    [message]="getEmptyStateMessage()">
  </app-empty-state>

  <!-- FLOATING PREVIEW PANEL FOR LIST VIEW -->
  <!-- Preview dialog is now handled by MatDialog -->

  <!-- Floating import indicator (shows when import is minimized) -->
  <app-import-indicator (reopen)="reopenImportDialog()"></app-import-indicator>
  </div>


</div>
