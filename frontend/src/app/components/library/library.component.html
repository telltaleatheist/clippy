<div class="library-container"
     (dragover)="onDragOver($event)"
     (dragleave)="onDragLeave($event)"
     (drop)="onDrop($event)">

  <!-- Drag and Drop Overlay -->
  <div class="drop-zone-overlay" *ngIf="isDragging">
    <div class="drop-zone-content">
      <mat-icon>cloud_upload</mat-icon>
      <h2>Drop videos here to import</h2>
      <p>Release to add videos to your library</p>
    </div>
  </div>

  <!-- Header with stats and actions -->
  <div class="library-header">
    <div class="header-content">
      <div class="title-and-selector">
        <h1>
          <mat-icon>video_library</mat-icon>
          Video Library
        </h1>

        <!-- Library Selector -->
        <div class="library-selector">
          <!-- Loading state -->
          <div *ngIf="isLoadingLibraries" class="library-loading">
            <mat-spinner diameter="24"></mat-spinner>
            <span style="margin-left: 8px;">Connecting to library service...</span>
          </div>

          <!-- Library dropdown when loaded -->
          <mat-form-field appearance="outline" class="library-dropdown" *ngIf="!isLoadingLibraries && libraries.length > 0">
            <mat-label>Library</mat-label>
            <mat-select [(ngModel)]="selectedLibraryId" (selectionChange)="onLibraryChange()">
              <mat-option *ngFor="let library of libraries" [value]="library.id">
                {{ library.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Create library button when no libraries exist -->
          <button mat-raised-button color="accent" (click)="openManageLibraries()" *ngIf="!isLoadingLibraries && libraries.length === 0">
            <mat-icon>add</mat-icon>
            Create Library
          </button>

          <!-- Manage button -->
          <button mat-icon-button (click)="openManageLibraries()" matTooltip="Manage Libraries" *ngIf="!isLoadingLibraries && libraries.length > 0">
            <mat-icon>settings</mat-icon>
          </button>
        </div>
      </div>

      <!-- Stats chips -->
      <div class="stats-chips" *ngIf="stats">
        <mat-chip-set>
          <mat-chip>
            <mat-icon>videocam</mat-icon>
            {{ stats.linkedVideos }} Videos
          </mat-chip>
          <mat-chip *ngIf="stats.withTranscripts > 0">
            <mat-icon>subtitles</mat-icon>
            {{ stats.withTranscripts }} Transcribed
          </mat-chip>
          <mat-chip *ngIf="stats.withAnalyses > 0">
            <mat-icon>analytics</mat-icon>
            {{ stats.withAnalyses }} Analyzed
          </mat-chip>
        </mat-chip-set>
      </div>
    </div>

    <!-- Action buttons -->
    <div class="header-actions">
      <button mat-raised-button color="primary" (click)="openImportManager()" matTooltip="Import specific videos from clips folder">
        <mat-icon>file_download</mat-icon>
        Import Videos
      </button>
      <button mat-raised-button color="primary" (click)="downloadFromUrl()" matTooltip="Download video from URL and add to queue">
        <mat-icon>link</mat-icon>
        Download from URL
      </button>
      <button mat-raised-button (click)="scanLibrary()" matTooltip="Scan and import all videos from clips folder">
        <mat-icon>sync</mat-icon>
        Scan All
      </button>
      <button
        mat-raised-button
        color="warn"
        (click)="pruneOrphanedVideos()"
        *ngIf="stats && stats.unlinkedVideos > 0"
        [matTooltip]="'Delete ' + stats.unlinkedVideos + ' orphaned video' + (stats.unlinkedVideos > 1 ? 's' : '') + ' from database'">
        <mat-icon>cleaning_services</mat-icon>
        Prune ({{ stats.unlinkedVideos }})
      </button>
    </div>
  </div>

  <!-- Tabs -->
  <mat-tab-group [(selectedIndex)]="selectedTabIndex" (selectedIndexChange)="onTabChange($event)" [dynamicHeight]="false" class="library-tabs">
    <!-- Videos Tab -->
    <mat-tab label="Videos">
      <ng-template matTabContent>
        <div class="tab-content">
  <!-- Search and Filter Bar -->
  <div class="search-bar">
    <mat-form-field appearance="outline" class="search-field">
      <mat-label>Search videos</mat-label>
      <input matInput
             [(ngModel)]="searchQuery"
             (ngModelChange)="onSearchChange()"
             placeholder="Search by filename or date...">
      <mat-icon matPrefix>search</mat-icon>
    </mat-form-field>

    <!-- Sort buttons -->
    <div class="sort-buttons">
      <button mat-stroked-button
              (click)="changeSortBy('date')"
              [color]="sortBy === 'date' ? 'primary' : undefined"
              matTooltip="Sort by video creation date (from filename)">
        <mat-icon>event</mat-icon>
        Date Created {{ sortBy === 'date' ? (sortOrder === 'desc' ? '↓' : '↑') : '' }}
      </button>
      <button mat-stroked-button
              (click)="changeSortBy('date-added')"
              [color]="sortBy === 'date-added' ? 'primary' : undefined"
              matTooltip="Sort by when video was added to library">
        <mat-icon>add_circle</mat-icon>
        Date Added {{ sortBy === 'date-added' ? (sortOrder === 'desc' ? '↓' : '↑') : '' }}
      </button>
      <button mat-stroked-button
              (click)="changeSortBy('filename')"
              [color]="sortBy === 'filename' ? 'primary' : undefined">
        <mat-icon>sort_by_alpha</mat-icon>
        Name {{ sortBy === 'filename' ? (sortOrder === 'desc' ? '↓' : '↑') : '' }}
      </button>
      <button mat-stroked-button
              (click)="changeSortBy('size')"
              [color]="sortBy === 'size' ? 'primary' : undefined">
        <mat-icon>data_usage</mat-icon>
        Size {{ sortBy === 'size' ? (sortOrder === 'desc' ? '↓' : '↑') : '' }}
      </button>
      <button mat-stroked-button
              (click)="changeSortBy('no-transcript')"
              [color]="sortBy === 'no-transcript' ? 'primary' : undefined"
              matTooltip="Sort by missing transcription">
        <mat-icon>subtitles_off</mat-icon>
        No Transcript {{ sortBy === 'no-transcript' ? (sortOrder === 'desc' ? '↓' : '↑') : '' }}
      </button>
      <button mat-stroked-button
              (click)="changeSortBy('no-analysis')"
              [color]="sortBy === 'no-analysis' ? 'primary' : undefined"
              matTooltip="Sort by missing analysis">
        <mat-icon>psychology</mat-icon>
        No Analysis {{ sortBy === 'no-analysis' ? (sortOrder === 'desc' ? '↓' : '↑') : '' }}
      </button>
    </div>
  </div>

  <!-- Tag Filters -->
  <div class="tag-filters" *ngIf="allTags && (allTags.people.length > 0 || allTags.topic.length > 0)">
    <button mat-stroked-button (click)="showTagFilters = !showTagFilters" class="toggle-filters-btn">
      <mat-icon>{{ showTagFilters ? 'expand_less' : 'expand_more' }}</mat-icon>
      Filter by Tags
      <span *ngIf="selectedTags.length > 0" class="selected-count">({{ selectedTags.length }})</span>
    </button>

    <div class="tag-filter-content" *ngIf="showTagFilters">
      <!-- Selected Tags (Active Filters) -->
      <div class="selected-tags" *ngIf="selectedTags.length > 0">
        <strong>Active Filters:</strong>
        <mat-chip-set>
          <mat-chip *ngFor="let tag of selectedTags" (removed)="toggleTag(tag)" [removable]="true">
            {{ tag }}
            <mat-icon matChipRemove>cancel</mat-icon>
          </mat-chip>
        </mat-chip-set>
        <button mat-button color="warn" (click)="clearTagFilters()">Clear All</button>
      </div>

      <!-- People Tags -->
      <div class="tag-section" *ngIf="allTags?.people && allTags.people.length > 0">
        <h3>People</h3>
        <mat-chip-set>
          <mat-chip
            *ngFor="let tag of allTags.people.slice(0, 20)"
            (click)="toggleTag(tag.name)"
            [class.selected]="isTagSelected(tag.name)"
            class="clickable-chip people-chip">
            {{ tag.name }} ({{ tag.count }})
          </mat-chip>
        </mat-chip-set>
      </div>

      <!-- Topic Tags -->
      <div class="tag-section" *ngIf="allTags?.topic && allTags.topic.length > 0">
        <h3>Topics</h3>
        <mat-chip-set>
          <mat-chip
            *ngFor="let tag of allTags.topic.slice(0, 20)"
            (click)="toggleTag(tag.name)"
            [class.selected]="isTagSelected(tag.name)"
            class="clickable-chip topic-chip">
            {{ tag.name }} ({{ tag.count }})
          </mat-chip>
        </mat-chip-set>
      </div>
    </div>
  </div>

  <!-- Results count and master checkbox -->
  <div class="results-header" *ngIf="filteredVideos.length > 0 || (!isLoading && filteredVideos.length === 0)">
    <div class="results-count">
      <div class="selection-checkboxes" *ngIf="filteredVideos.length > 0">
        <mat-checkbox
          [checked]="isAllSelected"
          [indeterminate]="getSelectedCount() > 0 && !isAllSelected"
          (change)="toggleAllSelection()"
          matTooltip="Select all visible videos">
          All
        </mat-checkbox>
        <mat-checkbox
          (change)="selectAllMissingTranscript()"
          matTooltip="Select all videos missing transcription">
          <mat-icon class="checkbox-icon">subtitles_off</mat-icon>
          No Transcript
        </mat-checkbox>
        <mat-checkbox
          (change)="selectAllMissingAnalysis()"
          matTooltip="Select all videos missing AI analysis">
          <mat-icon class="checkbox-icon">psychology</mat-icon>
          No Analysis
        </mat-checkbox>
      </div>
      <span class="count-text">
        Showing {{ filteredVideos.length }} of {{ videos.length }} videos
        <span *ngIf="selectedTags.length > 0"> (filtered by {{ selectedTags.length }} tag{{ selectedTags.length > 1 ? 's' : '' }})</span>
        <span *ngIf="getSelectedCount() > 0" class="selected-info"> • {{ getSelectedCount() }} selected</span>
        <span *ngIf="isInitialLoad && filteredVideos.length > 0" class="loading-more">
          <mat-spinner diameter="16" style="display: inline-block; margin-left: 8px;"></mat-spinner>
          <span style="margin-left: 8px; font-size: 0.9em; color: #666;">Loading more...</span>
        </span>
      </span>
    </div>
    <div class="selection-actions">
      <button
        mat-raised-button
        color="primary"
        [disabled]="getSelectedCount() === 0"
        (click)="analyzeSelected()"
        matTooltip="Analyze or transcribe selected videos">
        <mat-icon>psychology</mat-icon>
        Analyze ({{ getSelectedCount() }})
      </button>
      <button
        mat-raised-button
        color="accent"
        [disabled]="getSelectedCount() === 0"
        (click)="moveToLibrary()"
        matTooltip="Move or copy selected videos to another library">
        <mat-icon>drive_file_move</mat-icon>
        Move to... ({{ getSelectedCount() }})
      </button>
      <button
        mat-raised-button
        color="warn"
        [disabled]="getSelectedCount() === 0"
        (click)="deleteSelected()"
        matTooltip="Delete selected videos">
        <mat-icon>delete</mat-icon>
        Delete ({{ getSelectedCount() }})
      </button>
    </div>
  </div>

  <!-- Loading spinner (only show when truly loading with no videos yet) -->
  <div class="loading-container" *ngIf="isLoading && filteredVideos.length === 0">
    <mat-spinner></mat-spinner>
    <p>Loading video library...</p>
  </div>

  <!-- Video List with Virtual Scrolling -->
  <cdk-virtual-scroll-viewport
    *ngIf="filteredVideos.length > 0"
    [itemSize]="itemSize"
    class="video-list-viewport">

    <div *cdkVirtualFor="let video of filteredVideos" class="video-card-wrapper">
      <div class="video-card"
           [class.long-video]="isLongVideo(video)"
           [class.missing-transcript]="!video.has_transcript"
           [class.missing-analysis]="!video.has_analysis"
           [class.missing-both]="!video.has_transcript && !video.has_analysis">
        <!-- Checkbox on the left -->
        <div class="card-checkbox" (click)="$event.stopPropagation()">
          <mat-checkbox
            [checked]="isVideoSelected(video)"
            (change)="toggleVideoSelection(video)">
          </mat-checkbox>
        </div>

        <!-- Primary actions (play and info) -->
        <div class="card-primary-actions">
          <button mat-icon-button
                  matTooltip="Open in video editor"
                  (click)="openVideoPlayer(video); $event.stopPropagation()">
            <mat-icon>play_arrow</mat-icon>
          </button>
          <button mat-icon-button
                  matTooltip="View video info & metadata"
                  (click)="openMetadataEditor(video); $event.stopPropagation()">
            <mat-icon>info</mat-icon>
          </button>
        </div>

        <!-- Icon -->
        <div class="card-icon">
          <mat-icon>movie</mat-icon>
        </div>

        <!-- Content (clickable) - inline editable single line -->
        <div class="card-content" (click)="onVideoClick(video, $event)">
          <!-- Date chip (editable on click) -->
          <mat-chip *ngIf="parseFilename(video.filename).date && !editingVideo[video.id]?.date"
                    class="date-chip"
                    (click)="startEditing(video, 'date', $event)">
            {{ formatDateChip(parseFilename(video.filename).date) }}
          </mat-chip>
          <input *ngIf="editingVideo[video.id]?.date"
                 type="text"
                 class="date-input"
                 [(ngModel)]="editedValues[video.id].date"
                 (keydown)="onEditKeydown(video, $event)"
                 (blur)="onEditBlur(video, 'date')"
                 (click)="$event.stopPropagation()"
                 placeholder="yyyy-mm-dd"
                 #dateInput>

          <!-- Title (editable on click) -->
          <span *ngIf="!editingVideo[video.id]?.title" class="video-title-text">
            {{ parseFilename(video.filename).title }}
          </span>
          <input *ngIf="editingVideo[video.id]?.title"
                 type="text"
                 class="title-input"
                 [(ngModel)]="editedValues[video.id].title"
                 (keydown)="onEditKeydown(video, $event)"
                 (blur)="onEditBlur(video, 'title')"
                 (click)="$event.stopPropagation()"
                 placeholder="Video title"
                 #titleInput>

          <!-- Extension (editable on click) -->
          <span *ngIf="parseFilename(video.filename).extension && !editingVideo[video.id]?.extension"
                class="extension-text"
                (click)="startEditing(video, 'extension', $event)">
            .{{ parseFilename(video.filename).extension }}
          </span>
          <input *ngIf="editingVideo[video.id]?.extension"
                 type="text"
                 class="extension-input"
                 [(ngModel)]="editedValues[video.id].extension"
                 (keydown)="onEditKeydown(video, $event)"
                 (blur)="onEditBlur(video, 'extension')"
                 (click)="$event.stopPropagation()"
                 placeholder="mp4"
                 #extensionInput>

          <mat-icon *ngIf="isLongVideo(video)" class="long-video-badge" matTooltip="Long video (> 10 minutes)">schedule</mat-icon>

          <!-- Subtitle (duration info) on the right side -->
          <span class="video-subtitle">
            <span *ngIf="video.date_folder">{{ formatDate(video.date_folder) }}</span>
            <span *ngIf="video.duration_seconds"> • {{ formatDuration(video.duration_seconds) }}</span>
          </span>
        </div>

        <!-- Action buttons on the right -->
        <div class="card-actions">
          <button mat-icon-button [matMenuTriggerFor]="videoActionsMenu" (click)="$event.stopPropagation()" matTooltip="More actions">
            <mat-icon>more_vert</mat-icon>
          </button>
          <button mat-icon-button color="warn" (click)="deleteVideo(video); $event.stopPropagation()" matTooltip="Delete video from library">
            <mat-icon>delete</mat-icon>
          </button>

          <!-- Actions Menu -->
          <mat-menu #videoActionsMenu="matMenu">
            <button mat-menu-item (click)="openAnalyzeDialog(video)">
              <mat-icon>psychology</mat-icon>
              <span>Analyze</span>
            </button>
          </mat-menu>
        </div>
      </div>
    </div>
  </cdk-virtual-scroll-viewport>

  <!-- Empty state -->
  <div class="empty-state" *ngIf="!isLoading && filteredVideos.length === 0">
    <mat-icon>video_library</mat-icon>
    <h2>No videos found</h2>
    <p *ngIf="searchQuery">Try adjusting your search query</p>
    <p *ngIf="!searchQuery && videos.length === 0">Click "Import Videos" to select specific videos or "Scan All" to import all videos from your clips directory</p>
    <p *ngIf="!searchQuery && videos.length > 0">No videos match the current filters</p>
  </div>
        </div>
      </ng-template>
    </mat-tab>

    <!-- Unimported Tab -->
    <mat-tab label="Unimported">
      <ng-template matTabContent>
        <div class="unimported-tab">
          <!-- Header with selection controls -->
          <div class="unimported-header">
            <div class="selection-info">
              <mat-checkbox
                [checked]="isAllUnimportedSelected"
                (change)="toggleAllUnimportedSelection()"
                [disabled]="unimportedVideos.length === 0">
                Select All
              </mat-checkbox>
              <span class="selection-count" *ngIf="selectedUnimportedVideos.size > 0">
                {{ selectedUnimportedVideos.size }} selected
              </span>
            </div>
            <button
              mat-raised-button
              color="primary"
              (click)="importSelectedVideos()"
              [disabled]="selectedUnimportedVideos.size === 0">
              <mat-icon>cloud_upload</mat-icon>
              Import Selected ({{ selectedUnimportedVideos.size }})
            </button>
          </div>

          <!-- Loading state -->
          <div class="loading-state" *ngIf="loadingUnimported">
            <mat-spinner diameter="50"></mat-spinner>
            <p>Scanning for unimported videos...</p>
          </div>

          <!-- Unimported videos list -->
          <div class="unimported-list" *ngIf="!loadingUnimported && unimportedVideos.length > 0">
            <mat-card *ngFor="let video of unimportedVideos" class="unimported-video-card">
              <div class="unimported-video-content">
                <mat-checkbox
                  [checked]="isUnimportedVideoSelected(video)"
                  (change)="toggleUnimportedSelection(video)">
                </mat-checkbox>
                <div class="video-info">
                  <div class="video-filename">
                    <mat-icon>movie</mat-icon>
                    <span>{{ video.filename }}</span>
                  </div>
                  <div class="video-details">
                    <span *ngIf="video.dateFolder" class="date-folder">
                      <mat-icon>folder</mat-icon>
                      {{ video.dateFolder }}
                    </span>
                    <span class="file-path">{{ video.fullPath }}</span>
                  </div>
                </div>
              </div>
            </mat-card>
          </div>

          <!-- Empty state -->
          <div class="empty-state" *ngIf="!loadingUnimported && unimportedVideos.length === 0">
            <mat-icon>check_circle</mat-icon>
            <h2>All videos are imported</h2>
            <p>No unimported videos found in your clips folder</p>
            <p class="help-text">New videos added to {{ activeLibrary?.clipsFolderPath }} will appear here</p>
          </div>
        </div>
      </ng-template>
    </mat-tab>
  </mat-tab-group>
</div>
