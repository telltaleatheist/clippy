<div class="library-container"
     (dragover)="onDragOver($event)"
     (dragleave)="onDragLeave($event)"
     (drop)="onDrop($event)">

  <!-- Drag and Drop Overlay -->
  <div class="drop-zone-overlay" *ngIf="isDragging">
    <div class="drop-zone-content">
      <mat-icon>cloud_upload</mat-icon>
      <h2>Drop videos here to import</h2>
      <p>Release to add videos to your library</p>
    </div>
  </div>

  <!-- Header with stats and actions -->
  <div class="library-header">
    <div class="header-content">
      <div class="title-and-selector">
        <h1>
          <mat-icon>video_library</mat-icon>
          Video Library
        </h1>

        <!-- Library Selector -->
        <div class="library-selector">
          <!-- Loading state -->
          <div *ngIf="isLoadingLibraries" class="library-loading">
            <mat-spinner diameter="24"></mat-spinner>
            <span style="margin-left: 8px;">Connecting to library service...</span>
          </div>

          <!-- Library dropdown when loaded -->
          <mat-form-field appearance="outline" class="library-dropdown" *ngIf="!isLoadingLibraries && libraries.length > 0">
            <mat-label>Library</mat-label>
            <mat-select [(ngModel)]="selectedLibraryId" (selectionChange)="onLibraryChange()">
              <mat-option *ngFor="let library of libraries" [value]="library.id">
                {{ library.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Create library button when no libraries exist -->
          <button mat-raised-button color="accent" (click)="openManageLibraries()" *ngIf="!isLoadingLibraries && libraries.length === 0">
            <mat-icon>add</mat-icon>
            Create Library
          </button>

          <!-- Manage button -->
          <button mat-icon-button (click)="openManageLibraries()" matTooltip="Manage Libraries" *ngIf="!isLoadingLibraries && libraries.length > 0">
            <mat-icon>settings</mat-icon>
          </button>
        </div>
      </div>

    </div>

    <!-- Action buttons -->
    <div class="header-actions">
      <button mat-raised-button color="primary" (click)="openImportManager()" matTooltip="Import specific videos from clips folder">
        <mat-icon>file_download</mat-icon>
        Import Videos
      </button>
      <button mat-raised-button color="primary" (click)="downloadFromUrl()" matTooltip="Download video from URL and add to queue">
        <mat-icon>link</mat-icon>
        Download from URL
      </button>
      <button mat-raised-button color="accent" (click)="viewUnimportedVideos()" matTooltip="View and import unimported videos from clips folder">
        <mat-icon>folder_open</mat-icon>
        View Unimported Videos
      </button>
      <button
        mat-raised-button
        color="warn"
        (click)="pruneOrphanedVideos()"
        *ngIf="stats && stats.unlinkedVideos > 0"
        [matTooltip]="'Delete ' + stats.unlinkedVideos + ' orphaned video' + (stats.unlinkedVideos > 1 ? 's' : '') + ' from database'">
        <mat-icon>cleaning_services</mat-icon>
        Prune ({{ stats.unlinkedVideos }})
      </button>
    </div>
  </div>

  <!-- Main Content -->

  <!-- Search and Filters Accordion -->
  <mat-accordion class="search-filters-accordion">
    <mat-expansion-panel [expanded]="searchFiltersExpanded">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>search</mat-icon>
          Search & Filters
          <span *ngIf="searchQuery || selectedTags.length > 0" class="active-indicator"> • Active</span>
        </mat-panel-title>
      </mat-expansion-panel-header>

      <!-- Search Bar -->
      <div class="search-bar">
        <mat-form-field appearance="outline" class="search-field">
          <mat-label>Search videos</mat-label>
          <input matInput
                 [(ngModel)]="searchQuery"
                 (ngModelChange)="onSearchChange()"
                 placeholder="Search filenames, transcripts, analyses, tags, and AI descriptions...">
          <mat-icon matPrefix>search</mat-icon>
        </mat-form-field>

        <!-- Search filter toggles -->
        <button mat-stroked-button
                (click)="showSearchFilters = !showSearchFilters"
                matTooltip="Select which metadata types to search">
          <mat-icon>filter_list</mat-icon>
          Search Filters
        </button>
      </div>

      <!-- Search Filters Checkboxes -->
      <div class="search-filter-checkboxes" *ngIf="showSearchFilters">
        <div class="filter-options">
          <mat-checkbox [(ngModel)]="searchFilters.filename" (change)="onSearchChange()">
            <mat-icon>description</mat-icon>
            Filename
          </mat-checkbox>
          <mat-checkbox [(ngModel)]="searchFilters.aiDescription" (change)="onSearchChange()">
            <mat-icon>smart_toy</mat-icon>
            AI Description
          </mat-checkbox>
          <mat-checkbox [(ngModel)]="searchFilters.transcript" (change)="onSearchChange()">
            <mat-icon>subtitles</mat-icon>
            Transcript
          </mat-checkbox>
          <mat-checkbox [(ngModel)]="searchFilters.analysis" (change)="onSearchChange()">
            <mat-icon>analytics</mat-icon>
            Analysis
          </mat-checkbox>
          <mat-checkbox [(ngModel)]="searchFilters.tags" (change)="onSearchChange()">
            <mat-icon>label</mat-icon>
            Tags
          </mat-checkbox>
        </div>
      </div>

      <!-- Sort buttons -->
      <div class="sort-buttons">
        <button mat-stroked-button
                (click)="changeSortBy('date')"
                [color]="sortBy === 'date' ? 'primary' : undefined"
                matTooltip="Sort by video creation date (from filename)">
          <mat-icon>event</mat-icon>
          Date Created {{ sortBy === 'date' ? (sortOrder === 'desc' ? '↓' : '↑') : '' }}
        </button>
        <button mat-stroked-button
                (click)="changeSortBy('date-added')"
                [color]="sortBy === 'date-added' ? 'primary' : undefined"
                matTooltip="Sort by when video was added to library">
          <mat-icon>add_circle</mat-icon>
          Date Added {{ sortBy === 'date-added' ? (sortOrder === 'desc' ? '↓' : '↑') : '' }}
        </button>
        <button mat-stroked-button
                (click)="changeSortBy('filename')"
                [color]="sortBy === 'filename' ? 'primary' : undefined">
          <mat-icon>sort_by_alpha</mat-icon>
          Name {{ sortBy === 'filename' ? (sortOrder === 'desc' ? '↓' : '↑') : '' }}
        </button>
        <button mat-stroked-button
                (click)="changeSortBy('size')"
                [color]="sortBy === 'size' ? 'primary' : undefined">
          <mat-icon>data_usage</mat-icon>
          Size {{ sortBy === 'size' ? (sortOrder === 'desc' ? '↓' : '↑') : '' }}
        </button>
        <button mat-stroked-button
                (click)="changeSortBy('no-transcript')"
                [color]="sortBy === 'no-transcript' ? 'primary' : undefined"
                matTooltip="Sort by missing transcription">
          <mat-icon>subtitles_off</mat-icon>
          No Transcript {{ sortBy === 'no-transcript' ? (sortOrder === 'desc' ? '↓' : '↑') : '' }}
        </button>
        <button mat-stroked-button
                (click)="changeSortBy('no-analysis')"
                [color]="sortBy === 'no-analysis' ? 'primary' : undefined"
                matTooltip="Sort by missing analysis">
          <mat-icon>psychology</mat-icon>
          No Analysis {{ sortBy === 'no-analysis' ? (sortOrder === 'desc' ? '↓' : '↑') : '' }}
        </button>
      </div>

      <!-- Tag Filters -->
      <div class="tag-filters" *ngIf="allTags && (allTags.people.length > 0 || allTags.topic.length > 0)">
        <button mat-stroked-button (click)="showTagFilters = !showTagFilters" class="toggle-filters-btn">
          <mat-icon>{{ showTagFilters ? 'expand_less' : 'expand_more' }}</mat-icon>
          Filter by Tags
          <span *ngIf="selectedTags.length > 0" class="selected-count">({{ selectedTags.length }})</span>
        </button>

        <div class="tag-filter-content" *ngIf="showTagFilters">
          <!-- Selected Tags (Active Filters) -->
          <div class="selected-tags" *ngIf="selectedTags.length > 0">
            <strong>Active Filters:</strong>
            <mat-chip-set>
              <mat-chip *ngFor="let tag of selectedTags" (removed)="toggleTag(tag)" [removable]="true">
                {{ tag }}
                <mat-icon matChipRemove>cancel</mat-icon>
              </mat-chip>
            </mat-chip-set>
            <button mat-button color="warn" (click)="clearTagFilters()">Clear All</button>
          </div>

          <!-- People Tags -->
          <div class="tag-section" *ngIf="allTags?.people && allTags.people.length > 0">
            <h3>People</h3>
            <mat-chip-set>
              <mat-chip
                *ngFor="let tag of allTags.people.slice(0, 20)"
                (click)="toggleTag(tag.name)"
                [class.selected]="isTagSelected(tag.name)"
                class="clickable-chip people-chip">
                {{ tag.name }} ({{ tag.count }})
              </mat-chip>
            </mat-chip-set>
          </div>

          <!-- Topic Tags -->
          <div class="tag-section" *ngIf="allTags?.topic && allTags.topic.length > 0">
            <h3>Topics</h3>
            <mat-chip-set>
              <mat-chip
                *ngFor="let tag of allTags.topic.slice(0, 20)"
                (click)="toggleTag(tag.name)"
                [class.selected]="isTagSelected(tag.name)"
                class="clickable-chip topic-chip">
                {{ tag.name }} ({{ tag.count }})
              </mat-chip>
            </mat-chip-set>
          </div>
        </div>
      </div>
    </mat-expansion-panel>
  </mat-accordion>

  <!-- Results count and selection buttons -->
  <div class="results-header" *ngIf="filteredVideos.length > 0 || (!isLoading && filteredVideos.length === 0)">
    <div class="results-count">
      <div class="selection-buttons" *ngIf="filteredVideos.length > 0">
        <button mat-stroked-button
                (click)="toggleAllSelection()"
                [color]="isAllSelected ? 'primary' : undefined"
                matTooltip="Select all visible videos (Cmd/Ctrl+A)">
          <mat-icon>select_all</mat-icon>
          All
        </button>
        <button mat-stroked-button
                (click)="selectAllMissingTranscript()"
                [color]="isMissingTranscriptSelected ? 'primary' : undefined"
                matTooltip="Select all videos missing transcription">
          <mat-icon>subtitles_off</mat-icon>
          No Transcript
        </button>
        <button mat-stroked-button
                (click)="selectAllMissingAnalysis()"
                [color]="isMissingAnalysisSelected ? 'primary' : undefined"
                matTooltip="Select all videos missing AI analysis">
          <mat-icon>psychology</mat-icon>
          No Analysis
        </button>
      </div>
      <span class="count-text">
        Showing {{ filteredVideos.length }} of {{ videos.length }} videos
        <span *ngIf="selectedTags.length > 0"> (filtered by {{ selectedTags.length }} tag{{ selectedTags.length > 1 ? 's' : '' }})</span>
        <span *ngIf="getSelectedCount() > 0" class="selected-info"> • {{ getSelectedCount() }} selected</span>
        <span *ngIf="isInitialLoad && filteredVideos.length > 0" class="loading-more">
          <mat-spinner diameter="16" style="display: inline-block; margin-left: 8px;"></mat-spinner>
          <span style="margin-left: 8px; font-size: 0.9em; color: #666;">Loading more...</span>
        </span>
      </span>
    </div>
    <div class="selection-actions">
      <button
        mat-raised-button
        color="primary"
        [disabled]="getSelectedCount() === 0"
        (click)="analyzeSelected()"
        matTooltip="Analyze or transcribe selected videos">
        <mat-icon>psychology</mat-icon>
        Analyze ({{ getSelectedCount() }})
      </button>
      <button
        mat-raised-button
        color="accent"
        [disabled]="getSelectedCount() === 0"
        (click)="moveToLibrary()"
        matTooltip="Move or copy selected videos to another library">
        <mat-icon>drive_file_move</mat-icon>
        Move to... ({{ getSelectedCount() }})
      </button>
      <button
        mat-raised-button
        color="warn"
        [disabled]="getSelectedCount() === 0"
        (click)="deleteSelected()"
        matTooltip="Delete selected videos">
        <mat-icon>delete</mat-icon>
        Delete ({{ getSelectedCount() }})
      </button>
    </div>
  </div>

  <!-- Loading spinner (only show when truly loading with no videos yet) -->
  <div class="loading-container" *ngIf="isLoading && filteredVideos.length === 0">
    <mat-spinner></mat-spinner>
    <p>Loading video library...</p>
  </div>

  <!-- Video List with Week Grouping -->
  <div *ngIf="filteredVideos.length > 0" class="video-list-container" (click)="onListContainerClick($event)">
    <div *ngFor="let group of groupedVideos" class="week-group">
      <!-- Week header with collapse toggle -->
      <div class="week-header"
           [class.selected]="isWeekSelected(group.week)"
           (click)="selectWeekSection(group.week, $event)">
        <mat-icon class="collapse-icon" (click)="toggleWeek(group.week, $event); $event.stopPropagation()">
          {{ isWeekCollapsed(group.week) ? 'chevron_right' : 'expand_more' }}
        </mat-icon>
        <span class="week-title">{{ group.week }}</span>
        <span class="week-count">{{ group.videos.length }} video{{ group.videos.length !== 1 ? 's' : '' }}</span>
      </div>

      <!-- Videos in this week -->
      <div *ngIf="!isWeekCollapsed(group.week)" class="week-videos">
        <div *ngFor="let video of group.videos" class="video-card-wrapper">
      <div class="video-card"
           [class.long-video]="isLongVideo(video)"
           [class.missing-transcript]="!video.has_transcript"
           [class.missing-analysis]="!video.has_analysis"
           [class.missing-both]="!video.has_transcript && !video.has_analysis"
           [class.highlighted]="isVideoHighlighted(video)"
           [class.selected]="isVideoSelected(video)"
           (click)="highlightVideo(video, $event)"
           (dblclick)="onVideoDoubleClick(video, $event)"
           (contextmenu)="onVideoContextMenu($event, video)">

        <!-- Status Indicator (color-coded based on transcript/analysis status) -->
        <div class="card-status-indicator"
             [class.has-both]="video.has_transcript && video.has_analysis"
             [class.has-transcript-only]="video.has_transcript && !video.has_analysis"
             [class.has-analysis-only]="!video.has_transcript && video.has_analysis"
             [class.has-neither]="!video.has_transcript && !video.has_analysis"
             [matTooltip]="getStatusTooltip(video)">
        </div>

        <!-- Content (non-editable by click) -->
        <div class="card-content">
          <!-- Date chip (with placeholder for alignment when empty) -->
          <mat-chip *ngIf="parseFilename(video.filename).date && !editingVideo[video.id]?.date"
                    class="date-chip">
            {{ formatDateChip(parseFilename(video.filename).date) }}
          </mat-chip>
          <span *ngIf="!parseFilename(video.filename).date && !editingVideo[video.id]?.date"
                class="date-placeholder"></span>
          <input *ngIf="editingVideo[video.id]?.date"
                 type="text"
                 class="date-input"
                 [(ngModel)]="editedValues[video.id].date"
                 (keydown)="onEditKeydown(video, $event)"
                 (blur)="onEditBlur(video, 'date')"
                 (click)="$event.stopPropagation()"
                 placeholder="yyyy-mm-dd"
                 #dateInput>

          <!-- Title (editable on click) -->
          <span *ngIf="!editingVideo[video.id]?.title" class="video-title-text">
            {{ parseFilename(video.filename).title }}
          </span>
          <input *ngIf="editingVideo[video.id]?.title"
                 type="text"
                 class="title-input"
                 [(ngModel)]="editedValues[video.id].title"
                 (keydown)="onEditKeydown(video, $event)"
                 (blur)="onEditBlur(video, 'title')"
                 (click)="$event.stopPropagation()"
                 placeholder="Video title"
                 #titleInput>

          <!-- Extension (with placeholder for alignment when empty) -->
          <span *ngIf="parseFilename(video.filename).extension && !editingVideo[video.id]?.extension"
                class="extension-text">
            .{{ parseFilename(video.filename).extension }}
          </span>
          <span *ngIf="!parseFilename(video.filename).extension && !editingVideo[video.id]?.extension"
                class="extension-placeholder"></span>
          <input *ngIf="editingVideo[video.id]?.extension"
                 type="text"
                 class="extension-input"
                 [(ngModel)]="editedValues[video.id].extension"
                 (keydown)="onEditKeydown(video, $event)"
                 (blur)="onEditBlur(video, 'extension')"
                 (click)="$event.stopPropagation()"
                 placeholder="mp4"
                 #extensionInput>

          <mat-icon *ngIf="isLongVideo(video)" class="long-video-badge" matTooltip="Long video (> 10 minutes)">schedule</mat-icon>

          <!-- Search match indicator -->
          <mat-chip *ngIf="video.matchType && searchQuery" class="match-indicator" [matTooltip]="'Found in: ' + getMatchTypeLabel(video.matchType)">
            <mat-icon>{{ getMatchTypeIcon(video.matchType) }}</mat-icon>
            {{ getMatchTypeLabel(video.matchType) }}
          </mat-chip>

          <!-- Subtitle (duration info) on the right side -->
          <span class="video-subtitle">
            <span *ngIf="video.date_folder">{{ formatDate(video.date_folder) }}</span>
            <span *ngIf="video.duration_seconds"> • {{ formatDuration(video.duration_seconds) }}</span>
          </span>
        </div>

        <!-- Action buttons on the right -->
        <div class="card-actions">
          <button mat-icon-button (click)="onThreeDotsClick($event, video)" matTooltip="More actions">
            <mat-icon>more_vert</mat-icon>
          </button>
          <button mat-icon-button color="warn" (click)="deleteVideo(video); $event.stopPropagation()" matTooltip="Delete video from library">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      </div>
    </div>
      </div>
    </div>
  </div>

  <!-- Context Menu (Right-click) - positioned at cursor -->
  <div style="visibility: hidden; position: fixed;"
       [style.left.px]="contextMenuPosition.x"
       [style.top.px]="contextMenuPosition.y"
       [matMenuTriggerFor]="videoContextMenu"
       #contextMenuTrigger="matMenuTrigger">
  </div>

  <mat-menu #videoContextMenu="matMenu">
    <ng-container *ngIf="contextMenuVideo">
      <!-- Single video actions -->
      <button mat-menu-item (click)="startRenamingVideo(contextMenuVideo)" *ngIf="getSelectedCount() === 1">
        <mat-icon>edit</mat-icon>
        <span>Rename</span>
      </button>
      <button mat-menu-item (click)="openVideoPlayer(contextMenuVideo)" *ngIf="getSelectedCount() === 1">
        <mat-icon>play_arrow</mat-icon>
        <span>Open in Video Editor</span>
      </button>
      <button mat-menu-item (click)="openMetadataEditor(contextMenuVideo)" *ngIf="getSelectedCount() === 1">
        <mat-icon>info</mat-icon>
        <span>View Details</span>
      </button>
      <button mat-menu-item (click)="copyFilename(contextMenuVideo)" *ngIf="getSelectedCount() === 1">
        <mat-icon>content_copy</mat-icon>
        <span>Copy Filename</span>
      </button>
      <mat-divider *ngIf="getSelectedCount() === 1"></mat-divider>

      <!-- Multi-selection actions -->
      <button mat-menu-item (click)="analyzeSelected()">
        <mat-icon>psychology</mat-icon>
        <span>Analyze{{ getSelectedCount() > 1 ? ' (' + getSelectedCount() + ')' : '' }}</span>
      </button>
      <button mat-menu-item (click)="moveToLibrary()">
        <mat-icon>drive_file_move</mat-icon>
        <span>Move to...{{ getSelectedCount() > 1 ? ' (' + getSelectedCount() + ')' : '' }}</span>
      </button>
      <mat-divider></mat-divider>
      <button mat-menu-item (click)="deleteSelected()">
        <mat-icon color="warn">delete</mat-icon>
        <span>Delete{{ getSelectedCount() > 1 ? ' (' + getSelectedCount() + ')' : '' }}</span>
      </button>
    </ng-container>
  </mat-menu>

  <!-- Empty state -->
  <div class="empty-state" *ngIf="!isLoading && filteredVideos.length === 0">
    <mat-icon>video_library</mat-icon>
    <h2>No videos found</h2>
    <p *ngIf="searchQuery">Try adjusting your search query</p>
    <p *ngIf="!searchQuery && videos.length === 0">Click "Import Videos" to select specific videos or "Scan All" to import all videos from your clips directory</p>
    <p *ngIf="!searchQuery && videos.length > 0">No videos match the current filters</p>
  </div>

  <!-- FLOATING PREVIEW PANEL FOR LIST VIEW -->
  <div
    class="floating-preview-panel"
    *ngIf="isPreviewModalOpen && highlightedVideo"
    [style.left.px]="previewPanelX"
    [style.top.px]="previewPanelY"
    [style.width.px]="previewPanelWidth"
    [style.height.px]="previewPanelHeight"
    [class.dragging]="isDraggingPreviewPanel"
    [class.resizing]="isResizingPreviewPanel">

    <!-- Drag Handle Bar -->
    <div class="preview-panel-header" (mousedown)="startDragPreviewPanel($event)">
      <mat-icon class="drag-icon">drag_indicator</mat-icon>
      <span class="header-title">Preview</span>
      <button mat-icon-button
              (click)="togglePreviewAutoPlay()"
              [color]="previewAutoPlayEnabled ? 'primary' : ''"
              [matTooltip]="previewAutoPlayEnabled ? 'Auto-play: On' : 'Auto-play: Off'"
              (mousedown)="$event.stopPropagation()">
        <mat-icon>{{ previewAutoPlayEnabled ? 'play_circle' : 'pause_circle' }}</mat-icon>
      </button>
      <button mat-icon-button class="close-panel-btn" (click)="closePreviewModal()" (mousedown)="$event.stopPropagation()">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <!-- Video Player -->
    <div class="preview-panel-video">
      <video #previewVideoPlayer
             [src]="getVideoStreamUrl(highlightedVideo)"
             controls
             class="preview-video-player">
      </video>
    </div>

    <!-- Title Section -->
    <div class="preview-panel-title">
      <span class="video-title">{{ parseFilename(highlightedVideo.filename).title }}</span>
    </div>

    <!-- Action Buttons -->
    <div class="preview-panel-actions">
      <button mat-raised-button color="primary" (click)="openVideoPlayer(highlightedVideo)" class="action-btn">
        <mat-icon>edit</mat-icon>
        Video Editor
      </button>
      <button mat-raised-button (click)="openMetadataEditor(highlightedVideo); closePreviewModal()" class="action-btn">
        <mat-icon>info</mat-icon>
        Details
      </button>
    </div>

    <!-- Keyboard Hints -->
    <div class="preview-panel-hints">
      <span><mat-icon>keyboard</mat-icon> Space</span>
      <span><mat-icon>keyboard</mat-icon> ↑↓</span>
      <span><mat-icon>keyboard</mat-icon> Esc</span>
    </div>

    <!-- Resize Handles -->
    <div class="preview-panel-resize-handle preview-panel-resize-handle-right" (mousedown)="startResizePreviewPanel($event)">
      <mat-icon>drag_handle</mat-icon>
    </div>
    <div class="preview-panel-resize-handle preview-panel-resize-handle-left" (mousedown)="startResizePreviewPanelLeft($event)">
      <mat-icon>drag_handle</mat-icon>
    </div>
  </div>
</div>
