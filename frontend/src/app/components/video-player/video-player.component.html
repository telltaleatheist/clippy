<div class="video-player-dialog">
  <div class="dialog-header">
    <button mat-icon-button (click)="close()" class="back-button" matTooltip="Back to Clip Creator">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <h2>
      <mat-icon>movie</mat-icon>
      {{ data.analysis.title }}
    </h2>

    <div style="flex: 1"></div>

    <button mat-icon-button (click)="relinkVideo()" class="relink-button" matTooltip="Relink Video">
      <mat-icon>link</mat-icon>
    </button>

    <button mat-icon-button (click)="close()" class="close-button" matTooltip="Close">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <div class="dialog-content">
    <!-- Loading State -->
    <div *ngIf="isLoading" class="loading-overlay">
      <mat-spinner diameter="60"></mat-spinner>
      <p>Loading video...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="error && !isLoading" class="error-container">
      <mat-icon>error</mat-icon>
      <h3>Failed to Load Video</h3>
      <p>{{ error }}</p>
      <div class="error-actions">
        <button mat-raised-button color="accent" (click)="relinkVideo()">
          <mat-icon>link</mat-icon>
          Relink Video
        </button>
        <button mat-button (click)="close()">Close</button>
      </div>
    </div>

    <!-- Video Player -->
    <div class="video-container" [class.hidden]="isLoading || error">
      <video
        #videoElement
        class="video-js vjs-default-skin vjs-big-play-centered"
        playsinline>
      </video>
    </div>

    <!-- Analysis Sections Sidebar with Tabs -->
    <div class="sections-sidebar" *ngIf="metadata && !error">
      <mat-tab-group class="sidebar-tabs" animationDuration="200ms">
        <!-- AI Analysis Tab -->
        <mat-tab label="AI Analysis">
          <div class="tab-content">
            <p class="sections-hint">Click a section to jump to that timestamp</p>
            <div class="sections-list">
              <div
                *ngFor="let section of metadata.sections; let i = index"
                class="section-item"
                [class.active]="isSectionActive(i)"
                (click)="seekToTime(section.startSeconds, i)"
                [matTooltip]="section.description">
                <div class="section-marker" [style.background-color]="getCategoryColor(section.category)"></div>
                <div class="section-content">
                  <div class="section-header">
                    <span class="section-time">{{ section.timeRange }}</span>
                    <span class="section-category" [style.color]="getCategoryColor(section.category)">
                      {{ section.category }}
                    </span>
                  </div>
                  <p class="section-description">{{ section.description }}</p>
                  <div class="section-quotes" *ngIf="section.quotes.length > 0">
                    <div *ngFor="let quote of section.quotes" class="quote-item">
                      <span class="quote-timestamp">{{ quote.timestamp }}</span>
                      <span class="quote-text">"{{ quote.text }}"</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </mat-tab>

        <!-- Transcript Search Tab -->
        <mat-tab label="Search">
          <div class="tab-content search-tab-content">
            <app-transcript-search
              [transcriptText]="transcriptText"
              [transcriptExists]="transcriptExists"
              (seekToTime)="onTranscriptSeek($event)"
              (runAnalysis)="onRunTranscriptAnalysis()">
            </app-transcript-search>
          </div>
        </mat-tab>
      </mat-tab-group>
    </div>
  </div>

  <!-- Timeline with Range Selection -->
  <app-video-timeline
    *ngIf="!error && !isLoading && duration > 0"
    [duration]="duration"
    [currentTime]="currentTime"
    [sections]="timelineSections"
    [isPlaying]="isPlaying"
    (seek)="onTimelineSeek($event)"
    (selectionChange)="onSelectionChange($event)"
    (playPause)="onPlayPause()"
    (playbackSpeed)="onPlaybackSpeed($event)">
  </app-video-timeline>

  <!-- Clip Creation Actions -->
  <div class="clip-actions" *ngIf="!error && !isLoading">
    <button
      mat-raised-button
      color="primary"
      (click)="openCreateClipDialog()"
      [disabled]="currentSelection.endTime - currentSelection.startTime < 1"
      matTooltip="Keyboard: A (Cursor) • R (Range) • J/K/L (Playback) • Space (Play/Pause) • I/O (In/Out)">
      <mat-icon>content_cut</mat-icon>
      Create Clip ({{ formatTime(currentSelection.startTime) }} - {{ formatTime(currentSelection.endTime) }})
    </button>
  </div>
</div>
