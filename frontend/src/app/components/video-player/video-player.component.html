<div class="video-player-dialog" #playerContainer [class.route-mode]="!isDialogMode" [class.is-fullscreen]="isFullscreen">
  <!-- Only show header in dialog mode -->
  <div class="dialog-header" *ngIf="isDialogMode">
    <button mat-icon-button (click)="close()" class="back-button" matTooltip="Back to Clip Creator">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <h2>
      <mat-icon>movie</mat-icon>
      {{ data.analysis?.title || data.customVideo?.title || data.videoTitle || 'Video Player' }}
    </h2>

    <div style="flex: 1"></div>

    <button *ngIf="data.analysis" mat-icon-button (click)="relinkVideo()" class="relink-button" matTooltip="Relink Video">
      <mat-icon>link</mat-icon>
    </button>

    <button mat-icon-button (click)="close()" class="close-button" matTooltip="Close">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <div class="dialog-content">
    <!-- Loading State -->
    <div *ngIf="isLoading" class="loading-overlay">
      <mat-spinner diameter="60"></mat-spinner>
      <p>{{ loadingMessage }}</p>
      <p class="loading-hint" *ngIf="loadingTime > 10">This video may use a codec that's slow to decode in the browser. Consider converting to MP4 for better performance.</p>
    </div>

    <!-- Error State / Drop Zone -->
    <div *ngIf="error && !isLoading" class="error-container"
         [class.drag-over]="isDragOver"
         (drop)="onDrop($event)"
         (dragover)="onDragOver($event)"
         (dragleave)="onDragLeave($event)">
      <input #fileInput type="file" accept="video/*" (change)="onFileSelected($event)" style="display: none">

      <div class="drop-zone-content">
        <mat-icon class="drop-icon">{{ isDragOver ? 'file_download' : 'video_library' }}</mat-icon>
        <h3>{{ isDragOver ? 'Drop Video Here' : 'No Video Loaded' }}</h3>
        <p *ngIf="!isDragOver">{{ error }}</p>
        <p class="drop-hint" *ngIf="!isDragOver">Drag and drop a video file here, or click the button below</p>

        <div class="error-actions" *ngIf="!isDragOver">
          <button mat-raised-button color="primary" (click)="fileInput.click()">
            <mat-icon>folder_open</mat-icon>
            Open Video File
          </button>
          <button mat-raised-button color="accent" (click)="relinkVideo()" *ngIf="data.analysis">
            <mat-icon>link</mat-icon>
            Relink Video
          </button>
          <button mat-button (click)="close()" *ngIf="isDialogMode">Close</button>
        </div>
      </div>
    </div>

    <!-- Media Player (Video/Audio/Image) -->
    <div class="video-container" [class.hidden]="isLoading || error">
      <!-- Video Player -->
      <video
        *ngIf="mediaType === 'video'"
        #videoElement
        class="video-js native-video-player"
        playsinline
        preload="metadata"
        crossorigin="anonymous">
      </video>

      <!-- Audio Player -->
      <div *ngIf="mediaType === 'audio'" class="audio-player-container">
        <audio
          #audioElement
          class="video-js native-audio-player"
          preload="metadata"
          crossorigin="anonymous">
        </audio>
        <div class="audio-visualizer">
          <mat-icon class="audio-icon">audiotrack</mat-icon>
          <div class="audio-info">
            <h3>{{ data.videoTitle || 'Audio File' }}</h3>
            <p>Playing audio file</p>
          </div>
        </div>
      </div>

      <!-- Image Viewer -->
      <div *ngIf="mediaType === 'image'" class="image-viewer-container">
        <img
          #imageElement
          class="image-viewer"
          [src]="imageSrc"
          alt="{{ data.videoTitle || 'Image' }}">
      </div>

      <!-- Document/Webpage Placeholder -->
      <div *ngIf="mediaType === 'document' || mediaType === 'webpage'" class="document-placeholder">
        <mat-icon class="document-icon">{{ mediaType === 'document' ? 'description' : 'public' }}</mat-icon>
        <h3>{{ data.videoTitle || 'Document' }}</h3>
        <p>Preview not available for this file type</p>
        <button mat-raised-button color="primary" (click)="openInExternalApp()">
          <mat-icon>open_in_new</mat-icon>
          Open in External App
        </button>
      </div>
    </div>

    <!-- Analysis Sections Sidebar with Tabs -->
    <div class="sections-sidebar"
         *ngIf="!error && !isLoading && duration > 0"
         [class.hide-in-fullscreen]="isFullscreen">
      <!-- Auto-scroll toggle button - Always visible -->
      <div class="sidebar-toolbar">
        <button
          mat-icon-button
          (click)="toggleAutoScroll()"
          [matTooltip]="getAutoScrollTooltip()"
          class="auto-scroll-toggle"
          [class.enabled]="autoScrollEnabled">
          <mat-icon>{{ autoScrollEnabled ? 'sync' : 'sync_disabled' }}</mat-icon>
        </button>
        <span class="toolbar-label">{{ getAutoScrollLabel() }}</span>
      </div>

      <mat-tab-group #tabGroup class="sidebar-tabs" animationDuration="200ms" (selectedTabChange)="onTabChange($event)">
        <!-- Analysis Tab -->
        <mat-tab label="Analysis">
          <div class="tab-content">
            <!-- Show analysis sections if available -->
            <div *ngIf="metadata && metadata.sections && metadata.sections.length > 0" class="sections-container">
              <!-- Category Filters Accordion -->
              <mat-accordion *ngIf="categoryFilters.length > 0" class="category-filters-accordion">
                <mat-expansion-panel class="category-filters-panel" [expanded]="false">
                  <mat-expansion-panel-header>
                    <mat-panel-title>
                      <mat-icon>filter_list</mat-icon>
                      <span>Filter Categories</span>
                    </mat-panel-title>
                  </mat-expansion-panel-header>
                  <div class="filters-list">
                    <label *ngFor="let filter of categoryFilters" class="filter-checkbox">
                      <input
                        type="checkbox"
                        [checked]="filter.enabled"
                        (change)="toggleCategoryFilter(filter.category)">
                      <span class="filter-indicator" [style.background-color]="filter.color"></span>
                      <span class="filter-label">{{ filter.label }}</span>
                    </label>
                  </div>
                </mat-expansion-panel>
              </mat-accordion>

              <p class="sections-hint">Click a section to jump to that timestamp</p>
              <div class="sections-list">
                <div
                  *ngFor="let section of filteredMetadataSections; let i = index"
                  class="section-item"
                  [class.active]="isSectionActive(i)">
                  <div class="section-clickable" (click)="seekToTime(section.startSeconds, i)" [matTooltip]="section.description">
                    <div class="section-marker" [style.background-color]="getCategoryColor(section.category)"></div>
                    <div class="section-content">
                      <div class="section-header">
                        <span class="section-time">{{ section.timeRange }}</span>
                        <span class="section-category" [style.color]="getCategoryColor(section.category)">
                          {{ section.category }}
                        </span>
                      </div>
                      <p class="section-description">{{ section.description }}</p>
                      <div class="section-quotes" *ngIf="section.quotes.length > 0">
                        <div *ngFor="let quote of section.quotes" class="quote-item">
                          <span class="quote-timestamp">{{ quote.timestamp }}</span>
                          <span class="quote-text">"{{ quote.text }}"</span>
                        </div>
                      </div>
                    </div>
                  </div>
                  <button mat-icon-button
                          class="delete-section-button"
                          (click)="deleteSection(section, i); $event.stopPropagation()"
                          matTooltip="Delete this section">
                    <mat-icon>close</mat-icon>
                  </button>
                </div>
              </div>
            </div>

            <!-- Show generate button if no analysis -->
            <div *ngIf="!metadata || !metadata.sections || metadata.sections.length === 0" class="no-analysis-container">
              <mat-icon class="no-analysis-icon">analytics</mat-icon>
              <h3>No AI Analysis</h3>
              <p>This video hasn't been analyzed yet. Generate an AI analysis to identify key moments and insights.</p>
              <button mat-raised-button color="primary" (click)="generateAnalysis()">
                <mat-icon>play_arrow</mat-icon>
                Generate AI Analysis
              </button>
            </div>
          </div>
        </mat-tab>

        <!-- Transcript Search Tab -->
        <mat-tab label="Search">
          <div class="tab-content search-tab-content">
            <app-transcript-search
              [transcriptText]="transcriptText"
              [transcriptExists]="transcriptExists"
              (seekToTime)="onTranscriptSeek($event)"
              (runAnalysis)="onRunTranscriptAnalysis()">
            </app-transcript-search>
          </div>
        </mat-tab>

        <!-- Transcript Viewer Tab -->
        <mat-tab label="Transcript">
          <div class="tab-content transcript-tab-content">
            <app-transcript-viewer
              [transcriptText]="transcriptText"
              [transcriptExists]="transcriptExists"
              [currentTime]="currentTime"
              [autoScrollEnabled]="autoScrollEnabled"
              (seekToTime)="onTranscriptSeek($event)"
              (runAnalysis)="onRunTranscriptAnalysis()">
            </app-transcript-viewer>
          </div>
        </mat-tab>
      </mat-tab-group>
    </div>
  </div>

  <!-- Timeline with Range Selection -->
  <app-video-timeline
    *ngIf="!error && !isLoading && duration > 0"
    [class.fullscreen-controls]="isFullscreen"
    [class.show-in-fullscreen]="isFullscreen && showControlsInFullscreen"
    [duration]="duration"
    [currentTime]="currentTime"
    [sections]="timelineSections"
    [isPlaying]="isPlaying"
    [mediaElement]="getMediaElement()"
    (seek)="onTimelineSeek($event)"
    (selectionChange)="onSelectionChange($event)"
    (playPause)="onPlayPause()"
    (playbackSpeed)="onPlaybackSpeed($event)"
    (contextMenu)="onTimelineContextMenu($event)">
  </app-video-timeline>

  <!-- Timeline Context Menu -->
  <div [style.left.px]="contextMenuPosition.x" [style.top.px]="contextMenuPosition.y"
       [style.position]="'fixed'" [style.visibility]="'hidden'"
       #contextMenuTrigger="matMenuTrigger" [matMenuTriggerFor]="timelineContextMenu"></div>
  <mat-menu #timelineContextMenu="matMenu">
    <button mat-menu-item (click)="onContextMenuAddMarker()">
      <mat-icon>bookmark_add</mat-icon>
      <span>Add Marker</span>
    </button>
    <button mat-menu-item (click)="onContextMenuExport()" [disabled]="currentSelection.endTime - currentSelection.startTime < 1">
      <mat-icon>file_download</mat-icon>
      <span>Export Clip</span>
    </button>
  </mat-menu>

  <!-- Clip Creation Actions - HIDDEN FOR NOW, will be replaced with better UI -->
  <div class="clip-actions" *ngIf="false">
  </div>
</div>
