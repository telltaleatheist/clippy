<div class="download-queue-container">
  <button class="queue-button" (click)="togglePanel()" [class.has-active]="hasActiveItems">
    <svg class="download-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" fill="currentColor"/>
    </svg>
    <span class="badge" *ngIf="activeItemsCount > 0">{{ activeItemsCount > 99 ? '99+' : activeItemsCount }}</span>
  </button>

  <div class="queue-panel" *ngIf="isOpen">
    <!-- Queue Header -->
    <div class="panel-header">
      <h3>
        Analysis Queue
        <span *ngIf="allJobsAsListItems.length > 0" class="selection-count">({{ allJobsAsListItems.length }})</span>
      </h3>
    </div>

    <!-- Queue Actions -->
    <div class="queue-actions" *ngIf="hasPendingJobs()">
      <button mat-raised-button
              color="primary"
              (click)="startQueue()"
              class="start-queue-btn">
        <mat-icon>play_arrow</mat-icon>
        Start Queue
      </button>
      <button mat-stroked-button
              color="warn"
              (click)="clearQueue()"
              class="clear-queue-btn">
        <mat-icon>clear_all</mat-icon>
        Clear Pending
      </button>
    </div>

    <!-- Clear All Button (show when there are any jobs) -->
    <div class="queue-actions" *ngIf="pendingJobs.length > 0 || processingJobs.length > 0">
      <button mat-stroked-button
              (click)="clearAll()"
              class="clear-all-btn">
        <mat-icon>delete_sweep</mat-icon>
        Clear All
      </button>
    </div>

    <!-- Active Queue List -->
    <div class="jobs-list">
      <!-- All Jobs (Pending + Active) with Cascade Children -->
      <cascade-list
        *ngIf="allJobsAsListItems.length > 0"
        [items]="allJobsAsListItems"
        [displayConfig]="jobDisplayConfig"
        [childrenConfig]="childrenConfig"
        [selectionMode]="SelectionMode.Multiple"
        [progressMapper]="jobProgressMapper"
        [enableDragDrop]="true"
        (itemsReordered)="onJobsReordered($event)"
        emptyMessage="No jobs in queue"
        emptyIcon="hourglass_empty">

        <!-- Custom action template for X button on pending jobs -->
        <ng-template #itemActions let-item>
          <button *ngIf="isJobPending(item)"
                  mat-icon-button
                  (click)="removeJob(item.id); $event.stopPropagation()"
                  matTooltip="Remove from queue"
                  class="remove-job-btn">
            <mat-icon>close</mat-icon>
          </button>
        </ng-template>
      </cascade-list>

      <!-- Empty state -->
      <div class="empty-state" *ngIf="allJobsAsListItems.length === 0">
        <svg class="empty-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" fill="currentColor" opacity="0.3"/>
        </svg>
        <p>No analysis jobs in queue</p>
      </div>
    </div>

    <!-- Completed Jobs Section -->
    <div class="completed-section" *ngIf="getCompletedJobs().length > 0">
      <div class="completed-header">
        <h4>
          <mat-icon>check_circle</mat-icon>
          Completed
          <span class="completed-count">({{ getCompletedJobs().length }})</span>
        </h4>
        <button mat-stroked-button
                (click)="clearCompleted()"
                class="clear-completed-btn">
          <mat-icon>clear</mat-icon>
          Clear Completed
        </button>
      </div>

      <div class="completed-list">
        <cascade-list
          [items]="getCompletedJobsAsListItems()"
          [displayConfig]="jobDisplayConfig"
          [childrenConfig]="childrenConfig"
          [selectionMode]="SelectionMode.None"
          emptyMessage="No completed jobs"
          emptyIcon="check_circle">
        </cascade-list>
      </div>
    </div>
  </div>
</div>
