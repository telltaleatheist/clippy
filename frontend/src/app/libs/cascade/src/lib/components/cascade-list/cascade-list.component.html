<div class="item-list-container" #listContainer tabindex="0" (click)="handleContainerClick($event)">
  <!-- Empty State -->
  <div *ngIf="isEmpty" class="empty-state">
    <mat-icon class="empty-icon">{{ emptyIcon }}</mat-icon>
    <p class="empty-message">{{ emptyMessage }}</p>
  </div>

  <!-- Virtual Scroll Viewport -->
  <cdk-virtual-scroll-viewport *ngIf="!isEmpty"
                                [itemSize]="itemHeight"
                                class="item-groups">
    <ng-container *cdkVirtualFor="let row of flattenedItems; let i = index; trackBy: trackByFlattenedItem">
      <!-- Group Header -->
      <div *ngIf="row.type === 'group'" class="item-group">
        <div class="group-header">
          <mat-icon class="collapse-icon" (click)="toggleGroup(row.group.id); $event.stopPropagation()">
            {{ isGroupCollapsed(row.group.id) ? 'chevron_right' : 'expand_more' }}
          </mat-icon>
          <span class="group-label">{{ row.group.label }}</span>
          <span class="group-count">({{ row.group.items.length }})</span>
        </div>
      </div>

      <!-- Item -->
      <div *ngIf="row.type === 'item'"
           class="items-list">
        <div>
          <div
            [id]="'item-' + row.item.id"
            class="item-card"
            [class.selected]="isItemSelected(row.item)"
            [class.highlighted]="isItemHighlighted(row.item)"
            [class.selection-edge-top]="isFlattenedItemEdgeTop(i)"
            [class.selection-edge-bottom]="isFlattenedItemEdgeBottom(i)"
            [class.is-child]="row.item['isChild']"
            [class.is-parent]="row.item['isParent']"
            [class.is-ghost-parent]="row.item['isGhostParent']"
            [class.is-ghost-child]="row.item['isGhostChild']"
            (click)="handleItemClick(row.item, $event); $event.stopPropagation()"
            (dblclick)="handleItemDoubleClick(row.item)"
            (contextmenu)="handleContextMenu($event, row.item)">

            <!-- Status Indicator -->
            <div *ngIf="getStatus(row.item)"
                 class="status-indicator"
                 [style.background-color]="getStatus(row.item)!.color"
                 [matTooltip]="getStatus(row.item)!.tooltip || ''">
            </div>

            <!-- Expand/Collapse Button (Cascade Feature) -->
            <button *ngIf="childrenConfig?.expandable && hasChildren(row.item)"
                    class="expand-toggle"
                    (click)="toggleExpanded(row.item.id, $event)"
                    (mousedown)="$event.stopPropagation()"
                    [attr.aria-label]="isExpanded(row.item) ? 'Collapse' : 'Expand'"
                    [attr.aria-expanded]="isExpanded(row.item)"
                    tabindex="-1">
              <mat-icon>{{ isExpanded(row.item) ? 'expand_more' : 'chevron_right' }}</mat-icon>
            </button>

            <!-- Icon -->
            <mat-icon class="item-icon">{{ getIcon(row.item) }}</mat-icon>

            <!-- Content -->
            <div class="item-content">
              <!-- Badge -->
              <span *ngIf="getBadge(row.item)" class="item-badge">
                {{ getBadge(row.item) }}
              </span>

              <!-- Primary Text -->
              <div class="item-primary">{{ getPrimaryText(row.item) }}</div>

              <!-- Secondary Text -->
              <div *ngIf="getSecondaryText(row.item)" class="item-secondary">
                {{ getSecondaryText(row.item) }}
              </div>
            </div>

            <!-- Metadata (duration, size, etc.) - displayed on the right -->
            <div *ngIf="getMetadata(row.item)" class="item-metadata">
              {{ getMetadata(row.item) }}
            </div>

            <!-- Custom Action Slot (for buttons like delete, remove, etc.) -->
            <div class="item-actions" *ngIf="hasItemActions">
              <ng-container *ngTemplateOutlet="itemActionsTemplate; context: { $implicit: row.item }"></ng-container>
            </div>

            <!-- Progress Bar (Regular or Master) -->
            <!-- Master Progress (if item has children) -->
            <div *ngIf="hasChildren(row.item) && getMasterProgress(row.item) !== null"
                 class="master-progress-bar"
                 [attr.aria-label]="'Master progress: ' + getMasterProgress(row.item) + '%'"
                 role="progressbar"
                 [attr.aria-valuenow]="getMasterProgress(row.item)"
                 aria-valuemin="0"
                 aria-valuemax="100">
              <div class="progress-fill"
                   [style.width.%]="getMasterProgress(row.item)"></div>
            </div>

            <!-- Regular Progress (if no children) -->
            <div *ngIf="!hasChildren(row.item) && getProgress(row.item)"
                 class="item-progress-bar"
                 [attr.aria-label]="getProgress(row.item)!.label || 'Progress: ' + getProgress(row.item)!.value + '%'"
                 role="progressbar"
                 [attr.aria-valuenow]="getProgress(row.item)!.value"
                 aria-valuemin="0"
                 aria-valuemax="100">
              <div class="progress-fill"
                   [style.width.%]="getProgress(row.item)!.value"
                   [style.background-color]="getProgress(row.item)!.color || null">
              </div>
            </div>
          </div>

          <!-- CASCADE CHILDREN (Ghost Items) -->
          <div *ngIf="isExpanded(row.item) && hasChildren(row.item)"
               class="cascade-children"
               [@expandCollapse]>
            <div *ngFor="let child of getChildren(row.item)"
                 class="cascade-child"
                 [class.child-pending]="child.status === 'pending'"
                 [class.child-active]="child.status === 'active'"
                 [class.child-completed]="child.status === 'completed'"
                 [class.child-failed]="child.status === 'failed'"
                 [class.child-skipped]="child.status === 'skipped'"
                 (click)="handleChildClick(row.item, child, $event)">

              <!-- Child Icon -->
              <mat-icon class="child-icon">{{ child.icon || 'radio_button_unchecked' }}</mat-icon>

              <!-- Child Label -->
              <span class="child-label">{{ child.label }}</span>

              <!-- Child Metadata -->
              <span *ngIf="child.metadata" class="child-metadata">{{ child.metadata }}</span>

              <!-- Child Progress Bar -->
              <div *ngIf="child.progress" class="child-progress-bar">
                <div *ngIf="!child.progress.indeterminate" class="progress-fill"
                     [style.width.%]="child.progress.value"
                     [style.background-color]="child.progress.color || null"></div>
                <div *ngIf="child.progress.indeterminate" class="progress-fill indeterminate"
                     [style.background-color]="child.progress.color || null"></div>
              </div>

              <!-- Child Status Icon -->
              <mat-icon *ngIf="childrenConfig?.showStatus !== false"
                        class="child-status-icon"
                        [matTooltip]="child.status || ''">
                {{ getChildStatusIcon(child.status) }}
              </mat-icon>
            </div>
          </div>
        </div>
      </div>
    </ng-container>
  </cdk-virtual-scroll-viewport>

  <!-- Context Menu Trigger (hidden, positioned by JS) -->
  <div style="visibility: hidden; position: fixed;"
       [style.left.px]="contextMenuPosition.x"
       [style.top.px]="contextMenuPosition.y"
       [matMenuTriggerFor]="contextMenuTemplate"
       #contextMenuTrigger="matMenuTrigger">
  </div>

  <!-- Context Menu Template -->
  <mat-menu #contextMenuTemplate="matMenu" [hasBackdrop]="true" backdropClass="cdk-overlay-transparent-backdrop">
    <ng-container *ngFor="let action of contextMenuActions">
      <!-- Divider -->
      <mat-divider *ngIf="action.divider"></mat-divider>

      <!-- Menu Item -->
      <button *ngIf="!action.divider"
              mat-menu-item
              (click)="executeContextAction(action.id)">
        <mat-icon *ngIf="action.icon">{{ action.icon }}</mat-icon>
        <span>{{ action.label }}</span>
      </button>
    </ng-container>
  </mat-menu>
</div>
