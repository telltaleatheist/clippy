<div class="dialog-overlay" (click)="onOverlayClick($event)">
  <div class="dialog-content" (click)="$event.stopPropagation()">
    <div class="dialog-header">
      <h3>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="7 10 12 15 17 10"/>
          <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        Export Clips
      </h3>
      <button class="close-btn" (click)="cancel()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <div class="dialog-body">
      <!-- Export Progress -->
      @if (isExporting) {
        <div class="export-progress">
          <p class="progress-text">Exporting clip {{ currentClip }} of {{ totalClips }}...</p>
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="exportProgress"></div>
          </div>
          @if (currentClipName) {
            <p class="progress-detail">{{ currentClipName }}</p>
          }
        </div>
      }

      <!-- Export Complete -->
      @if (exportComplete) {
        <div class="export-complete">
          <svg class="success-icon" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
          <h4>Export Complete!</h4>
          <p>Successfully exported {{ successCount }} clips</p>
          @if (failedCount > 0) {
            <p class="error-text">Failed to export {{ failedCount }} clips</p>
          }
        </div>
      }

      <!-- Export Options and Selection -->
      @if (!isExporting && !exportComplete) {
        <div class="export-options-wrapper">
          <!-- Output Location -->
          <div class="output-location">
            <label class="location-label">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
              </svg>
              Output:
            </label>
            <span class="location-value">
              {{ outputDirectory || 'Default (Weekly folder based on date)' }}
            </span>
            <button class="choose-folder-btn" (click)="chooseOutputDirectory()">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
              </svg>
              Choose
            </button>
          </div>

          <!-- Muted Sections Panel -->
          @if (hasMuteSections()) {
            <div class="mute-sections-panel">
              <div class="mute-header">
                <div class="mute-title">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
                  </svg>
                  Muted Sections ({{ muteSections.length }})
                </div>
                <span class="mute-duration">Total: {{ getTotalMuteDuration() }}</span>
              </div>
              <div class="mute-list">
                @for (section of getMuteSectionsDisplay(); track $index) {
                  <div class="mute-item">
                    <span class="mute-range">{{ section.startTime }} - {{ section.endTime }}</span>
                    <span class="mute-length">{{ section.duration }}</span>
                  </div>
                }
              </div>
              <div class="mute-options">
                <label class="checkbox-option">
                  <input
                    type="checkbox"
                    [(ngModel)]="applyMutes"
                    [disabled]="isExporting">
                  <span class="checkmark"></span>
                  <span class="option-label">Apply mutes to export</span>
                </label>
                @if (applyMutes) {
                  <label class="checkbox-option">
                    <input
                      type="checkbox"
                      [(ngModel)]="saveCopy"
                      [disabled]="isExporting">
                    <span class="checkmark"></span>
                    <span class="option-label">Save as copy with "(censored)" suffix</span>
                  </label>
                }
              </div>
            </div>
          }

          <!-- Category Sections using Cascade Component -->
          @if (cascadeWeeks().length > 0 || allCascadeWeeks().length > 0) {
            <div class="categories-container">
              <div class="export-header">
                <p class="hint-text">Select clips to export:</p>
                <div class="header-controls">
                  <button class="select-toggle" (click)="areAllSelected() ? deselectAll() : selectAll()">
                    {{ areAllSelected() ? 'Deselect All' : 'Select All' }}
                  </button>
                </div>
              </div>

              <!-- Category Filter Chips -->
              @if (availableCategories().length > 1) {
                <div class="category-filters">
                  @for (category of availableCategories(); track category) {
                    <button
                      class="filter-chip"
                      [class.active]="isCategorySelected(category) && selectedCategories().size > 0"
                      [class.inactive]="!isCategorySelected(category)"
                      (click)="toggleCategoryFilter(category)"
                    >
                      {{ getCategoryIcon(category) }} {{ category }}
                    </button>
                  }
                  @if (selectedCategories().size > 0) {
                    <button class="filter-chip clear-chip" (click)="clearCategoryFilters()">
                      Clear
                    </button>
                  }
                </div>
              }

              <div class="cascade-wrapper">
                <app-cascade
                  [weeks]="cascadeWeeks()"
                  [showDuration]="true"
                  [showEditButton]="false"
                  [showDeleteButton]="false"
                  [showStatusIndicator]="false"
                  [showQuickActions]="false"
                  [showSuggestedTitle]="true"
                  [suggestedTitleLabel]="''"
                  (selectionChanged)="onCascadeSelectionChanged($event)"
                  (videoAction)="onCascadeVideoAction($event)"
                />
              </div>
            </div>
          }

          <!-- No Sections Message -->
          @if (sections.length === 0) {
            <div class="no-sections">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="16" x2="12" y2="12"/>
                <line x1="12" y1="8" x2="12.01" y2="8"/>
              </svg>
              <p>No markers or sections available to export.</p>
              <p class="hint">Add markers using <kbd>M</kbd> or right-click on the timeline.</p>
            </div>
          }
        </div>
      }
    </div>

    <div class="dialog-footer">
      <button class="cancel-btn" (click)="exportComplete ? closeDialog() : cancel()" [disabled]="isExporting">
        {{ exportComplete ? 'Close' : 'Cancel' }}
      </button>

      @if (!exportComplete) {
        <div class="export-options">
          <label class="checkbox-option" [class.disabled]="isExporting || !canOverwriteOriginal()">
            <input
              type="checkbox"
              [(ngModel)]="overwriteOriginal"
              [disabled]="isExporting || !canOverwriteOriginal()">
            <span class="checkmark"></span>
            <span class="option-label">Overwrite Original</span>
          </label>
          <label class="checkbox-option" [class.disabled]="isExporting">
            <input
              type="checkbox"
              [(ngModel)]="reEncode"
              [disabled]="isExporting">
            <span class="checkmark"></span>
            <span class="option-label">Re-encode</span>
          </label>
        </div>
        <button
          class="export-btn"
          (click)="export()"
          [disabled]="getSelectedCount() === 0 || isExporting">
          @if (isExporting) {
            <span class="spinner"></span>
          } @else {
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="7 10 12 15 17 10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
          }
          Export {{ getSelectedCount() }} {{ getSelectedCount() === 1 ? 'Clip' : 'Clips' }}
          @if (getSelectedCount() > 0) {
            <span class="duration-badge">({{ getSelectedDuration() }})</span>
          }
        </button>
      }
    </div>
  </div>
</div>
