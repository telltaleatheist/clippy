<div class="dialog-overlay" (click)="onOverlayClick($event)">
  <div class="dialog-content" (click)="$event.stopPropagation()">
    <div class="dialog-header">
      <h3>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="7 10 12 15 17 10"/>
          <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        Export Clips
      </h3>
      <button class="close-btn" (click)="cancel()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <div class="dialog-body">
      <!-- Export Progress -->
      @if (isExporting) {
        <div class="export-progress">
          <p class="progress-text">Exporting clip {{ currentClip }} of {{ totalClips }}...</p>
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="exportProgress"></div>
          </div>
          @if (currentClipName) {
            <p class="progress-detail">{{ currentClipName }}</p>
          }
        </div>
      }

      <!-- Export Complete -->
      @if (exportComplete) {
        <div class="export-complete">
          <svg class="success-icon" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
          <h4>Export Complete!</h4>
          <p>Successfully exported {{ successCount }} clips</p>
          @if (failedCount > 0) {
            <p class="error-text">Failed to export {{ failedCount }} clips</p>
          }
        </div>
      }

      <!-- Export Options and Selection -->
      @if (!isExporting && !exportComplete) {
        <div class="export-options-wrapper">
          <!-- Output Location -->
          <div class="output-location">
            <label class="location-label">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
              </svg>
              Output:
            </label>
            <span class="location-value">
              {{ outputDirectory || 'Default (Weekly folder based on date)' }}
            </span>
            <button class="choose-folder-btn" (click)="chooseOutputDirectory()">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
              </svg>
              Choose
            </button>
          </div>

          <!-- Category Sections using Cascade Component -->
          @if (cascadeWeeks().length > 0) {
            <div class="categories-container">
              <div class="export-header">
                <p class="hint-text">Select clips to export:</p>
                <div class="header-controls">
                  <button class="select-toggle" (click)="areAllSelected() ? deselectAll() : selectAll()">
                    {{ areAllSelected() ? 'Deselect All' : 'Select All' }}
                  </button>
                </div>
              </div>

              <div class="cascade-wrapper">
                <app-cascade
                  [weeks]="cascadeWeeks()"
                  [showDuration]="true"
                  [showEditButton]="false"
                  [showDeleteButton]="false"
                  [showStatusIndicator]="true"
                  (selectionChanged)="onCascadeSelectionChanged($event)"
                  (videoAction)="onCascadeVideoAction($event)"
                />
              </div>
            </div>
          }

          <!-- No Sections Message -->
          @if (sections.length === 0) {
            <div class="no-sections">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="16" x2="12" y2="12"/>
                <line x1="12" y1="8" x2="12.01" y2="8"/>
              </svg>
              <p>No markers or sections available to export.</p>
              <p class="hint">Add markers using <kbd>M</kbd> or right-click on the timeline.</p>
            </div>
          }
        </div>
      }
    </div>

    <div class="dialog-footer">
      <button class="cancel-btn" (click)="exportComplete ? closeDialog() : cancel()" [disabled]="isExporting">
        {{ exportComplete ? 'Close' : 'Cancel' }}
      </button>

      @if (!exportComplete) {
        <div class="export-options">
          <label class="checkbox-option" [class.disabled]="isExporting || !canOverwriteOriginal()">
            <input
              type="checkbox"
              [(ngModel)]="overwriteOriginal"
              [disabled]="isExporting || !canOverwriteOriginal()">
            <span class="checkmark"></span>
            <span class="option-label">Overwrite Original</span>
          </label>
          <label class="checkbox-option" [class.disabled]="isExporting">
            <input
              type="checkbox"
              [(ngModel)]="reEncode"
              [disabled]="isExporting">
            <span class="checkmark"></span>
            <span class="option-label">Re-encode</span>
          </label>
        </div>
        <button
          class="export-btn"
          (click)="export()"
          [disabled]="getSelectedCount() === 0 || isExporting">
          @if (isExporting) {
            <span class="spinner"></span>
          } @else {
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="7 10 12 15 17 10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
          }
          Export {{ getSelectedCount() }} {{ getSelectedCount() === 1 ? 'Clip' : 'Clips' }}
          @if (getSelectedCount() > 0) {
            <span class="duration-badge">({{ getSelectedDuration() }})</span>
          }
        </button>
      }
    </div>
  </div>
</div>
