<div class="cascade" (click)="clearSelection()" (mousedown)="onDragSelectStart($event)">
  <!-- Empty State (outside virtual scroll) -->
  @if (virtualItems().length === 0) {
    <div class="library-content empty">
      <div class="empty-state">
        <div class="empty-icon">üé¨</div>
        <h3>No videos yet</h3>
        <p>Your video library will appear here</p>
      </div>
    </div>
  } @else {
    <!-- Virtual Scroll Video List -->
    <cdk-virtual-scroll-viewport
      itemSize="56"
      class="library-content"
      minBufferPx="400"
      maxBufferPx="800"
    >
      <ng-container *cdkVirtualFor="let item of virtualItems(); let i = index; trackBy: trackItem">
        <!-- Week Header (skip empty labels) -->
        @if (item.type === 'header' && item.week.weekLabel) {
          <div
            class="week-header"
            (click)="toggleWeek(item.week, $event)"
            (contextmenu)="onHeaderContextMenu(item.week, $event)"
          >
            <button class="week-toggle" (click)="toggleWeek(item.week, $event)">
              <span class="toggle-icon" [class.expanded]="item.week.expanded">‚ñ∂</span>
            </button>
            <span class="week-label">{{ item.week.weekLabel.toUpperCase() }}</span>
            <span class="week-count">({{ item.week.videos.length }})</span>
          </div>
        }

        <!-- Video Item -->
        @if (item.type === 'video') {
          <div class="video-item-wrapper">
            <div
              class="video-item"
              [attr.data-item-id]="item.itemId"
              [class.selected]="isSelected(item.itemId)"
              [class.highlighted]="isHighlighted(item.itemId)"
              [class.ai-processing]="isProcessingAi(item.video)"
              [class.selection-edge-top]="isSelectionEdgeTop(i)"
              [class.selection-edge-bottom]="isSelectionEdgeBottom(i)"
              [class.has-children]="hasChildren(item.video) || hasVideoChildren(item.video)"
              [class.is-ghost]="item.video.isGhost"
              [class.is-child]="isVideoChild(item.video)"
              (click)="handleVideoClick(item.itemId, item.video, $event)"
              (dblclick)="handleVideoDoubleClick(item.video, $event)"
              (contextmenu)="onContextMenu(item.itemId, item.video, $event)"
            >
              <!-- Processing Status Indicator (not for ghosts) -->
              @if (showStatusIndicator && !item.video.isGhost) {
                <div class="selection-indicator" [ngClass]="getProcessingStatus(item.video)"></div>
              }

              <!-- Expand/Collapse Button (if children enabled, not for ghosts) -->
              @if (childrenConfig?.expandable && hasChildren(item.video) && !item.video.isGhost) {
                <button
                  class="expand-toggle"
                  (click)="toggleExpanded(item.video.id, $event)"
                  [attr.aria-expanded]="isExpanded(item.video.id)">
                  <span class="expand-icon" [class.expanded]="isExpanded(item.video.id)">‚ñ∂</span>
                </button>
              } @else if (!item.video.isGhost) {
                <!-- Video Icon (not for ghosts) -->
                <div class="video-icon">üìπ</div>
              }

            <!-- Video Content -->
            <div class="video-content">
              <!-- Ghost relationship indicator for children (ABOVE title) -->
              @if (item.video.isGhost && item.video.ghostType === 'child') {
                <div class="ghost-relationship ghost-relationship-top">
                  <span class="ghost-icon">‚Üë</span>
                  <span class="ghost-label">CHILD OF: {{ item.video.ghostRelatedName }}</span>
                </div>
              }

              <!-- Title -->
              <div class="video-title">
                @if (item.video.titleLoading) {
                  <span class="title-spinner"></span>
                }
                <span class="title-text">{{ item.video.name }}</span>
              </div>

              <!-- Ghost relationship indicator for parents (BELOW title) -->
              @if (item.video.isGhost && item.video.ghostType === 'parent') {
                <div class="ghost-relationship ghost-relationship-bottom">
                  <span class="ghost-icon">‚Üì</span>
                  <span class="ghost-label">PARENT OF: {{ item.video.ghostRelatedName }}</span>
                </div>
              }

              <!-- Error Message Row (for failed downloads/operations) -->
              @if (item.video.errorMessage && (item.video.tags?.includes('download-failed') || item.video.tags?.includes('status:failed'))) {
                <div class="video-meta error-meta">
                  <span class="meta-icon">‚ùå</span>
                  <span class="meta-filename error-text">{{ item.video.errorMessage }}</span>
                  @if (item.video.sourceUrl) {
                    <span
                      class="meta-action"
                      (click)="copyToClipboard(item.video.sourceUrl); $event.stopPropagation()"
                      title="Copy URL to clipboard"
                    >Copy URL</span>
                  }
                </div>
              }

              <!-- Suggested Title Row (not for ghosts) -->
              @if (item.video.suggestedTitle && !item.video.isGhost) {
                <div class="video-meta">
                  @if (isQueueItem(item.video)) {
                    <!-- Queue item status display -->
                    <span class="meta-icon">‚è≥</span>
                    <span class="meta-filename status-text">{{ item.video.suggestedTitle }}</span>
                    <span
                      class="meta-action"
                      (click)="onConfigureClick(item.video, $event)"
                    >Configure</span>
                  } @else if (item.video.suggestedTitle.startsWith('‚ö†Ô∏è')) {
                    <!-- Duplicate warning display (no AI label or edit button) -->
                    <span class="meta-icon">‚ö†Ô∏è</span>
                    <span class="meta-filename duplicate-warning">{{ item.video.suggestedTitle.substring(2).trim() }}</span>
                  } @else {
                    <!-- AI suggested title display -->
                    <span class="meta-icon">‚ú®</span>
                    <span class="meta-label">AI Title:</span>
                    <span class="meta-filename">{{ item.video.suggestedTitle }}</span>
                    <span
                      class="meta-action"
                      (click)="openSuggestedTitleModal(item.video); $event.stopPropagation()"
                    >Edit</span>
                    @if (item.video.downloadDate) {
                      <span class="meta-separator">‚Ä¢</span>
                      <span class="meta-downloaded">Downloaded: {{ formatDownloadDate(item.video.downloadDate) }}</span>
                    }
                  }
                </div>
              }
            </div>

            <!-- Duration & Actions (not for ghosts) -->
            <div class="video-actions">
              @if (showDuration && item.video.duration && item.video.duration !== '0:00' && item.video.duration !== '00:00:00' && item.video.duration !== '0:00:00' && !item.video.isGhost) {
                <span class="video-duration">{{ item.video.duration }}</span>
              }

              <!-- Quick Action Buttons (always visible for library items) -->
              @if (!item.video.isGhost && !isStagingItem(item.video) && !isProcessingItem(item.video) && !isQueueItem(item.video)) {
                <div class="quick-actions">
                  <button
                    class="action-btn open-btn"
                    (click)="onQuickAction(item.video, 'open', $event)"
                    title="Open video file">
                    Open
                  </button>
                  <button
                    class="action-btn ripplecut-btn"
                    (click)="onQuickAction(item.video, 'openInEditor', $event)"
                    title="View analysis, transcript & more">
                    View Analysis
                  </button>
                  <button
                    class="action-btn process-btn"
                    (click)="onQuickAction(item.video, 'process', $event)"
                    title="Run AI analysis">
                    Process
                  </button>
                </div>
              }

              @if (showEditButton && !item.video.isGhost) {
                <button
                  class="edit-btn"
                  (click)="onEditClick(item.video, $event)"
                  title="Edit"
                >
                  ‚úèÔ∏è
                </button>
              }
              @if (showDeleteButton && (isStagingItem(item.video) || isProcessingItem(item.video) || isCompletedItem(item.video) || isQueueItem(item.video)) && !item.video.isGhost) {
                <button
                  class="delete-btn"
                  [class.cancel-btn]="isProcessingItem(item.video)"
                  (click)="onDeleteClick(item.video, $event)"
                  [title]="isProcessingItem(item.video) ? 'Cancel Processing' : 'Remove from Queue'"
                >
                  √ó
                </button>
              }
            </div>

            <!-- Progress Label & Bar -->
            @if (getProgress(item.video); as progress) {
              @if (progress.taskLabel || progress.etaLabel) {
                <div class="progress-label">
                  @if (progress.taskLabel) {
                    <span class="task-name">{{ progress.taskLabel }}</span>
                  }
                  @if (progress.etaLabel) {
                    <span class="eta">{{ progress.etaLabel }}</span>
                  }
                </div>
              }
              <div class="item-progress-bar"
                   [attr.aria-label]="progress.label || 'Progress: ' + progress.value + '%'"
                   role="progressbar"
                   [attr.aria-valuenow]="progress.value"
                   aria-valuemin="0"
                   aria-valuemax="100">
                @if (!progress.indeterminate) {
                  <div class="progress-fill"
                       [style.width.%]="progress.value"
                       [style.background-color]="progress.color || null"></div>
                } @else {
                  <div class="progress-fill indeterminate"
                       [style.background-color]="progress.color || null"></div>
                }
              </div>
            }

            <!-- Master Progress Bar (when children exist) -->
            @if (hasChildren(item.video) && getMasterProgress(item.video) !== null) {
              <div class="master-progress-bar"
                   role="progressbar"
                   [attr.aria-valuenow]="getMasterProgress(item.video)"
                   aria-valuemin="0"
                   aria-valuemax="100">
                <div class="progress-fill"
                     [style.width.%]="getMasterProgress(item.video)"></div>
              </div>
            }
          </div>

            <!-- Relationships Section -->
            @if (isExpanded(item.video.id) && hasRelationships(item.video)) {
              <div class="cascade-children" [@expandCollapse]>
                <!-- Show task-based children first -->
                @for (child of getChildren(item.video); track child.id) {
                  <div
                    class="cascade-child"
                    [class.child-pending]="child.status === 'pending'"
                    [class.child-active]="child.status === 'active'"
                    [class.child-completed]="child.status === 'completed'"
                    [class.child-failed]="child.status === 'failed'"
                    [class.child-skipped]="child.status === 'skipped'"
                    (click)="handleChildClick(item.video, child, $event)">

                    <!-- Child Icon -->
                    <span class="child-icon">{{ child.icon || '‚óã' }}</span>

                    <!-- Child Label -->
                    <span class="child-label">{{ child.label }}</span>

                    <!-- Child Metadata -->
                    @if (child.metadata) {
                      <span class="child-metadata">{{ child.metadata }}</span>
                    }

                    <!-- Child Progress Bar -->
                    @if (child.progress) {
                      <div class="child-progress-bar">
                        @if (!child.progress.indeterminate) {
                          <div class="progress-fill"
                               [style.width.%]="child.progress.value"
                               [style.background-color]="child.progress.color || null"></div>
                        } @else {
                          <div class="progress-fill indeterminate"
                               [style.background-color]="child.progress.color || null"></div>
                        }
                      </div>
                    }

                    <!-- Child Status Icon -->
                    @if (childrenConfig?.showStatus !== false) {
                      <span class="child-status-icon">{{ getChildStatusIcon(child.status) }}</span>
                    }
                  </div>
                }

                <!-- Show video relationships (parents and children) -->
                @for (relationship of getVideoRelationships(item.video); track relationship.id) {
                  <div
                    class="cascade-child cascade-relationship"
                    [class.is-parent]="relationship.type === 'parent'"
                    [class.is-child]="relationship.type === 'child'"
                    (click)="handleRelationshipClick(relationship, $event)">

                    <!-- Relationship Icon -->
                    <span class="child-icon">{{ relationship.type === 'parent' ? '‚Üë' : '‚Üì' }}</span>

                    <!-- Relationship Label -->
                    <span class="child-label">
                      <span class="relationship-type">{{ relationship.type === 'parent' ? 'Parent:' : 'Child:' }}</span>
                      {{ relationship.video.name }}
                    </span>

                    <!-- Remove button -->
                    <button
                      class="relationship-remove"
                      (click)="removeRelationship(item.video, relationship, $event)"
                      title="Remove relationship"
                    >√ó</button>
                  </div>
                }
              </div>
            }
          </div>
        }
      </ng-container>
    </cdk-virtual-scroll-viewport>
  }

  <!-- Context Menu -->
  <app-context-menu
    [visible]="contextMenuVisible()"
    [position]="contextMenuPosition()"
    [actions]="contextMenuActions()"
    (actionSelected)="onContextMenuAction($event)"
    (closed)="closeContextMenu()"
  />

  <!-- Filename Edit Modal -->
  <app-filename-modal
    [show]="filenameModalVisible()"
    [filename]="editingFilename()"
    [original]="editingVideo()?.name || ''"
    (saved)="onFilenameSaved($event)"
    (closed)="onFilenameModalClosed()"
  />

  <!-- Suggested Title Edit Modal -->
  <app-filename-modal
    [show]="suggestedTitleModalVisible()"
    [filename]="editingSuggestedTitleVideo()?.suggestedTitle || ''"
    [original]="editingSuggestedTitleVideo()?.name || ''"
    [title]="'Edit AI Suggested Title'"
    [label]="'Suggested Title'"
    [showDiscard]="true"
    (saved)="onSuggestedTitleSaved($event)"
    (discarded)="onSuggestedTitleDiscarded()"
    (closed)="onSuggestedTitleModalClosed()"
  />

  <!-- Delete Options Modal -->
  @if (deleteModalVisible()) {
    <div class="delete-modal-backdrop" (click)="closeDeleteModal()">
      <div class="delete-modal" (click)="$event.stopPropagation()">
        <div class="delete-modal-header">
          <span class="delete-modal-icon">üóëÔ∏è</span>
          <h3 class="delete-modal-title">
            Delete {{ deletingVideos().length }} {{ deletingVideos().length === 1 ? 'Item' : 'Items' }}
          </h3>
        </div>
        <p class="delete-modal-description">Choose how to delete the selected items:</p>
        <div class="delete-options">
          <button
            class="delete-option"
            [class.selected]="selectedDeleteMode() === 'database-only'"
            (click)="selectDeleteMode('database-only')">
            <span class="option-icon">üìã</span>
            <div class="option-content">
              <span class="option-label">Remove from Library</span>
              <span class="option-description">Delete database entry but keep file on disk</span>
            </div>
          </button>
          <button
            class="delete-option"
            [class.selected]="selectedDeleteMode() === 'file-only'"
            (click)="selectDeleteMode('file-only')">
            <span class="option-icon">üìÅ</span>
            <div class="option-content">
              <span class="option-label">Delete File Only</span>
              <span class="option-description">Delete file from disk but keep database entry</span>
            </div>
          </button>
          <button
            class="delete-option delete-option-danger"
            [class.selected]="selectedDeleteMode() === 'everything'"
            (click)="selectDeleteMode('everything')">
            <span class="option-icon">‚ö†Ô∏è</span>
            <div class="option-content">
              <span class="option-label">Delete Everything</span>
              <span class="option-description">Delete both file and database entry permanently</span>
            </div>
          </button>
        </div>
        <div class="delete-modal-actions">
          <button class="delete-cancel-btn" (click)="closeDeleteModal()">Cancel</button>
          <button
            class="delete-submit-btn"
            [disabled]="!selectedDeleteMode()"
            (click)="confirmDelete()">
            Delete
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Drag Selection Rectangle -->
  @if (isDragSelecting() && selectionRect(); as rect) {
    <div
      class="selection-rectangle"
      [style.left.px]="rect.left"
      [style.top.px]="rect.top"
      [style.width.px]="rect.width"
      [style.height.px]="rect.height"
    ></div>
  }
</div>
