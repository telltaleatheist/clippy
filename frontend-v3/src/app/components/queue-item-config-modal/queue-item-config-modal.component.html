<div class="modal-backdrop" *ngIf="isOpen()" (click)="onBackdropClick($event)">
  <div class="modal-container">
    <div class="modal-header">
      <h2 class="modal-title">{{ bulkMode() ? 'Apply Settings to All Items' : 'Configure Tasks' }}</h2>
      <button class="close-btn" (click)="onClose()" aria-label="Close">âœ•</button>
    </div>

    <div class="modal-body">
      <p class="modal-description">
        {{ bulkMode()
          ? 'Configure tasks that will be applied to all ' + itemCount() + ' items in the queue'
          : 'Select which tasks to run and configure their settings'
        }}
      </p>

      <div class="tasks-list">
        <div
          *ngFor="let task of getAvailableTasks()"
          class="task-item"
          [class.selected]="isTaskSelected(task.type)"
          [class.expanded]="isTaskSelected(task.type) && (task.type === 'transcribe' || task.type === 'ai-analyze')"
        >
          <!-- Task Header (clickable) -->
          <div class="task-header" (click)="toggleTask(task)">
            <span class="task-icon">{{ task.icon }}</span>
            <div class="task-info">
              <span class="task-label">{{ task.label }}</span>
              <span class="task-description">{{ task.description }}</span>
            </div>
            <span class="selection-indicator" *ngIf="isTaskSelected(task.type)">âœ“</span>
          </div>

          <!-- Task Configuration (auto-expand for transcribe and ai-analyze) -->
          <div class="task-config" *ngIf="isTaskSelected(task.type) && (task.type === 'transcribe' || task.type === 'ai-analyze')">

            <!-- Transcribe Config -->
            <div *ngIf="task.type === 'transcribe'" class="config-form">
              <div class="form-group">
                <label>Whisper Model</label>
                <select
                  [value]="getTaskConfig(task.type).model"
                  (change)="updateTaskConfig(task.type, { model: $any($event.target).value })"
                >
                  <option value="tiny">Tiny (Fastest, Less Accurate)</option>
                  <option value="base">Base</option>
                  <option value="small">Small</option>
                  <option value="medium">Medium</option>
                  <option value="large">Large (Slowest, Most Accurate)</option>
                </select>
              </div>
              <div class="form-group">
                <label>Language (optional)</label>
                <input
                  type="text"
                  placeholder="Auto-detect"
                  [value]="getTaskConfig(task.type).language || ''"
                  (input)="updateTaskConfig(task.type, { language: $any($event.target).value })"
                />
              </div>
              <div class="form-group">
                <label class="checkbox-label">
                  <input
                    type="checkbox"
                    [checked]="getTaskConfig(task.type).translate"
                    (change)="updateTaskConfig(task.type, { translate: $any($event.target).checked })"
                  />
                  <span>Translate to English</span>
                </label>
              </div>
            </div>

            <!-- AI Analyze Config -->
            <div *ngIf="task.type === 'ai-analyze'" class="config-form">
              <div class="form-group">
                <label>AI Model</label>
                <select
                  [value]="getTaskConfig(task.type).aiModel"
                  (change)="updateTaskConfig(task.type, { aiModel: $any($event.target).value })"
                  [disabled]="loadingModels()"
                >
                  <option *ngIf="loadingModels()" value="">Loading models...</option>
                  <option *ngIf="!loadingModels() && aiModels().length === 0" value="">No models available</option>

                  <!-- Ollama Models -->
                  <optgroup *ngIf="hasModelsForProvider('ollama')" label="Ollama (Local)">
                    <option *ngFor="let model of getModelsByProvider('ollama')" [value]="model.value">
                      {{ model.label }}
                    </option>
                  </optgroup>

                  <!-- Claude Models -->
                  <optgroup *ngIf="hasModelsForProvider('claude')" label="Claude (Anthropic)">
                    <option *ngFor="let model of getModelsByProvider('claude')" [value]="model.value">
                      {{ model.label }}
                    </option>
                  </optgroup>

                  <!-- OpenAI Models -->
                  <optgroup *ngIf="hasModelsForProvider('openai')" label="OpenAI">
                    <option *ngFor="let model of getModelsByProvider('openai')" [value]="model.value">
                      {{ model.label }}
                    </option>
                  </optgroup>
                </select>
                <button
                  type="button"
                  class="btn-save-default"
                  [class.saved]="savedAsDefault()"
                  (click)="saveAsDefault(getTaskConfig(task.type).aiModel)"
                  [disabled]="loadingModels() || !getTaskConfig(task.type).aiModel || savedAsDefault()"
                  [title]="savedAsDefault() ? 'Saved!' : 'Save this model as your default for future analysis'"
                >
                  @if (savedAsDefault()) {
                    âœ“ Saved!
                  } @else {
                    ðŸ’¾ Save as Default
                  }
                </button>
              </div>
              <div class="form-group">
                <label>Custom Instructions (optional)</label>
                <textarea
                  rows="3"
                  placeholder="Add specific instructions for the AI analysis..."
                  [value]="getTaskConfig(task.type).customInstructions || ''"
                  (input)="updateTaskConfig(task.type, { customInstructions: $any($event.target).value })"
                ></textarea>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="onClose()">Cancel</button>
      <button class="btn btn-primary" (click)="onSave()" [disabled]="tasks().size === 0">
        Apply
      </button>
    </div>
  </div>
</div>
