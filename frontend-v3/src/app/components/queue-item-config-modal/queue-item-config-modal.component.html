<div class="modal-backdrop" *ngIf="isOpen()" (click)="onBackdropClick($event)">
  <div class="modal-container">
    <div class="modal-header">
      <h2 class="modal-title">{{ bulkMode() ? 'Apply Settings to All Items' : 'Processing Options' }}</h2>
      <button class="close-btn" (click)="onClose()" aria-label="Close">âœ•</button>
    </div>

    <div class="modal-body">
      <p class="modal-description">
        {{ bulkMode()
          ? 'Configure tasks that will be applied to all ' + itemCount() + ' items in the queue'
          : 'Select which tasks to run and configure their settings'
        }}
      </p>

      <div class="tasks-list">
        <div
          *ngFor="let task of getAvailableTasks()"
          class="task-item"
          [class.selected]="isTaskSelected(task.type)"
          [class.expanded]="isTaskSelected(task.type) && (task.type === 'transcribe' || task.type === 'ai-analyze')"
        >
          <!-- Task Header (clickable) -->
          <div class="task-header" (click)="toggleTask(task)">
            <span class="task-icon">{{ task.icon }}</span>
            <div class="task-info">
              <span class="task-label">{{ task.label }}</span>
              <span class="task-description">{{ task.description }}</span>
            </div>
            <span class="selection-indicator" *ngIf="isTaskSelected(task.type)">âœ“</span>
          </div>

          <!-- Task Configuration (auto-expand for transcribe and ai-analyze) -->
          <div class="task-config" *ngIf="isTaskSelected(task.type) && (task.type === 'transcribe' || task.type === 'ai-analyze')">

            <!-- Transcribe Config -->
            <div *ngIf="task.type === 'transcribe'" class="config-form">
              <div class="form-group">
                <label>Whisper Model</label>
                <select
                  [value]="getTaskConfig(task.type).model"
                  (change)="updateTaskConfig(task.type, { model: $any($event.target).value })"
                >
                  <option *ngFor="let model of whisperModels()" [value]="model.id">
                    {{ model.name }} - {{ model.description }}
                  </option>
                </select>
              </div>
              <div class="form-group">
                <label>Language (optional)</label>
                <input
                  type="text"
                  placeholder="Auto-detect"
                  [value]="getTaskConfig(task.type).language || ''"
                  (input)="updateTaskConfig(task.type, { language: $any($event.target).value })"
                />
              </div>
              <div class="form-group">
                <label class="checkbox-label">
                  <input
                    type="checkbox"
                    [checked]="getTaskConfig(task.type).translate"
                    (change)="updateTaskConfig(task.type, { translate: $any($event.target).checked })"
                  />
                  <span>Translate to English</span>
                </label>
              </div>
            </div>

            <!-- AI Analyze Config -->
            <div *ngIf="task.type === 'ai-analyze'" class="config-form">
              <div class="form-group">
                <label>AI Model</label>
                <select
                  [ngModel]="getTaskConfig(task.type).aiModel"
                  (ngModelChange)="onAIModelChange($event)"
                  [disabled]="loadingModels()"
                >
                  <option *ngIf="loadingModels()" value="">Loading models...</option>
                  <option *ngIf="!loadingModels() && aiModels().length === 0" value="">No models available</option>
                  <option *ngIf="!loadingModels() && aiModels().length > 0 && !getTaskConfig(task.type).aiModel" value="" disabled>-- Select a model --</option>

                  <!-- Local AI (Bundled) -->
                  <optgroup *ngIf="hasModelsForProvider('local')" label="Local AI (Bundled)">
                    <option *ngFor="let model of getModelsByProvider('local')" [value]="model.value">
                      {{ model.label }}
                    </option>
                  </optgroup>

                  <!-- Ollama Models -->
                  <optgroup *ngIf="hasModelsForProvider('ollama')" label="Ollama">
                    <option *ngFor="let model of getModelsByProvider('ollama')" [value]="model.value">
                      {{ model.label }}
                    </option>
                  </optgroup>

                  <!-- Claude Models -->
                  <optgroup *ngIf="hasModelsForProvider('claude')" label="Claude (Anthropic)">
                    <option *ngFor="let model of getModelsByProvider('claude')" [value]="model.value">
                      {{ model.label }}
                    </option>
                  </optgroup>

                  <!-- OpenAI Models -->
                  <optgroup *ngIf="hasModelsForProvider('openai')" label="OpenAI">
                    <option *ngFor="let model of getModelsByProvider('openai')" [value]="model.value">
                      {{ model.label }}
                    </option>
                  </optgroup>
                </select>
                <button
                  type="button"
                  class="btn-save-default"
                  [class.saved]="savedAsDefault()"
                  (click)="saveAsDefault(getTaskConfig(task.type).aiModel)"
                  [disabled]="loadingModels() || !getTaskConfig(task.type).aiModel || savedAsDefault()"
                  [title]="savedAsDefault() ? 'Saved!' : 'Save this model as your default for future analysis'"
                >
                  @if (savedAsDefault()) {
                    âœ“ Saved!
                  } @else {
                    ðŸ’¾ Save as Default
                  }
                </button>
              </div>

              <!-- Detection Sensitivity Slider -->
              <div class="form-group granularity-group">
                <div class="label-row">
                  <label>Detection Sensitivity</label>
                  <span class="granularity-value">{{ getGranularityLabel(getTaskConfig(task.type).analysisGranularity || 5) }}</span>
                </div>
                <div class="slider-container">
                  <span class="slider-label-left">Strict</span>
                  <input
                    type="range"
                    min="1"
                    max="10"
                    step="1"
                    [value]="getTaskConfig(task.type).analysisGranularity || 5"
                    (input)="updateTaskConfig(task.type, { analysisGranularity: +$any($event.target).value })"
                    (change)="onGranularityChange(+$any($event.target).value)"
                    class="granularity-slider"
                  />
                  <span class="slider-label-right">Aggressive</span>
                </div>
                <div class="granularity-description">
                  {{ getGranularityDescription(getTaskConfig(task.type).analysisGranularity || 5) }}
                </div>
              </div>

              <!-- Info Box -->
              <div class="info-box">
                <div class="info-icon">ðŸ’¡</div>
                <div class="info-content">
                  <strong>Custom instructions are optional.</strong>
                  The AI uses your <strong>Categories</strong> (configured in Settings) to analyze videos.
                  Only use custom instructions for one-time, specific guidance.
                </div>
              </div>

              <!-- Custom Instructions with History -->
              <div class="form-group custom-instructions-group">
                <div class="label-row">
                  <label>Custom Instructions (optional)</label>
                  <button
                    type="button"
                    class="history-btn"
                    [class.disabled]="instructionsHistory().length === 0"
                    (click)="instructionsHistory().length > 0 && toggleInstructionsDropdown()"
                    [title]="instructionsHistory().length > 0 ? 'View previous instructions' : 'No history yet'">
                    History ({{ instructionsHistory().length }})
                  </button>
                </div>
                <div class="instructions-wrapper">
                  <textarea
                    rows="3"
                    placeholder="Example: 'This is a tech conference talk. Focus on product announcements and pricing details.'"
                    [value]="getTaskConfig(task.type).customInstructions || ''"
                    (input)="updateTaskConfig(task.type, { customInstructions: $any($event.target).value })"
                  ></textarea>
                  <div class="instructions-dropdown" *ngIf="showInstructionsDropdown() && instructionsHistory().length > 0">
                    <div class="dropdown-header">
                      <span>Recent Instructions</span>
                      <button type="button" class="close-dropdown" (click)="showInstructionsDropdown.set(false)">Ã—</button>
                    </div>
                    <div class="dropdown-list">
                      <button
                        *ngFor="let item of instructionsHistory()"
                        type="button"
                        class="dropdown-item"
                        (click)="selectHistoryItem(item)"
                        [title]="item.instruction_text">
                        {{ truncateInstruction(item.instruction_text) }}
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="onClose()">Cancel</button>
      <button class="btn btn-primary" (click)="onSave()" [disabled]="tasks().size === 0">
        Apply
      </button>
    </div>
  </div>
</div>
