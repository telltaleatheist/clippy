<div class="modal-backdrop" *ngIf="isOpen" (click)="close()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">Download from URL</h2>
      <button class="close-btn" (click)="close()" aria-label="Close">‚úï</button>
    </div>

    <div class="modal-body">
      <!-- URL Input -->
      <div class="url-section">
        <label class="section-label">Video URLs</label>
        <textarea
          class="url-input"
          [(ngModel)]="urlText"
          placeholder="Enter one or more URLs (one per line)&#10;https://youtube.com/watch?v=...&#10;https://vimeo.com/..."
          rows="4"
        ></textarea>
        <span class="url-count" *ngIf="getUrlCount() > 0">
          {{ getUrlCount() }} URL{{ getUrlCount() !== 1 ? 's' : '' }}
        </span>
      </div>

      <!-- Tasks -->
      <div class="tasks-section">
        <label class="section-label">Tasks to Run</label>
        <div class="tasks-list">
          <!-- Download & Import (always selected for URL downloads) -->
          <div class="task-item selected">
            <div class="task-header">
              <span class="task-icon">‚¨áÔ∏è</span>
              <div class="task-info">
                <span class="task-label">Download and Import</span>
                <span class="task-description">Download video from URL and add to library</span>
              </div>
              <span class="selection-indicator">‚úì</span>
            </div>
          </div>

          <!-- Fix Aspect Ratio -->
          <div class="task-item" [class.selected]="settings.fixAspectRatio">
            <div class="task-header" (click)="settings.fixAspectRatio = !settings.fixAspectRatio">
              <span class="task-icon">üìê</span>
              <div class="task-info">
                <span class="task-label">Fix Aspect Ratio</span>
                <span class="task-description">Correct video aspect ratio issues</span>
              </div>
              <span class="selection-indicator" *ngIf="settings.fixAspectRatio">‚úì</span>
            </div>
          </div>

          <!-- Normalize Audio -->
          <div class="task-item" [class.selected]="settings.normalizeAudio">
            <div class="task-header" (click)="settings.normalizeAudio = !settings.normalizeAudio">
              <span class="task-icon">üîä</span>
              <div class="task-info">
                <span class="task-label">Normalize Audio</span>
                <span class="task-description">Normalize audio levels to standard volume</span>
              </div>
              <span class="selection-indicator" *ngIf="settings.normalizeAudio">‚úì</span>
            </div>
          </div>

          <!-- Transcribe -->
          <div class="task-item" [class.selected]="settings.transcribe">
            <div class="task-header" (click)="settings.transcribe = !settings.transcribe">
              <span class="task-icon">üìù</span>
              <div class="task-info">
                <span class="task-label">Transcribe</span>
                <span class="task-description">Generate transcript using Whisper</span>
              </div>
              <span class="selection-indicator" *ngIf="settings.transcribe">‚úì</span>
            </div>
            <!-- Transcribe Config -->
            <div class="task-config" *ngIf="settings.transcribe">
              <div class="config-form">
                <div class="form-group">
                  <label>Whisper Model</label>
                  <select [(ngModel)]="settings.whisperModel">
                    <option *ngFor="let model of whisperModels" [value]="model.id">
                      {{ model.name }} - {{ model.description }}
                    </option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Language (optional)</label>
                  <input
                    type="text"
                    placeholder="Auto-detect"
                    [(ngModel)]="settings.whisperLanguage"
                  />
                </div>
                <div class="form-group">
                  <label class="checkbox-label">
                    <input
                      type="checkbox"
                      [(ngModel)]="settings.whisperTranslate"
                    />
                    <span>Translate to English</span>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- AI Analyze -->
          <div class="task-item" [class.selected]="settings.aiAnalysis">
            <div class="task-header" (click)="settings.aiAnalysis = !settings.aiAnalysis">
              <span class="task-icon">ü§ñ</span>
              <div class="task-info">
                <span class="task-label">AI Analyze</span>
                <span class="task-description">Analyze content with AI</span>
              </div>
              <span class="selection-indicator" *ngIf="settings.aiAnalysis">‚úì</span>
            </div>
            <!-- AI Config -->
            <div class="task-config" *ngIf="settings.aiAnalysis">
              <div class="config-form">
                <div class="form-group">
                  <label>AI Model</label>
                  <select [(ngModel)]="settings.aiModel" (change)="onAiModelChange()" [disabled]="loadingModels">
                    <option *ngIf="loadingModels" value="">Loading models...</option>
                    <option *ngIf="!loadingModels && aiModels.length === 0" value="">No models available</option>

                    <optgroup *ngIf="hasModelsForProvider('local')" label="Local AI (Bundled)">
                      <option *ngFor="let model of getModelsByProvider('local')" [value]="model.value">
                        {{ model.label }}
                      </option>
                    </optgroup>

                    <optgroup *ngIf="hasModelsForProvider('ollama')" label="Ollama">
                      <option *ngFor="let model of getModelsByProvider('ollama')" [value]="model.value">
                        {{ model.label }}
                      </option>
                    </optgroup>

                    <optgroup *ngIf="hasModelsForProvider('claude')" label="Claude (Anthropic)">
                      <option *ngFor="let model of getModelsByProvider('claude')" [value]="model.value">
                        {{ model.label }}
                      </option>
                    </optgroup>

                    <optgroup *ngIf="hasModelsForProvider('openai')" label="OpenAI">
                      <option *ngFor="let model of getModelsByProvider('openai')" [value]="model.value">
                        {{ model.label }}
                      </option>
                    </optgroup>
                  </select>
                  <button
                    type="button"
                    class="btn-save-default"
                    [class.saved]="savedAsDefault"
                    (click)="saveAsDefault()"
                    [disabled]="loadingModels || !settings.aiModel || savedAsDefault"
                    [title]="savedAsDefault ? 'Saved!' : 'Save this model as your default for future analysis'"
                  >
                    <ng-container *ngIf="savedAsDefault">‚úì Saved!</ng-container>
                    <ng-container *ngIf="!savedAsDefault">üíæ Save as Default</ng-container>
                  </button>
                </div>

                <!-- Analysis Granularity Slider -->
                <div class="form-group granularity-group">
                  <div class="label-row">
                    <label>Detection Sensitivity</label>
                    <span class="granularity-value">{{ getGranularityLabel() }}</span>
                  </div>
                  <div class="slider-container">
                    <span class="slider-label-left">Strict</span>
                    <input
                      type="range"
                      min="1"
                      max="10"
                      step="1"
                      [(ngModel)]="settings.analysisGranularity"
                      (change)="onGranularityChange()"
                      class="granularity-slider"
                    />
                    <span class="slider-label-right">Aggressive</span>
                  </div>
                  <div class="granularity-description">
                    {{ getGranularityDescription() }}
                  </div>
                </div>

                <!-- Custom Instructions Info Box -->
                <div class="info-box">
                  <div class="info-icon">üí°</div>
                  <div class="info-content">
                    <strong>Custom instructions are optional.</strong>
                    The AI uses your <strong>Categories</strong> (configured in Settings) to analyze videos.
                    Only use custom instructions for one-time, specific guidance that doesn't fit your categories.
                  </div>
                </div>

                <div class="form-group custom-instructions-group">
                  <div class="label-row">
                    <label>Custom Instructions (optional)</label>
                    <button
                      type="button"
                      class="history-btn"
                      [class.disabled]="instructionsHistory.length === 0"
                      (click)="instructionsHistory.length > 0 && toggleInstructionsDropdown()"
                      [title]="instructionsHistory.length > 0 ? 'View previous instructions' : 'No history yet'">
                      History ({{ instructionsHistory.length }})
                    </button>
                  </div>
                  <div class="instructions-wrapper">
                    <textarea
                      rows="3"
                      placeholder="Example: 'This is a tech conference talk. Focus on product announcements and pricing details.'"
                      [(ngModel)]="settings.customInstructions"
                    ></textarea>
                    <div class="instructions-dropdown" *ngIf="showInstructionsDropdown && instructionsHistory.length > 0">
                      <div class="dropdown-header">
                        <span>Recent Instructions</span>
                        <button type="button" class="close-dropdown" (click)="showInstructionsDropdown = false">√ó</button>
                      </div>
                      <div class="dropdown-list">
                        <button
                          *ngFor="let item of instructionsHistory"
                          type="button"
                          class="dropdown-item"
                          (click)="selectHistoryItem(item)"
                          [title]="item.instruction_text">
                          {{ truncateInstruction(item.instruction_text) }}
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="close()">Cancel</button>
      <button
        class="btn btn-primary"
        (click)="onSubmit()"
        [disabled]="getUrlCount() === 0"
      >
        <span>Add to Queue</span>
        <span class="task-count" *ngIf="getUrlCount() > 0">
          ({{ getUrlCount() }} video{{ getUrlCount() !== 1 ? 's' : '' }})
        </span>
      </button>
    </div>
  </div>
</div>
