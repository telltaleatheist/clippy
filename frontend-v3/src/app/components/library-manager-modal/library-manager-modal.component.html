@if (show) {
  <div class="modal-backdrop" (click)="onBackdropClick($event)">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <!-- Header -->
      <div class="modal-header">
        <div class="header-content">
          <span class="header-icon">ğŸ“š</span>
          <h2 class="modal-title">Library Manager</h2>
        </div>
        <button class="close-btn" (click)="close()" title="Close">Ã—</button>
      </div>

      <!-- Mode Tabs -->
      <div class="mode-tabs">
        <button
          class="tab-btn"
          [class.active]="mode() === 'select'"
          (click)="switchMode('select')"
        >
          <span class="tab-icon">ğŸ“‚</span>
          <span class="tab-label">Select</span>
        </button>
        <button
          class="tab-btn"
          [class.active]="mode() === 'create'"
          (click)="switchMode('create')"
        >
          <span class="tab-icon">â•</span>
          <span class="tab-label">Create</span>
        </button>
        <button
          class="tab-btn"
          [class.active]="mode() === 'open'"
          (click)="switchMode('open')"
        >
          <span class="tab-icon">ğŸ“‚</span>
          <span class="tab-label">Open</span>
        </button>
      </div>

      <!-- Content -->
      <div class="modal-body">
        <!-- Select Existing Library Mode -->
        @if (mode() === 'select') {
          <div class="select-mode">
            @if (existingLibraries.length > 0) {
              <div class="libraries-cascade">
                <app-cascade
                  [weeks]="libraryWeeks()"
                  [showStatusIndicator]="false"
                  [showDuration]="false"
                  [showDeleteButton]="true"
                  [showEditButton]="true"
                  [deleteMode]="'simple'"
                  (selectionChanged)="onCascadeSelectionChanged($event)"
                  (videoAction)="onCascadeAction($event)"
                />
              </div>

              <!-- Inline Edit Panel -->
              @if (editingLibrary()) {
                <div class="edit-panel">
                  <div class="edit-panel-header">
                    <span class="edit-icon">âœï¸</span>
                    <span class="edit-title">Edit Library</span>
                    <button class="edit-close-btn" (click)="cancelEdit()">Ã—</button>
                  </div>
                  <div class="edit-panel-body">
                    <div class="form-group">
                      <label class="form-label" for="edit-name">
                        <span class="label-icon">ğŸ“š</span>
                        Library Name
                      </label>
                      <input
                        id="edit-name"
                        type="text"
                        class="form-input"
                        [value]="editName()"
                        (input)="editName.set($any($event.target).value)"
                      />
                    </div>
                    <div class="form-group">
                      <label class="form-label" for="edit-path">
                        <span class="label-icon">ğŸ“‚</span>
                        Library Path
                      </label>
                      <div class="path-input-group">
                        <input
                          id="edit-path"
                          type="text"
                          class="form-input path-input"
                          [value]="editPath()"
                          (input)="editPath.set($any($event.target).value)"
                        />
                        <button class="browse-btn" (click)="browseEditPath()">
                          <span class="browse-icon">ğŸ”</span>
                          Browse
                        </button>
                      </div>
                    </div>
                    <div class="edit-panel-actions">
                      <button class="edit-cancel-btn" (click)="cancelEdit()">Cancel</button>
                      <button class="edit-save-btn" (click)="saveEdit()" [disabled]="!isEditValid()">
                        <span>ğŸ’¾</span>
                        Save Changes
                      </button>
                    </div>
                  </div>
                </div>
              }
            } @else {
              <div class="empty-state">
                <div class="empty-icon">ğŸ“š</div>
                <h3>No Libraries Found</h3>
                <p>Create a new library to get started</p>
                <button class="create-first-btn" (click)="switchMode('create')">
                  <span>â•</span>
                  Create Your First Library
                </button>
              </div>
            }
          </div>
        }

        <!-- Create New Library Mode -->
        @if (mode() === 'create') {
          <div class="create-mode">
            <div class="form-section">
              <h3 class="section-title">Library Details</h3>

              <!-- Library Name -->
              <div class="form-group">
                <label class="form-label" for="library-name">
                  <span class="label-icon">âœï¸</span>
                  Library Name
                </label>
                <input
                  id="library-name"
                  type="text"
                  class="form-input"
                  placeholder="e.g., My Video Collection"
                  [value]="newLibraryName()"
                  (input)="newLibraryName.set($any($event.target).value)"
                  autofocus
                />
              </div>

              <!-- Library Location -->
              <div class="form-group">
                <label class="form-label" for="library-path">
                  <span class="label-icon">ğŸ“‚</span>
                  Library Location
                </label>
                <div class="path-input-group">
                  <input
                    id="library-path"
                    type="text"
                    class="form-input path-input"
                    placeholder="e.g., /Users/username/Videos"
                    [value]="newLibraryPath()"
                    (input)="newLibraryPath.set($any($event.target).value)"
                  />
                  <button class="browse-btn" (click)="browsePath()">
                    <span class="browse-icon">ğŸ”</span>
                    Browse
                  </button>
                </div>
                <p class="input-hint">Choose a folder where your videos will be stored</p>
              </div>

              <!-- Preview -->
              @if (newLibraryName() || newLibraryPath()) {
                <div class="preview-section">
                  <h4 class="preview-title">Preview</h4>
                  <div class="preview-card">
                    <div class="preview-icon">ğŸ¬</div>
                    <div class="preview-info">
                      <div class="preview-name">
                        {{ newLibraryName() || 'Untitled Library' }}
                      </div>
                      <div class="preview-path">
                        {{ newLibraryPath() || 'No location selected' }}
                      </div>
                    </div>
                  </div>
                </div>
              }
            </div>
          </div>
        }

        <!-- Open Library Mode -->
        @if (mode() === 'open') {
          <div class="open-mode">
            <div class="form-section">
              <h3 class="section-title">Open Existing Library</h3>
              <p class="section-description">
                Browse to a folder containing an existing library database (.library.db) to add it to your library list.
              </p>

              <!-- Library Location -->
              <div class="form-group">
                <label class="form-label" for="open-path">
                  <span class="label-icon">ğŸ“‚</span>
                  Library Folder Path
                </label>
                <div class="path-input-group">
                  <input
                    id="open-path"
                    type="text"
                    class="form-input path-input"
                    placeholder="e.g., /Users/username/Videos/MyLibrary"
                    [value]="openLibraryPath()"
                    (input)="openLibraryPath.set($any($event.target).value)"
                    autofocus
                  />
                  <button class="browse-btn" (click)="browseOpenLibraryPath()">
                    <span class="browse-icon">ğŸ”</span>
                    Browse
                  </button>
                </div>
                <p class="input-hint">Select the folder that contains your existing library</p>
              </div>

              <!-- Info Box -->
              <div class="info-box">
                <div class="info-icon">ğŸ’¡</div>
                <div class="info-content">
                  <h4 class="info-title">What happens when opening a library?</h4>
                  <ul class="info-list">
                    <li>The app will load the library database from the folder</li>
                    <li>Your videos and organization will be preserved</li>
                    <li>The library will appear in your libraries list</li>
                  </ul>
                </div>
              </div>

              <!-- Preview -->
              @if (openLibraryPath()) {
                <div class="preview-section">
                  <h4 class="preview-title">Selected Path</h4>
                  <div class="preview-card open-preview">
                    <div class="preview-icon">ğŸ“‚</div>
                    <div class="preview-info">
                      <div class="preview-label">Opening from:</div>
                      <div class="preview-path">{{ openLibraryPath() }}</div>
                    </div>
                  </div>
                </div>
              }
            </div>
          </div>
        }
      </div>

      <!-- Footer Actions -->
      <div class="modal-footer">
        <button class="footer-btn cancel-btn" (click)="close()">
          Cancel
        </button>
        <button
          class="footer-btn confirm-btn"
          [disabled]="!isValid()"
          (click)="confirm()"
        >
          @if (mode() === 'select') {
            <span class="btn-icon">âœ“</span>
            <span>Select Library</span>
          } @else if (mode() === 'create') {
            <span class="btn-icon">â•</span>
            <span>Create Library</span>
          } @else {
            <span class="btn-icon">ğŸ“‚</span>
            <span>Open Library</span>
          }
        </button>
      </div>

      <!-- Delete Confirmation Dialog -->
      @if (showDeleteConfirm()) {
        <div class="confirm-overlay" (click)="cancelDelete()">
          <div class="confirm-dialog" (click)="$event.stopPropagation()">
            <div class="confirm-icon">âš ï¸</div>
            <h3 class="confirm-title">Delete {{ selectedCount }} {{ selectedCount === 1 ? 'Library' : 'Libraries' }}?</h3>
            <p class="confirm-message">
              This action cannot be undone. The library database and all associated metadata will be permanently deleted.
            </p>
            <div class="confirm-actions">
              <button class="confirm-btn-cancel" (click)="cancelDelete()">Cancel</button>
              <button class="confirm-btn-delete" (click)="confirmDelete()">
                <span>ğŸ—‘ï¸</span>
                Delete
              </button>
            </div>
          </div>
        </div>
      }
    </div>
  </div>
}
