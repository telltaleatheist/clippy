<div class="video-editor" [class.fullscreen]="isFullscreen()" [class.timeline-hidden]="isFullscreen() && !showTimelineInFullscreen()">
  <!-- Header with controls -->
  <div class="editor-header">
    <div class="header-left">
      <button class="back-btn" (click)="goBack()" title="Back to Library">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
        </svg>
      </button>
      <h2 class="editor-title">Video Editor</h2>
      <span class="project-name">{{ metadata().filename }}</span>
    </div>

    <div class="header-center">
      <!-- Keep header center empty or add other controls later -->
    </div>

    <div class="header-right">
      <button
        class="sidebar-toggle"
        [class.active]="showAnalysisSidebar()"
        (click)="toggleAnalysisSidebar()"
        title="Toggle Analysis Panel">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
          <polyline points="16 17 21 12 16 7"/>
          <line x1="21" y1="12" x2="9" y2="12"/>
        </svg>
      </button>
      <button
        class="fullscreen-toggle"
        [class.active]="isFullscreen()"
        (click)="toggleFullscreen()"
        title="Toggle Fullscreen">
        @if (isFullscreen()) {
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"/>
          </svg>
        } @else {
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
          </svg>
        }
      </button>
    </div>
  </div>

  <!-- Main editor area -->
  <div class="editor-main">
    <!-- Center Content Area -->
    <div class="editor-content">
      <!-- Video Player Area -->
      <div class="video-player-area" #videoPlayerArea>
        <!-- Orange border overlay - dimensions calculated by ResizeObserver -->
        @if (showBorder()) {
          <div class="video-border-overlay"
               [style.width.px]="borderWidth()"
               [style.height.px]="borderHeight()"></div>
        }

        <!-- Video player with scale transform -->
        <div class="video-scale-wrapper" [style.transform]="'scale(' + videoScale() + ')'">
          <app-video-player
            [videoUrl]="videoUrl()"
            [currentTime]="editorState().currentTime"
            [isPlaying]="editorState().isPlaying"
            [volume]="editorState().volume"
            [playbackRate]="editorState().playbackRate"
            (timeUpdate)="onVideoTimeUpdate($event)"
            (durationChange)="onVideoDurationChange($event)"
            (playStateChange)="onVideoPlayStateChange($event)"
            (ended)="onVideoEnded()"
            (doubleClick)="toggleFullscreen()">
          </app-video-player>
        </div>
      </div>

      <!-- Resize Handle -->
      <div
        class="resize-handle"
        [class.dragging]="isResizing()"
        (mousedown)="onResizeStart($event)">
      </div>

      <!-- Timeline Area -->
      <div class="timeline-area" [style.height.px]="timelineHeight()">
        <!-- Timeline Toolbar -->
        <div class="timeline-toolbar">
          <div class="toolbar-left">
            <!-- Tool buttons -->
            <div class="tool-buttons">
              <button
                class="tool-btn"
                [class.active]="currentTool() === 'cursor'"
                (click)="setToolCursor()"
                title="Cursor Tool (A)">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M7 2l12 11.2-5.8.5-3.3 5.3L7 2z"/>
                </svg>
              </button>
              <button
                class="tool-btn"
                [class.active]="currentTool() === 'highlight'"
                (click)="setToolHighlight()"
                title="Range Selection Tool (R)">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M3.5 18.5l4-4L11 18v3H8l-4.5-2.5zM20.7 7c.4-.4.4-1 0-1.4l-2.3-2.3c-.4-.4-1-.4-1.4 0l-1.5 1.5 3.7 3.7L20.7 7zM6 12.5L16.5 2l3.7 3.7L9.7 16.2l-4.2.5.5-4.2z"/>
                </svg>
              </button>
            </div>

            <!-- Scale Control -->
            <div class="scale-control">
              <label class="scale-label">Scale</label>
              <input
                type="range"
                class="scale-slider"
                min="1.0"
                max="10.0"
                step="0.1"
                [value]="videoScale()"
                (input)="onScaleChange($any($event.target).value)"
                title="Video Scale (Zoom)">
              <span class="scale-value">{{ videoScale().toFixed(1) }}x</span>
            </div>

            <!-- Border Controls -->
            <div class="border-control">
              <label class="border-checkbox">
                <input
                  type="checkbox"
                  [checked]="showBorder()"
                  (change)="toggleBorder()">
                <span class="checkbox-label">Border</span>
              </label>
              <select
                class="aspect-ratio-select"
                [value]="borderAspectRatio()"
                (change)="onAspectRatioChange($any($event.target).value)"
                [disabled]="!showBorder()">
                <option value="16:9">16:9</option>
                <option value="4:3">4:3</option>
              </select>
            </div>
          </div>
          <div class="toolbar-center">
            <!-- Play/Pause -->
            <button class="toolbar-btn play-btn" (click)="togglePlayPause()" title="Play/Pause (Space)">
              @if (editorState().isPlaying) {
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                </svg>
              } @else {
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M8 5v14l11-7z"/>
                </svg>
              }
            </button>

            <!-- Time display -->
            <div class="time-display compact">
              <span class="current-time">{{ formattedCurrentTime() }}</span>
              <span class="time-separator">/</span>
              <span class="total-time">{{ formattedDuration() }}</span>
            </div>

            <!-- Playback speed -->
            <div class="speed-selector">
              <select
                [value]="editorState().playbackRate"
                (change)="setPlaybackRate(+$any($event.target).value)"
                title="Speed (L/J to adjust)">
                <option value="0.25">0.25x</option>
                <option value="0.5">0.5x</option>
                <option value="0.75">0.75x</option>
                <option value="1">1x</option>
                <option value="1.5">1.5x</option>
                <option value="2">2x</option>
                <option value="3">3x</option>
                <option value="4">4x</option>
              </select>
            </div>

            <!-- Volume -->
            <div class="volume-control">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>
              </svg>
              <input
                type="range"
                class="volume-slider"
                min="0"
                max="1"
                step="0.01"
                [value]="editorState().volume"
                (input)="setVolume(+$any($event.target).value)"
              />
            </div>
          </div>
          <div class="toolbar-right">
            <button
              class="toolbar-btn"
              [class.active]="isFullscreen()"
              (click)="toggleFullscreen()"
              title="Fullscreen (F)">
              @if (isFullscreen()) {
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"/>
                </svg>
              } @else {
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
                </svg>
              }
            </button>
          </div>
        </div>

        <!-- Timeline ruler -->
        <app-timeline-ruler
          [duration]="editorState().duration"
          [zoomState]="editorState().zoomState"
          (seek)="seekTo($event)">
        </app-timeline-ruler>

        <!-- Timeline tracks -->
        <div class="timeline-tracks">
          <!-- Track content -->
          <div class="track-content"
               (mousedown)="onTimelineMouseDown($event)"
               (click)="onTimelineClick($event)"
               (contextmenu)="onTimelineClick($event)">
            <!-- Track wrapper for vertical centering -->
            <div class="track-wrapper">
              <!-- Unified timeline track component -->
              <app-timeline-track
                [sections]="filteredSections()"
                [duration]="editorState().duration"
                [zoomState]="editorState().zoomState"
                [selectedSection]="editorState().selectedSection"
                [waveformData]="waveformData()"
                [waveformColor]="settings().waveformColor"
                [selection]="highlightSelection()"
                (sectionClick)="onSectionClick($event)"
                (sectionHover)="onSectionHover($event)"
                (selectionHandleStart)="onSelectionHandleStart($event.event, $event.handle)"
                (selectionDragStart)="onSelectionDragStart($event)">
              </app-timeline-track>
            </div>
          </div>
        </div>

        <!-- Playhead wrapper with proper margins -->
        <div class="playhead-wrapper">
          <app-timeline-playhead
            [currentTime]="editorState().currentTime"
            [duration]="editorState().duration"
            [zoomState]="editorState().zoomState"
            (seek)="seekTo($event)">
          </app-timeline-playhead>
        </div>

        <!-- Zoom bar -->
        <app-timeline-zoom-bar
          [duration]="editorState().duration"
          [zoomState]="editorState().zoomState"
          (zoomChange)="onZoomChange($event)">
        </app-timeline-zoom-bar>
      </div>
    </div>

    <!-- Analysis Sidebar (Right) -->
    @if (showAnalysisSidebar()) {
      <div class="analysis-sidebar">
        <app-analysis-panel
          [sections]="filteredSections()"
          [categoryFilters]="categoryFilters()"
          [selectedSection]="editorState().selectedSection"
          [analysisData]="analysisData()"
          [hasAnalysis]="hasAnalysis()"
          [videoId]="videoId() ?? undefined"
          [transcript]="transcript()"
          (sectionClick)="onSectionClick($event)"
          (sectionDelete)="onSectionDeleteFromPanel($event)"
          (filterToggle)="onFilterToggle($event)"
          (generateAnalysis)="onGenerateAnalysis($event)"
          (transcriptSeek)="seekTo($event)">
        </app-analysis-panel>
      </div>
    }
  </div>
</div>

<!-- Context Menu -->
@if (showContextMenu$()) {
  <app-context-menu
    [position]="contextMenuPosition()"
    [actions]="contextMenuActions()"
    (actionSelected)="onContextMenuAction($event)"
    (closed)="onContextMenuClose()">
  </app-context-menu>
}

<!-- Marker Dialog -->
@if (showMarkerDialog() && markerDialogData()) {
  <app-marker-dialog
    [data]="markerDialogData()!"
    (save)="onMarkerSave($event)"
    (cancel)="onMarkerCancel()"
    (delete)="onMarkerDelete($event)">
  </app-marker-dialog>
}

<!-- Export Dialog -->
@if (showExportDialog() && exportDialogData()) {
  <app-export-dialog
    [data]="exportDialogData()!"
    (close)="onExportDialogClose()">
  </app-export-dialog>
}
