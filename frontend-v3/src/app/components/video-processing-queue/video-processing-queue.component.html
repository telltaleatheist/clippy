<div class="queue-container">
  <!-- Header -->
  <header class="queue-header">
    <div class="header-left">
      <h1 class="title">Processing Queue</h1>
      <div class="stats">
        <span class="stat remaining-count" *ngIf="stats().pending > 0 || stats().running > 0">
          <span class="count-badge">{{ stats().pending + stats().running }}</span>
          {{ stats().pending + stats().running === 1 ? 'item' : 'items' }} remaining
        </span>
        <span class="stat" *ngIf="stats().running > 0">
          <span class="dot running"></span>
          {{ stats().running }} running
        </span>
        <span class="stat" *ngIf="stats().pending > 0">{{ stats().pending }} pending</span>
        <span class="stat" *ngIf="stats().completed > 0">{{ stats().completed }} done</span>
      </div>
    </div>
    <div class="header-actions">
      <button
        class="btn-secondary"
        (click)="openBulkConfig()"
        [disabled]="pendingItems().length === 0"
        title="Configure all items at once"
      >
        âš™ï¸ Configure All
      </button>
      <button class="btn-primary" (click)="processQueue()" [disabled]="stats().pending === 0">
        â–¶ Process
      </button>
    </div>
  </header>

  <!-- Queue List -->
  <div class="queue-list">
    <!-- Empty State -->
    <div class="empty" *ngIf="pendingItems().length === 0">
      <span class="empty-icon">ğŸ“‹</span>
      <p>No items in queue</p>
      <button class="btn-secondary" (click)="openAddDialog()">Add Video</button>
    </div>

    <!-- Queue Items -->
    <div
      class="queue-item"
      *ngFor="let item of pendingItems()"
      [class.expanded]="isItemExpanded(item.id)"
      [class.running]="item.status === 'running'"
    >
      <!-- Item Header (clickable) -->
      <div class="item-header" (click)="toggleItemExpanded(item.id)">
        <span class="expand-icon">{{ isItemExpanded(item.id) ? 'â–¼' : 'â–¶' }}</span>
        <div class="item-main">
          <div class="item-name">{{ getItemName(item) }}</div>
          <div class="task-summary">
            {{ item.tasks.length }} task{{ item.tasks.length !== 1 ? 's' : '' }}
            <span *ngIf="item.status === 'running'"> â€¢ {{ formatProgress(item.overallProgress) }}</span>
          </div>
        </div>

        <!-- Overall Progress (when running) -->
        <div class="item-progress" *ngIf="item.status === 'running'">
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="item.overallProgress || 0"></div>
          </div>
        </div>

        <!-- Actions -->
        <div class="item-actions" (click)="$event.stopPropagation()">
          <button
            class="action-btn"
            (click)="openConfig(item.id)"
            title="Configure"
            [disabled]="item.status === 'running'"
          >
            âš™ï¸
          </button>
          <button
            class="action-btn danger"
            (click)="removeItem(item.id)"
            title="Remove"
          >
            âœ•
          </button>
        </div>
      </div>

      <!-- Expanded Content -->
      <div class="item-content" *ngIf="isItemExpanded(item.id)">
        <div class="task-list">
          <div
            class="task-item"
            *ngFor="let task of item.tasks"
            [class.running]="task.status === 'running'"
            [class.completed]="task.status === 'completed'"
            [class.failed]="task.status === 'failed'"
          >
            <span class="task-icon">{{ getTaskIcon(task.type) }}</span>
            <span class="task-label">{{ getTaskLabel(task.type) }}</span>
            <div class="task-progress-bar" *ngIf="task.status === 'running' || task.status === 'completed'">
              <div class="task-progress-fill" [style.width.%]="task.progress || 0"></div>
            </div>
            <span class="task-status">
              <span *ngIf="task.status === 'pending'">Pending</span>
              <span *ngIf="task.status === 'running'">{{ formatProgress(task.progress) }}</span>
              <span *ngIf="task.status === 'completed'">âœ“</span>
              <span *ngIf="task.status === 'failed'">âœ—</span>
            </span>
          </div>

          <!-- No tasks placeholder -->
          <div class="no-tasks" *ngIf="item.tasks.length === 0">
            No tasks configured - click âš™ï¸ to add tasks
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Completed Accordion -->
  <div class="completed-section" *ngIf="completedItems().length > 0">
    <button class="completed-header" (click)="toggleCompleted()">
      <span class="accordion-icon">{{ completedOpen() ? 'â–¼' : 'â–¶' }}</span>
      <span>Completed ({{ completedItems().length }})</span>
      <button
        class="btn-small"
        (click)="clearCompleted(); $event.stopPropagation()"
      >
        Clear
      </button>
    </button>

    <div class="completed-list" *ngIf="completedOpen()">
      <div
        class="completed-item"
        *ngFor="let item of completedItems()"
        [class.failed]="item.status === 'failed'"
      >
        <span class="status-icon">
          {{ item.status === 'completed' ? 'âœ“' : 'âœ—' }}
        </span>
        <span class="item-name">{{ getItemName(item) }}</span>
        <button class="action-btn danger" (click)="removeItem(item.id)">âœ•</button>
      </div>
    </div>
  </div>
</div>

<!-- Config Modal -->
<app-queue-item-config-modal
  [isOpen]="configModalOpen()"
  [itemSource]="configItemSource()"
  [existingTasks]="configExistingTasks()"
  [bulkMode]="configBulkMode()"
  [itemCount]="pendingItems().length"
  (close)="closeConfig()"
  (save)="onConfigSave($event)"
  (bulkSave)="onBulkConfigSave($event)"
></app-queue-item-config-modal>

<!-- Add Video Dialog -->
<app-video-config-dialog
  [isOpen]="addVideoDialogOpen()"
  (closeDialog)="closeAddDialog()"
  (submitConfig)="onAddVideo($event)"
></app-video-config-dialog>
