<div class="wizard-backdrop">
  <div class="wizard-container">
    <!-- Close Button -->
    <button class="close-btn" (click)="skipSetup()" title="Close">√ó</button>

    <!-- Progress Indicator -->
    <div class="progress-dots" *ngIf="currentStep() !== 'welcome'">
      <span class="dot" [class.active]="currentStep() !== 'done'" [class.completed]="currentStep() === 'done'"></span>
      <span class="dot" [class.active]="currentStep() === 'done'"></span>
    </div>

    <!-- ==================== WELCOME STEP ==================== -->
    @if (currentStep() === 'welcome') {
      <div class="wizard-step welcome-step">
        <div class="step-header">
          <span class="step-icon">ü§ñ</span>
          <h2 class="step-title">AI Features Setup</h2>
          <p class="step-subtitle">Configure AI providers for smart video analysis</p>
        </div>

        <div class="info-banner">
          <span class="banner-icon">üí°</span>
          <div class="banner-content">
            <strong>AI features are optional</strong>
            <p>You can use all library and editing features without AI setup.</p>
          </div>
        </div>

        <div class="feature-preview">
          <h3>AI-Powered Features</h3>
          <div class="features-grid">
            <div class="feature-item">
              <span class="feature-icon">üéØ</span>
              <span>Auto Analysis</span>
            </div>
            <div class="feature-item">
              <span class="feature-icon">üìù</span>
              <span>Transcription</span>
            </div>
            <div class="feature-item">
              <span class="feature-icon">üè∑Ô∏è</span>
              <span>Smart Tags</span>
            </div>
            <div class="feature-item">
              <span class="feature-icon">üîç</span>
              <span>Content Search</span>
            </div>
          </div>
        </div>

        <h3 class="section-title">Choose a Local Provider</h3>

        <div class="info-banner tip">
          <span class="banner-icon">üí°</span>
          <div class="banner-content">
            <strong>Pick one: Local AI or Ollama</strong>
            <p><strong>Local AI</strong> is simpler - one-click setup, works only in this app.<br>
            <strong>Ollama</strong> is more advanced - requires separate install, but models can be used with other apps too.</p>
          </div>
        </div>

        <div class="provider-cards">
          <!-- Local AI Card - Always show -->
          <div class="provider-card recommended" (click)="selectLocal()">
            @if (localAvailable()) {
              <div class="card-badge">Ready</div>
            } @else {
              <div class="card-badge">Recommended</div>
            }
            <div class="card-header">
              <span class="card-icon">üè†</span>
              <div class="card-titles">
                <h4>Local AI</h4>
                <span class="card-tagline">{{ localAvailable() ? 'Ready to Use' : 'Simple - Just Works' }}</span>
              </div>
            </div>
            <ul class="card-features">
              <li class="pro"><span>‚úì</span> {{ localAvailable() ? 'No setup required' : 'One-click download' }}</li>
              <li class="pro"><span>‚úì</span> Works offline</li>
              <li class="pro"><span>‚úì</span> No API costs ever</li>
              <li class="neutral"><span>‚Ñπ</span> Models only work in this app</li>
            </ul>
            <button class="card-btn primary">{{ localAvailable() ? 'Use Local AI' : 'Download Local AI' }}</button>
          </div>

          <!-- Ollama Card -->
          <div class="provider-card" [class.has-status]="ollamaConnected()" (click)="selectProvider('ollama')">
            @if (ollamaAvailable()) {
              <div class="card-badge success">Ready</div>
            } @else if (ollamaConnected()) {
              <div class="card-badge warning">No Models</div>
            }
            <div class="card-header">
              <span class="card-icon">üíª</span>
              <div class="card-titles">
                <h4>Ollama</h4>
                @if (ollamaAvailable()) {
                  <span class="card-tagline">{{ ollamaModels().length }} model(s) ready</span>
                } @else if (ollamaConnected()) {
                  <span class="card-tagline">Running - needs a model</span>
                } @else {
                  <span class="card-tagline">Advanced - More Flexibility</span>
                }
              </div>
            </div>
            <ul class="card-features">
              <li class="pro"><span>‚úì</span> Use models in other apps too</li>
              <li class="pro"><span>‚úì</span> Larger model selection</li>
              <li class="pro"><span>‚úì</span> No API costs ever</li>
              @if (!ollamaConnected()) {
                <li class="con"><span>‚úó</span> Requires separate install</li>
              } @else if (ollamaModels().length === 0) {
                <li class="con"><span>‚úó</span> No models installed yet</li>
              } @else {
                <li class="pro"><span>‚úì</span> {{ ollamaModels().length }} model(s) ready</li>
              }
            </ul>
            <button class="card-btn" [class.primary]="ollamaConnected()">
              @if (ollamaAvailable()) {
                Use Ollama
              } @else if (ollamaConnected()) {
                Download a Model
              } @else {
                Configure Ollama
              }
            </button>
          </div>

          <!-- Claude Card -->
          <div class="provider-card" (click)="selectProvider('claude')">
            <div class="card-header">
              <span class="card-icon">üß†</span>
              <div class="card-titles">
                <h4>Claude API</h4>
                <span class="card-tagline">Best Quality</span>
              </div>
            </div>
            <ul class="card-features">
              <li class="pro"><span>‚úì</span> Highest quality results</li>
              <li class="pro"><span>‚úì</span> No installation needed</li>
              <li class="pro"><span>‚úì</span> Fast processing</li>
              <li class="con"><span>‚úó</span> ~$0.01-0.05 per video</li>
            </ul>
            <button class="card-btn">Configure Claude</button>
          </div>

          <!-- OpenAI Card -->
          <div class="provider-card" (click)="selectProvider('openai')">
            <div class="card-header">
              <span class="card-icon">‚ö°</span>
              <div class="card-titles">
                <h4>OpenAI API</h4>
                <span class="card-tagline">Fast & Reliable</span>
              </div>
            </div>
            <ul class="card-features">
              <li class="pro"><span>‚úì</span> Good quality results</li>
              <li class="pro"><span>‚úì</span> No installation needed</li>
              <li class="pro"><span>‚úì</span> Very fast</li>
              <li class="con"><span>‚úó</span> ~$0.01-0.03 per video</li>
            </ul>
            <button class="card-btn">Configure OpenAI</button>
          </div>
        </div>

        <div class="step-footer">
          <button class="skip-btn" (click)="skipSetup()">
            Skip for now
          </button>
        </div>
      </div>
    }

    <!-- ==================== LOCAL MODELS STEP ==================== -->
    @if (currentStep() === 'local-models') {
      <div class="wizard-step local-models-step">
        <button class="back-btn" (click)="goBack()">
          <span>‚Üê</span> Back
        </button>

        <div class="step-header">
          <span class="step-icon">üè†</span>
          <h2 class="step-title">Local AI Setup</h2>
          <p class="step-subtitle">Download an AI model to run on your computer</p>
        </div>

        <!-- System Info Card -->
        @if (systemInfo()) {
          <div class="system-info-card">
            @if (systemInfo()?.gpu; as gpu) {
              <div class="system-stat gpu">
                <span class="stat-label">üéÆ GPU</span>
                <span class="stat-value">{{ gpu.name }}</span>
              </div>
              <div class="system-stat">
                <span class="stat-label">VRAM</span>
                <span class="stat-value highlight">{{ gpu.vramGB }} GB</span>
              </div>
            } @else {
              <div class="system-stat">
                <span class="stat-label">‚ö†Ô∏è No GPU</span>
                <span class="stat-value">Using CPU</span>
              </div>
            }
            <div class="system-stat">
              <span class="stat-label">System RAM</span>
              <span class="stat-value">{{ systemInfo()!.totalMemoryGB }} GB</span>
            </div>
          </div>
          @if (systemInfo()!.useGpu) {
            <p class="gpu-note success">‚úì GPU acceleration enabled - models will run faster</p>
          } @else if (!systemInfo()!.gpu) {
            <p class="gpu-note warning">Models will run on CPU (slower but works)</p>
          }
        }

        <div class="models-section">
          <h3>Choose a Model</h3>
          <p class="models-hint">
            <span class="hint-icon">‚ÑπÔ∏è</span>
            @if (systemInfo()?.useGpu) {
              Larger models produce better results but need more VRAM
            } @else {
              Larger models produce better results but need more RAM (slower on CPU)
            }
          </p>

          <div class="model-cards">
            @for (model of localModels(); track model.id) {
              <div class="model-card"
                   [class.recommended]="model.id === systemInfo()?.recommendedModel"
                   [class.downloaded]="model.downloaded"
                   [class.active]="model.isDefault">

                @if (model.id === systemInfo()?.recommendedModel && !model.downloaded) {
                  <div class="model-badge">Recommended</div>
                }
                @if (model.isDefault) {
                  <div class="model-badge active">Active</div>
                }

                <div class="model-header">
                  <h4>{{ model.name }}</h4>
                  <span class="model-size">{{ model.sizeGB }} GB</span>
                </div>
                <p class="model-ram">
                  @if (systemInfo()?.useGpu) {
                    Requires {{ model.minRAM }}+ GB VRAM
                  } @else {
                    Requires {{ model.minRAM }}+ GB RAM
                  }
                </p>
                <p class="model-desc">{{ model.description }}</p>

                <div class="model-actions">
                  @if (model.downloaded) {
                    <!-- Downloaded model - show ready status and delete -->
                    <span class="downloaded-badge">‚úì Downloaded</span>
                    <button
                      class="delete-btn"
                      (click)="deleteLocalModel(model.id)"
                      [disabled]="deletingModel() === model.id"
                    >
                      @if (deletingModel() === model.id) {
                        <span class="spinner"></span> Deleting...
                      } @else {
                        üóëÔ∏è Delete
                      }
                    </button>
                  } @else {
                    <!-- Not downloaded - show download button -->
                    @if (downloadingModel() === model.id) {
                      <div class="download-progress">
                        <div class="progress-bar">
                          <div class="progress-fill" [style.width.%]="downloadProgress()"></div>
                        </div>
                        <div class="progress-info">
                          <span>{{ downloadProgress() | number:'1.0-0' }}%</span>
                          @if (downloadSpeed()) {
                            <span class="speed">{{ downloadSpeed() }}</span>
                          }
                          @if (downloadEta()) {
                            <span class="eta">~{{ downloadEta() }}</span>
                          }
                        </div>
                        <button class="cancel-btn" (click)="cancelDownload()">Cancel</button>
                      </div>
                    } @else {
                      <button
                        class="download-btn"
                        (click)="downloadLocalModel(model.id)"
                        [disabled]="downloadingModel() !== null"
                      >
                        <span>‚¨áÔ∏è</span> Download
                      </button>
                    }
                  }
                </div>
              </div>
            }
          </div>
        </div>

        <!-- Ollama alternative notice -->
        @if (ollamaAvailable()) {
          <div class="ollama-detected">
            <span>üíª</span>
            <div>
              <strong>Ollama detected</strong>
              <p>You can also use your existing Ollama installation</p>
            </div>
            <button class="action-btn small" (click)="goToStep('ollama')">Use Ollama</button>
          </div>
        }

        <div class="step-footer">
          <button class="skip-btn" (click)="skipSetup()">Skip for now</button>
          @if (hasDownloadedModel()) {
            <button class="action-btn primary" (click)="continueFromLocalModels()">
              Continue
            </button>
          }
        </div>
      </div>
    }

    <!-- ==================== OLLAMA STEP ==================== -->
    @if (currentStep() === 'ollama') {
      <div class="wizard-step ollama-step">
        <button class="back-btn" (click)="goBack()">
          <span>‚Üê</span> Back
        </button>

        <div class="step-header">
          <span class="step-icon">üíª</span>
          <h2 class="step-title">Install Ollama</h2>
          <p class="step-subtitle">Set up local AI on your {{ platform() }} machine</p>
        </div>

        <div class="instruction-card">
          <h3>Installation Steps</h3>
          <ol class="instruction-list">
            @for (step of getInstallInstructions(); track step) {
              <li>{{ step }}</li>
            }
          </ol>
          <button class="action-btn primary" (click)="openOllamaWebsite()">
            <span>üåê</span> Open Ollama Website
          </button>
        </div>

        <div class="models-section">
          <h3>Download a Model</h3>
          <p class="models-hint">
            <span class="hint-icon">‚ÑπÔ∏è</span>
            The "B" stands for billions of parameters - larger = smarter but needs more RAM
          </p>

          <div class="model-cards">
            @for (model of recommendedModels; track model.name) {
              <div class="model-card" [class.recommended]="model.recommended">
                @if (model.recommended) {
                  <div class="model-badge">Best Choice</div>
                }
                <div class="model-header">
                  <h4>{{ model.name }}</h4>
                  <span class="model-size">{{ model.size }}</span>
                </div>
                <p class="model-ram">{{ model.ramRequirement }}</p>
                <p class="model-desc">{{ model.description }}</p>
                <div class="model-actions">
                  <button
                    class="download-btn"
                    (click)="pullModel(model.name)"
                    [disabled]="pullingModel() === model.name"
                  >
                    @if (pullingModel() === model.name) {
                      <span class="spinner"></span> Downloading...
                    } @else {
                      <span>‚¨áÔ∏è</span> Download
                    }
                  </button>
                  <code class="command">{{ model.pullCommand }}</code>
                </div>
              </div>
            }
          </div>
        </div>

        <div class="status-section">
          <button
            class="check-btn"
            (click)="checkOllama()"
            [disabled]="isCheckingOllama()"
          >
            @if (isCheckingOllama()) {
              <span class="spinner"></span> Checking...
            } @else {
              Check Ollama Status
            }
          </button>

          @if (ollamaAvailable()) {
            <div class="status-result success">
              <span>‚úì</span> Ollama is running with {{ ollamaModels().length }} model(s)
            </div>
          } @else if (ollamaConnected()) {
            <div class="status-result warning">
              <span>‚ö†Ô∏è</span> Ollama is running but no models installed - download one above
            </div>
          } @else {
            <div class="status-result error">
              <span>‚úó</span> Ollama not detected - make sure it's running
            </div>
          }
        </div>

        <div class="step-footer">
          <button class="skip-btn" (click)="skipSetup()">Skip for now</button>
          @if (ollamaAvailable() && ollamaModels().length > 0) {
            <button class="action-btn primary" (click)="goToStep('done')">
              Continue
            </button>
          }
        </div>
      </div>
    }

    <!-- ==================== CLAUDE STEP ==================== -->
    @if (currentStep() === 'claude') {
      <div class="wizard-step api-step">
        <button class="back-btn" (click)="goBack()">
          <span>‚Üê</span> Back
        </button>

        <div class="step-header">
          <span class="step-icon">üß†</span>
          <h2 class="step-title">Claude API Setup</h2>
          <p class="step-subtitle">Connect to Anthropic's Claude API</p>
        </div>

        <div class="instruction-card">
          <h3>Get Your API Key</h3>
          <ol class="instruction-list">
            <li>Sign up or log in to Anthropic Console</li>
            <li>Navigate to API Keys section</li>
            <li>Click "Create Key"</li>
            <li>Copy the key and paste below</li>
          </ol>
          <button class="action-btn" (click)="openClaudeWebsite()">
            <span>üåê</span> Open Anthropic Console
          </button>
        </div>

        <div class="api-input-section">
          <label for="claude-key">Claude API Key</label>
          <div class="input-wrapper">
            <input
              id="claude-key"
              type="password"
              placeholder="sk-ant-api03-..."
              [value]="claudeApiKey()"
              (input)="claudeApiKey.set($any($event.target).value)"
            />
            <span class="input-icon">üîë</span>
          </div>
          <p class="input-hint">Your key is stored locally and never sent anywhere except Anthropic</p>
        </div>

        <div class="step-footer">
          <button class="skip-btn" (click)="skipSetup()">Skip for now</button>
          <button
            class="action-btn primary"
            (click)="saveClaudeKey()"
            [disabled]="!claudeApiKey() || isSavingKeys()"
          >
            @if (isSavingKeys()) {
              <span class="spinner"></span> Saving...
            } @else {
              Save & Continue
            }
          </button>
        </div>
      </div>
    }

    <!-- ==================== OPENAI STEP ==================== -->
    @if (currentStep() === 'openai') {
      <div class="wizard-step api-step">
        <button class="back-btn" (click)="goBack()">
          <span>‚Üê</span> Back
        </button>

        <div class="step-header">
          <span class="step-icon">‚ö°</span>
          <h2 class="step-title">OpenAI API Setup</h2>
          <p class="step-subtitle">Connect to OpenAI's GPT API</p>
        </div>

        <div class="instruction-card">
          <h3>Get Your API Key</h3>
          <ol class="instruction-list">
            <li>Sign up or log in to OpenAI Platform</li>
            <li>Navigate to API Keys page</li>
            <li>Click "Create new secret key"</li>
            <li>Copy the key and paste below</li>
          </ol>
          <button class="action-btn" (click)="openOpenAIWebsite()">
            <span>üåê</span> Open OpenAI Platform
          </button>
        </div>

        <div class="api-input-section">
          <label for="openai-key">OpenAI API Key</label>
          <div class="input-wrapper">
            <input
              id="openai-key"
              type="password"
              placeholder="sk-..."
              [value]="openaiApiKey()"
              (input)="openaiApiKey.set($any($event.target).value)"
            />
            <span class="input-icon">üîë</span>
          </div>
          <p class="input-hint">Your key is stored locally and never sent anywhere except OpenAI</p>
        </div>

        <div class="step-footer">
          <button class="skip-btn" (click)="skipSetup()">Skip for now</button>
          <button
            class="action-btn primary"
            (click)="saveOpenAIKey()"
            [disabled]="!openaiApiKey() || isSavingKeys()"
          >
            @if (isSavingKeys()) {
              <span class="spinner"></span> Saving...
            } @else {
              Save & Continue
            }
          </button>
        </div>
      </div>
    }

    <!-- ==================== DONE STEP ==================== -->
    @if (currentStep() === 'done') {
      <div class="wizard-step done-step">
        <div class="step-header">
          <span class="step-icon success">‚ú®</span>
          <h2 class="step-title">All Set!</h2>
          <p class="step-subtitle">AI features are ready to use</p>
        </div>

        <div class="success-card">
          <h3>Active Providers</h3>
          <div class="provider-list">
            @if (localAvailable()) {
              <div class="provider-item">
                <span class="check-icon">‚úì</span>
                <div>
                  <strong>Local AI</strong>
                  <span>Cogito 8B - Ready to use</span>
                </div>
              </div>
            }
            @if (ollamaAvailable() && ollamaModels().length > 0) {
              <div class="provider-item">
                <span class="check-icon">‚úì</span>
                <div>
                  <strong>Ollama</strong>
                  <span>{{ ollamaModels().length }} model(s) available</span>
                </div>
              </div>
            }
            @if (claudeKeySet()) {
              <div class="provider-item">
                <span class="check-icon">‚úì</span>
                <div>
                  <strong>Claude API</strong>
                  <span>Ready to use</span>
                </div>
              </div>
            }
            @if (openaiKeySet()) {
              <div class="provider-item">
                <span class="check-icon">‚úì</span>
                <div>
                  <strong>OpenAI API</strong>
                  <span>Ready to use</span>
                </div>
              </div>
            }
          </div>
        </div>

        <div class="next-steps-card">
          <h3>What's Next?</h3>
          <ul class="next-steps-list">
            <li>
              <span>üé¨</span>
              <span>Analyze videos from your library</span>
            </li>
            <li>
              <span>üìù</span>
              <span>Get automatic transcriptions</span>
            </li>
            <li>
              <span>üîç</span>
              <span>Search videos by content</span>
            </li>
            <li>
              <span>üè∑Ô∏è</span>
              <span>Auto-generate tags and summaries</span>
            </li>
          </ul>
        </div>

        <div class="step-footer centered">
          <button class="action-btn primary large" (click)="complete()">
            Get Started
          </button>
        </div>
      </div>
    }
  </div>
</div>
