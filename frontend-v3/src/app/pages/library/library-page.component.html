<div class="library-page">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        @if (activeTab() === 'queue') {
          Processing Queue
        } @else if (activeTab() === 'tabs') {
          Tabs
        } @else if (activeTab() === 'manager') {
          Library Manager
        } @else if (activeTab() === 'saved') {
          Saved for Later
        } @else if (activeTab() === 'settings') {
          Settings
        } @else {
          Media Library
        }
      </h1>
      <p class="page-subtitle">
        <span *ngIf="currentLibrary()">{{ currentLibrary()?.name }}</span>
        <span *ngIf="!currentLibrary()">No library selected</span>
      </p>
    </div>
    <div class="header-actions">
      <button
        class="btn btn-primary"
        (click)="openDownloadDialog()"
        title="Download videos from URLs">
        <span class="btn-icon">â¬‡ï¸</span>
        <span>Download</span>
      </button>
      <button
        class="btn btn-primary"
        (click)="openImportDialog()"
        title="Import media files from your computer">
        <span class="btn-icon">ğŸ“</span>
        <span>Import</span>
      </button>
      <button
        class="btn btn-primary"
        [disabled]="selectedCount() !== 1"
        (click)="openInEditor()"
        [title]="selectedCount() === 1 ? 'Open in Video Editor' : 'Select exactly one video'">
        <span class="btn-icon">ğŸ¬</span>
        <span>Video Editor</span>
      </button>
      <button
        class="btn btn-secondary"
        [disabled]="selectedCount() !== 1"
        (click)="viewMore()"
        [title]="selectedCount() === 1 ? 'View video details' : 'Select exactly one video'">
        <span class="btn-icon">â„¹ï¸</span>
        <span>View More</span>
      </button>
      <!-- Add to queue button for library items -->
      <button
        class="btn btn-secondary"
        *ngIf="selectedCount() > 0"
        (click)="onAddSelectedToQueue()">
        <span class="btn-icon">â•</span>
        <span>Add to Queue</span>
        <span class="badge">{{ selectedCount() }}</span>
      </button>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs-section">
    <button
      class="tab"
      [class.active]="activeTab() === 'library'"
      (click)="setActiveTab('library')">
      ğŸ“š Library
    </button>
    <button
      class="tab"
      [class.active]="activeTab() === 'queue'"
      (click)="setActiveTab('queue')">
      âš¡ Queue
      @if (queueStats.total > 0) {
        <span class="tab-badge">{{ queueStats.total }}</span>
      }
    </button>
    <button
      class="tab"
      [class.active]="activeTab() === 'tabs'"
      (click)="setActiveTab('tabs')">
      ğŸ“‘ Tabs
    </button>
    <button
      class="tab"
      [class.active]="activeTab() === 'manager'"
      (click)="setActiveTab('manager')">
      ğŸ”§ Manager
    </button>
    <button
      class="tab"
      [class.active]="activeTab() === 'saved'"
      (click)="setActiveTab('saved')">
      ğŸ’¾ Saved
    </button>
    <button
      class="tab"
      [class.active]="activeTab() === 'settings'"
      (click)="setActiveTab('settings')">
      âš™ï¸ Settings
    </button>
  </div>

  <!-- Search and Filters (Library Tab Only) -->
  <div class="filters-section" *ngIf="activeTab() === 'library'">
    <app-library-search-filters
      (filtersChanged)="onFiltersChanged($event)"
    />
  </div>

  <!-- Manager Toolbar (Manager Tab Only) -->
  <div class="manager-tab-container" *ngIf="activeTab() === 'manager'">
    <app-manager-tab [onLibraryRefresh]="loadLibrary.bind(this)" />
  </div>

  <!-- Main Container with Drag & Drop -->
  <div
    class="main-container"
    [class.dragging-over]="isDraggingOver()"
    (drop)="onDrop($event)"
    (dragover)="onDragOver($event)"
    (dragleave)="onDragLeave($event)">

    <!-- Drop overlay -->
    <div class="drop-overlay" *ngIf="isDraggingOver()">
      <div class="drop-message">
        <div class="drop-icon">ğŸ“</div>
        <div class="drop-text">Drop media files to import</div>
      </div>
    </div>

    <div class="unified-content">
      <!-- Library Tab: Media Library Cascade -->
      @if (activeTab() === 'library') {
        <div class="library-toolbar">
          <div class="toolbar-section">
            <h2 class="section-title">Media Library</h2>
            <p class="section-subtitle">
              {{ totalVideoCount() }} videos
            </p>
          </div>
        </div>
        <app-cascade
          [weeks]="combinedWeeks()"
          (selectionChanged)="onSelectionChanged($event)"
          (videoAction)="onVideoAction($event)"
          (configureItem)="onConfigureItem($event)"
          (previewRequested)="onPreviewRequested($event)"
        />
      }

      <!-- Queue Tab: Staging and Processing queues -->
      <app-queue-tab
        *ngIf="activeTab() === 'queue'"
        [stagingQueue]="stagingQueue()"
        [processingQueue]="processingQueue()"
        [progressMapper]="queueProgressMapper"
        [childrenConfig]="processingChildrenConfig"
        [aiProcessingVideoId]="aiProcessingQueueItemId()"
        (processAll)="onQueueProcessAll()"
        (processSelected)="onQueueProcessSelected($event)"
        (configureSelected)="onQueueConfigureSelected($event)"
        (removeSelected)="onQueueRemoveSelected($event)"
        (cancelProcessing)="onCancelProcessing($event)"
        (viewInLibrary)="onViewInLibrary($event)"
        (configureItem)="onConfigureItem($event)"
        (previewRequested)="onPreviewRequested($event)"
      />

      <!-- Tabs Tab: User-created tabs with videos -->
      <app-tabs-tab
        *ngIf="activeTab() === 'tabs'"
        [onSelectionChanged]="onSelectionChanged.bind(this)"
        [onVideoAction]="onVideoAction.bind(this)"
        [onPreviewRequested]="onPreviewRequested.bind(this)"
      />

      <!-- Saved Tab: Save for Later links -->
      <app-save-for-later-tab *ngIf="activeTab() === 'saved'" />

      <!-- Settings Tab: App settings -->
      <app-settings-page *ngIf="activeTab() === 'settings'" [embedded]="true" />

      <!-- Empty State - Library -->
      <div class="empty-state" *ngIf="activeTab() === 'library' && filteredWeeks().length === 0">
        <div class="empty-icon">ğŸ“¹</div>
        <h3 class="empty-title">No media found</h3>
        <p class="empty-description">
          <span *ngIf="currentFilters?.searchQuery">
            Try adjusting your search filters
          </span>
          <span *ngIf="!currentFilters?.searchQuery">
            Paste URLs above, click Import Files, or drag and drop files here
          </span>
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Config Modal -->
<app-queue-item-config-modal
  [isOpen]="configModalOpen()"
  [itemSource]="configItemSource()"
  [bulkMode]="configBulkMode()"
  [existingTasks]="configExistingTasks()"
  [itemCount]="configItemIds().length"
  (close)="closeConfigModal()"
  (save)="onConfigSave($event)"
  (bulkSave)="onConfigSave($event)"
/>

<!-- Library Manager Modal -->
<app-library-manager-modal
  [show]="libraryManagerOpen()"
  [existingLibraries]="libraries()"
  (closed)="closeLibraryManager()"
  (librarySelected)="onLibrarySelected($event)"
  (libraryCreated)="onLibraryCreated($event)"
  (libraryOpened)="onLibraryOpened($event)"
/>

<!-- AI Setup Wizard -->
@if (aiWizardOpen()) {
  <app-ai-setup-wizard
    (completed)="onAiWizardCompleted()"
    (closed)="onAiWizardClosed()"
  />
}

<!-- Video Preview Modal -->
<app-video-preview-modal
  [show]="previewModalOpen()"
  [previewItems]="previewItems()"
  [selectedId]="previewSelectedId()"
  (closed)="onPreviewModalClosed()"
  (selectionChanged)="onPreviewSelectionChanged($event)"
/>

<!-- New Tab Dialog -->
<app-new-tab-dialog
  [show]="newTabDialogOpen()"
  (created)="onNewTabCreated($event)"
  (closed)="onNewTabDialogClosed()"
/>

<!-- Download Dialog -->
<app-video-config-dialog
  [isOpen]="downloadDialogOpen()"
  (closeDialog)="onDownloadDialogClosed()"
  (submitConfig)="onDownloadSubmit($event)"
/>
