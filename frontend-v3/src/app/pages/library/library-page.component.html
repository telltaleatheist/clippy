<div class="library-page">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">Media Library</h1>
      <p class="page-subtitle">
        <span *ngIf="currentLibrary()">{{ currentLibrary()?.name }}</span>
        <span *ngIf="!currentLibrary()">No library selected</span>
      </p>
    </div>
    <div class="header-actions">
      <button
        class="btn btn-primary"
        (click)="openImportDialog()"
        title="Import media files from your computer">
        <span class="btn-icon">ğŸ“</span>
        <span>Import Files</span>
      </button>
      <button
        class="btn btn-primary"
        [disabled]="selectedCount() !== 1"
        (click)="openInEditor()"
        [title]="selectedCount() === 1 ? 'Open in Video Editor' : 'Select exactly one video'">
        <span class="btn-icon">ğŸ¬</span>
        <span>Video Editor</span>
      </button>
      <button
        class="btn btn-secondary"
        [disabled]="selectedCount() !== 1"
        (click)="viewMore()"
        [title]="selectedCount() === 1 ? 'View video details' : 'Select exactly one video'">
        <span class="btn-icon">â„¹ï¸</span>
        <span>View More</span>
      </button>
      <!-- Configure button for queue items -->
      <button
        class="btn btn-secondary"
        *ngIf="hasQueueItemsSelected"
        (click)="onConfigureSelected()"
        title="Configure tasks for selected items">
        <span class="btn-icon">âš™ï¸</span>
        <span>Configure</span>
      </button>
      <!-- Add to queue button for library items -->
      <button
        class="btn btn-secondary"
        *ngIf="selectedCount() > 0 && !hasQueueItemsSelected"
        (click)="onAddSelectedToQueue()">
        <span class="btn-icon">â•</span>
        <span>Add to Queue</span>
        <span class="badge">{{ selectedCount() }}</span>
      </button>
    </div>
  </div>

  <!-- Search and Filters -->
  <div class="filters-section">
    <app-library-search-filters
      (filtersChanged)="onFiltersChanged($event)"
    />
  </div>

  <!-- URL Input Bar -->
  <div class="url-input-bar">
    <span class="url-input-label">Add to Queue:</span>
    <app-url-input (urlsAdded)="onUrlsAdded($event)" />
    @if (hasPendingItems) {
      <button
        class="start-queue-btn"
        (click)="startProcessing()"
        title="Start processing all pending items">
        <span class="btn-icon">â–¶</span>
        <span>Start Processing</span>
        <span class="badge">{{ queueStats.pending }}</span>
      </button>
    }
  </div>

  <!-- Main Container with Drag & Drop -->
  <div
    class="main-container"
    [class.dragging-over]="isDraggingOver()"
    (drop)="onDrop($event)"
    (dragover)="onDragOver($event)"
    (dragleave)="onDragLeave($event)">

    <!-- Drop overlay -->
    <div class="drop-overlay" *ngIf="isDraggingOver()">
      <div class="drop-message">
        <div class="drop-icon">ğŸ“</div>
        <div class="drop-text">Drop media files to import</div>
      </div>
    </div>

    <div class="unified-content">
      <!-- Media Library Cascade (includes queue items) -->
      <app-cascade
        [weeks]="combinedWeeks()"
        [progressMapper]="queueProgressMapper"
        [childrenConfig]="processingChildrenConfig"
        (selectionChanged)="onSelectionChanged($event)"
        (videoAction)="onVideoAction($event)"
        (configureItem)="onConfigureItem($event)"
        (previewRequested)="onPreviewRequested($event)"
      />

      <!-- Empty State -->
      <div class="empty-state" *ngIf="filteredWeeks().length === 0 && processingQueue().length === 0">
        <div class="empty-icon">ğŸ“¹</div>
        <h3 class="empty-title">No media found</h3>
        <p class="empty-description">
          <span *ngIf="currentFilters?.searchQuery">
            Try adjusting your search filters
          </span>
          <span *ngIf="!currentFilters?.searchQuery">
            Paste URLs above, click Import Files, or drag and drop files here
          </span>
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Config Modal -->
<app-queue-item-config-modal
  [isOpen]="configModalOpen()"
  [itemSource]="configItemSource()"
  [bulkMode]="configBulkMode()"
  [existingTasks]="configExistingTasks()"
  [itemCount]="configItemIds().length"
  (close)="closeConfigModal()"
  (save)="onConfigSave($event)"
  (bulkSave)="onConfigSave($event)"
/>

<!-- Library Manager Modal -->
<app-library-manager-modal
  [show]="libraryManagerOpen()"
  [existingLibraries]="libraries()"
  (closed)="closeLibraryManager()"
  (librarySelected)="onLibrarySelected($event)"
  (libraryCreated)="onLibraryCreated($event)"
  (libraryRelinked)="onLibraryRelinked($event)"
/>

<!-- AI Setup Wizard -->
@if (aiWizardOpen()) {
  <app-ai-setup-wizard
    (completed)="onAiWizardCompleted()"
    (closed)="onAiWizardClosed()"
  />
}

<!-- Video Preview Modal -->
<app-video-preview-modal
  [show]="previewModalOpen()"
  [previewItems]="previewItems()"
  [selectedId]="previewSelectedId()"
  (closed)="onPreviewModalClosed()"
  (selectionChanged)="onPreviewSelectionChanged($event)"
/>
